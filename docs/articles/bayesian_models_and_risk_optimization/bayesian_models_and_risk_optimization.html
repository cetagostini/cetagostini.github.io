<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-08-20">

<title>Bayesian Models and Risk Optimization – Marketing Science Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/icon/fav.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-7dc88c0e4071ecedd75eb36a363dad2b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<style>
  .navbar-title {
    font-weight: 700;
    background: linear-gradient(90deg, #383acf 0%, #9c27b0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Bayesian Models and Risk Optimization – Marketing Science Blog">
<meta property="og:description" content="">
<meta property="og:image" content="https://cetagostini.github.io/cetagostini.github.io/articles/images/bayesian_models_and_risk_optimization.png">
<meta property="og:site_name" content="Marketing Science Blog">
<meta name="twitter:title" content="Bayesian Models and Risk Optimization – Marketing Science Blog">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://cetagostini.github.io/cetagostini.github.io/articles/images/bayesian_models_and_risk_optimization.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Marketing Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../articles.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">📘 Introduction</a></li>
  <li><a href="#import-libraries" id="toc-import-libraries" class="nav-link" data-scroll-target="#import-libraries">📦 Import libraries</a></li>
  <li><a href="#notebook-setup" id="toc-notebook-setup" class="nav-link" data-scroll-target="#notebook-setup">⚙️ Notebook setup</a></li>
  <li><a href="#data-generation-process" id="toc-data-generation-process" class="nav-link" data-scroll-target="#data-generation-process">🧪 Data generation process</a>
  <ul class="collapse">
  <li><a href="#date-range" id="toc-date-range" class="nav-link" data-scroll-target="#date-range">📆 Date range</a></li>
  <li><a href="#media-data" id="toc-media-data" class="nav-link" data-scroll-target="#media-data">📣 Media data</a></li>
  <li><a href="#trend-and-seasonality-components" id="toc-trend-and-seasonality-components" class="nav-link" data-scroll-target="#trend-and-seasonality-components">📈 Trend and seasonality components</a></li>
  <li><a href="#adstock-and-saturation-transformations" id="toc-adstock-and-saturation-transformations" class="nav-link" data-scroll-target="#adstock-and-saturation-transformations">🔁 Adstock and saturation transformations</a></li>
  </ul></li>
  <li><a href="#building-the-model" id="toc-building-the-model" class="nav-link" data-scroll-target="#building-the-model">🏗️ Building the model</a></li>
  <li><a href="#understanding-uncertainty" id="toc-understanding-uncertainty" class="nav-link" data-scroll-target="#understanding-uncertainty">🎲 Understanding uncertainty</a></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization">🧭 Optimization</a>
  <ul class="collapse">
  <li><a href="#define-the-optimizer" id="toc-define-the-optimizer" class="nav-link" data-scroll-target="#define-the-optimizer">🛠️ Define the optimizer</a></li>
  </ul></li>
  <li><a href="#risk-metrics-consistent-with-pymc-marketing" id="toc-risk-metrics-consistent-with-pymc-marketing" class="nav-link" data-scroll-target="#risk-metrics-consistent-with-pymc-marketing">⚖️ Risk metrics consistent with PyMC-Marketing</a>
  <ul class="collapse">
  <li><a href="#tail-distance" id="toc-tail-distance" class="nav-link" data-scroll-target="#tail-distance">🌪️ Tail Distance</a></li>
  <li><a href="#mean-tightness-score-mts" id="toc-mean-tightness-score-mts" class="nav-link" data-scroll-target="#mean-tightness-score-mts">🎯 Mean Tightness Score (MTS)</a></li>
  </ul></li>
  <li><a href="#takeaways-on-uncertainty" id="toc-takeaways-on-uncertainty" class="nav-link" data-scroll-target="#takeaways-on-uncertainty">✅ Takeaways on uncertainty</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">🚧 Limitations</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/cetagostini/cetagostini.github.io/edit/main/articles/bayesian_models_and_risk_optimization/bayesian_models_and_risk_optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cetagostini/cetagostini.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add the navbar-title class to the navbar brand
    const navbarBrand = document.querySelector('.navbar-brand');
    if (navbarBrand) {
      navbarBrand.classList.add('navbar-title');
    }
  });
</script> 

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Bayesian Models and Risk Optimization</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">MMM</div>
    <div class="quarto-category">python</div>
    <div class="quarto-category">optimization</div>
    <div class="quarto-category">media mix modeling</div>
    <div class="quarto-category">bayesian</div>
    <div class="quarto-category">pymc</div>
    <div class="quarto-category">pydata</div>
    <div class="quarto-category">germany</div>
    <div class="quarto-category">berlin</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 20, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>📘 Introduction</h1>
<p>This article explores how Bayesian Media Mix Modeling (MMM) represents uncertainty and how we can optimize budget decisions under risk. We build a generative view of media response (carryover via adstock, diminishing returns via saturation, trend and seasonality) and use full posterior predictive distributions to compare allocations not only by expected outcomes but also by dispersion and tail risk.</p>
<p>This material accompanies my PyData Berlin 2025 talk, where I discuss practical risk-aware optimization for MMM: moving beyond mean-only plans to objectives that explicitly incorporate uncertainty—and how to communicate these trade-offs to stakeholders.</p>
</section>
<section id="import-libraries" class="level1">
<h1>📦 Import libraries</h1>
<div id="cdcd950e" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.builders.yaml <span class="im">import</span> build_mmm_from_yaml</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> GeometricAdstock, MichaelisMentenSaturation</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.budget_optimizer <span class="im">import</span> optimizer_xarray_builder</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.multidimensional <span class="im">import</span> (</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    MultiDimensionalBudgetOptimizerWrapper,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.prior <span class="im">import</span> Prior</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> utility <span class="im">as</span> ut</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> ndimage</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="notebook-setup" class="level1">
<h1>⚙️ Notebook setup</h1>
<div id="fb1e273b" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-darkgrid"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.dpi"</span>] <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"xtick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"ytick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({<span class="st">"figure.constrained_layout.use"</span>: <span class="va">True</span>})</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>seed: <span class="bu">int</span> <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">map</span>(<span class="bu">ord</span>, <span class="st">"pydata_berlin_2025"</span>))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>rng: np.random.Generator <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>seed)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>default_figsize <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">4</span>) <span class="co"># repeat to use later</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-generation-process" class="level1">
<h1>🧪 Data generation process</h1>
<p>This section encodes a generative story for media response with clear uncertainty sources. We simulate outcomes as <span class="math display">\[
y_t = \beta_0 + \sum_{c} f(x_{c,t}; \theta_c) + \text{trend}_t + \text{seasonality}_t + \varepsilon_t
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(y_t\)</span> is the observed outcome (e.g., app installs or revenue) at time <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(\beta_0\)</span> is the baseline intercept</li>
<li><span class="math inline">\(f(x_{c,t}; \theta_c)\)</span> is the media response function for channel <span class="math inline">\(c\)</span> with spend <span class="math inline">\(x_{c,t}\)</span> and parameters <span class="math inline">\(\theta_c\)</span>.</li>
<li><span class="math inline">\(\text{trend}_t\)</span> captures long-term growth or decline patterns</li>
<li><span class="math inline">\(\text{seasonality}_t\)</span> models periodic effects (weekly, monthly patterns)</li>
<li><span class="math inline">\(\varepsilon_t\)</span> represents aleatoric uncertainty—irreducible noise from unobserved factors, measurement error, and inherent randomness that remains even with perfect knowledge of all parameters</li>
</ul>
<p>We do not consider interactions; the causal DAG looks like this:</p>
<div id="c507d041" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> graphviz.Digraph()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Media Spend"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Trend"</span>, style<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Seasonality"</span>, style<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Target"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Media Spend"</span>, <span class="st">"Target"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Trend"</span>, <span class="st">"Target"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Seasonality"</span>, <span class="st">"Target"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-4-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="date-range" class="level2">
<h2 class="anchored" data-anchor-id="date-range">📆 Date range</h2>
<p>We start by defining the date range.</p>
<div id="8b322380" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># date range</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>min_date <span class="op">=</span> pd.to_datetime(<span class="st">"2024-09-01"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>max_date <span class="op">=</span> pd.to_datetime(<span class="st">"2025-09-01"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"date_week"</span>: pd.date_range(start<span class="op">=</span>min_date, end<span class="op">=</span>max_date, freq<span class="op">=</span><span class="st">"W-MON"</span>)}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> df.shape[<span class="dv">0</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of observations: </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of observations: 53</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_week</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-09-02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-09-09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-09-16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-09-23</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-09-30</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="media-data" class="level2">
<h2 class="anchored" data-anchor-id="media-data">📣 Media data</h2>
<div id="e956c6c2" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># media data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>scaler_x1 <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>scaler_x2 <span class="op">=</span> <span class="dv">280</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>scaler_x3 <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>scaler_x4 <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>y_scaler <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># media data</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">1.0</span>, size<span class="op">=</span>n)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1"</span>] <span class="op">=</span> np.where(x1 <span class="op">&gt;</span> <span class="fl">0.8</span>, x1, x1 <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.6</span>, size<span class="op">=</span>n)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2"</span>] <span class="op">=</span> np.where(x2 <span class="op">&gt;</span> <span class="fl">0.5</span>, x2, <span class="dv">0</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>x3 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span>n)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3"</span>] <span class="op">=</span> np.where(x3 <span class="op">&gt;</span> <span class="fl">0.7</span>, x3, x3 <span class="op">/</span> <span class="dv">6</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>x4 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.2</span>, size<span class="op">=</span>n)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4"</span>] <span class="op">=</span> np.where(x4 <span class="op">&gt;</span> <span class="fl">0.15</span>, x4, x4 <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">4</span>, ncols<span class="op">=</span><span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>, layout<span class="op">=</span><span class="st">"constrained"</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">3</span>])</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">3</span>].<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Media Costs Data"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-6-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="trend-and-seasonality-components" class="level2">
<h2 class="anchored" data-anchor-id="trend-and-seasonality-components">📈 Trend and seasonality components</h2>
<p>We define trend and seasonality. Seasonality follows a 4-week cycle modeled with a Fourier basis; trend is linear.</p>
<div id="aab910f6" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Fourier components for monthly seasonality</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>monthly_period <span class="op">=</span> <span class="dv">4</span>  <span class="co"># 4-week cycle</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.arange(n)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sin-cos signals for fourier components</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>monthly_sin <span class="op">=</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> monthly_period)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>monthly_cos <span class="op">=</span> np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> monthly_period)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine sin-cos to create the desired pattern</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use coefficients to shape the pattern</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> monthly_sin <span class="op">+</span> <span class="fl">0.4</span> <span class="op">*</span> monthly_cos</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply smoothing using ndimage to reduce sharp transitions</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> ndimage.gaussian_filter1d(monthly_pattern, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize to [-1, 1] range</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> (monthly_pattern <span class="op">/</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(monthly_pattern))) <span class="op">*</span> <span class="fl">.18</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"monthly_effect"</span>] <span class="op">=</span> monthly_pattern</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"trend"</span>] <span class="op">=</span> (np.linspace(start<span class="op">=</span><span class="fl">0.0</span>, stop<span class="op">=</span><span class="dv">10</span>, num<span class="op">=</span>n) <span class="op">+</span> <span class="dv">10</span>) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> <span class="dv">8</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot monthly pattern</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>ax1.plot(df[<span class="st">"date_week"</span>], monthly_pattern, label<span class="op">=</span><span class="st">"Monthly Pattern (Smoothed)"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"Pattern Value"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"Monthly Fourier Pattern (4-week cycle, Smoothed)"</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>ax2.plot(df[<span class="st">"date_week"</span>], df[<span class="st">"trend"</span>], label<span class="op">=</span><span class="st">"Trend"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"Trend Value"</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"Linear Trend Component"</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-7-output-1.png" width="788" height="386" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adstock-and-saturation-transformations" class="level2">
<h2 class="anchored" data-anchor-id="adstock-and-saturation-transformations">🔁 Adstock and saturation transformations</h2>
<p>First, we apply the adstock transformation to the media data.</p>
<div id="1bb99dd6" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply geometric adstock transformation</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>alpha: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.55</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x1"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x2"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x3"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x4"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_week</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">x3</th>
<th data-quarto-table-cell-role="th">x4</th>
<th data-quarto-table-cell-role="th">monthly_effect</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">x1_adstock</th>
<th data-quarto-table-cell-role="th">x2_adstock</th>
<th data-quarto-table-cell-role="th">x3_adstock</th>
<th data-quarto-table-cell-role="th">x4_adstock</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-09-02</td>
<td>0.342627</td>
<td>0.581017</td>
<td>0.009625</td>
<td>0.072294</td>
<td>0.120001</td>
<td>0.333521</td>
<td>0.155484</td>
<td>0.263665</td>
<td>0.004368</td>
<td>0.032807</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-09-09</td>
<td>0.349177</td>
<td>0.000000</td>
<td>0.018831</td>
<td>0.007122</td>
<td>0.180000</td>
<td>0.336700</td>
<td>0.243973</td>
<td>0.145016</td>
<td>0.010948</td>
<td>0.021276</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-09-16</td>
<td>0.292217</td>
<td>0.000000</td>
<td>0.029268</td>
<td>0.011185</td>
<td>-0.120000</td>
<td>0.339827</td>
<td>0.266793</td>
<td>0.079759</td>
<td>0.019303</td>
<td>0.016778</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-09-23</td>
<td>0.893449</td>
<td>0.000000</td>
<td>0.073220</td>
<td>0.056761</td>
<td>-0.180000</td>
<td>0.342904</td>
<td>0.552183</td>
<td>0.043867</td>
<td>0.043844</td>
<td>0.034986</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-09-30</td>
<td>0.197823</td>
<td>0.000000</td>
<td>0.073854</td>
<td>0.175182</td>
<td>0.120000</td>
<td>0.345932</td>
<td>0.393473</td>
<td>0.024127</td>
<td>0.057629</td>
<td>0.098740</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Then we apply the saturation transformation to the adstock transformed media data.</p>
<div id="3287fa96" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>alpha_sat_x1: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lam_sat_x1: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>alpha_sat_x2: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>lam_sat_x2: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>alpha_sat_x3: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>lam_sat_x3: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>alpha_sat_x4: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>lam_sat_x4: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x1_adstock"</span>].to_numpy(),</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x1,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x1,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x2_adstock"</span>].to_numpy(),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x2,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x2,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x3_adstock"</span>].to_numpy(),  </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x3,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x3,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x4_adstock"</span>].to_numpy(),</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x4,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x4,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_week</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">x3</th>
<th data-quarto-table-cell-role="th">x4</th>
<th data-quarto-table-cell-role="th">monthly_effect</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">x1_adstock</th>
<th data-quarto-table-cell-role="th">x2_adstock</th>
<th data-quarto-table-cell-role="th">x3_adstock</th>
<th data-quarto-table-cell-role="th">x4_adstock</th>
<th data-quarto-table-cell-role="th">x1_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x2_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x3_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x4_adstock_saturated</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-09-02</td>
<td>0.342627</td>
<td>0.581017</td>
<td>0.009625</td>
<td>0.072294</td>
<td>0.120001</td>
<td>0.333521</td>
<td>0.155484</td>
<td>0.263665</td>
<td>0.004368</td>
<td>0.032807</td>
<td>0.037153</td>
<td>0.014950</td>
<td>0.002870</td>
<td>0.031515</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-09-09</td>
<td>0.349177</td>
<td>0.000000</td>
<td>0.018831</td>
<td>0.007122</td>
<td>0.180000</td>
<td>0.336700</td>
<td>0.243973</td>
<td>0.145016</td>
<td>0.010948</td>
<td>0.021276</td>
<td>0.054459</td>
<td>0.008815</td>
<td>0.007042</td>
<td>0.020725</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-09-16</td>
<td>0.292217</td>
<td>0.000000</td>
<td>0.029268</td>
<td>0.011185</td>
<td>-0.120000</td>
<td>0.339827</td>
<td>0.266793</td>
<td>0.079759</td>
<td>0.019303</td>
<td>0.016778</td>
<td>0.058559</td>
<td>0.005049</td>
<td>0.012091</td>
<td>0.016433</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-09-23</td>
<td>0.893449</td>
<td>0.000000</td>
<td>0.073220</td>
<td>0.056761</td>
<td>-0.180000</td>
<td>0.342904</td>
<td>0.552183</td>
<td>0.043867</td>
<td>0.043844</td>
<td>0.034986</td>
<td>0.100264</td>
<td>0.002841</td>
<td>0.025502</td>
<td>0.033520</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-09-30</td>
<td>0.197823</td>
<td>0.000000</td>
<td>0.073854</td>
<td>0.175182</td>
<td>0.120000</td>
<td>0.345932</td>
<td>0.393473</td>
<td>0.024127</td>
<td>0.057629</td>
<td>0.098740</td>
<td>0.079038</td>
<td>0.001583</td>
<td>0.032228</td>
<td>0.087892</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s visualize how the media data look after adstock and saturation, and how they translate into units of Y (app installs or revenue).</p>
<div id="0a9c3247" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">3</span>, ncols<span class="op">=</span><span class="dv">4</span>, sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">False</span>, layout<span class="op">=</span><span class="st">"constrained"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">2</span>])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">3</span>])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Media Costs Data - Transformed"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-10-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We now add the intercept and noise, and sum the transformed media, trend, and seasonality components.</p>
<div id="e929554b" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"intercept"</span>] <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"epsilon"</span>] <span class="op">=</span> rng.normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">0.075</span>, size<span class="op">=</span>n)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"app_installs"</span>] <span class="op">=</span> df[[<span class="st">"intercept"</span>, <span class="st">"x1_adstock_saturated"</span>, <span class="st">"x2_adstock_saturated"</span>, <span class="st">"x3_adstock_saturated"</span>, <span class="st">"x4_adstock_saturated"</span>, <span class="st">"trend"</span>, <span class="st">"monthly_effect"</span>, <span class="st">"epsilon"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"app_installs"</span>] <span class="op">*=</span> y_scaler</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_week</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">x3</th>
<th data-quarto-table-cell-role="th">x4</th>
<th data-quarto-table-cell-role="th">monthly_effect</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">x1_adstock</th>
<th data-quarto-table-cell-role="th">x2_adstock</th>
<th data-quarto-table-cell-role="th">x3_adstock</th>
<th data-quarto-table-cell-role="th">x4_adstock</th>
<th data-quarto-table-cell-role="th">x1_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x2_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x3_adstock_saturated</th>
<th data-quarto-table-cell-role="th">x4_adstock_saturated</th>
<th data-quarto-table-cell-role="th">intercept</th>
<th data-quarto-table-cell-role="th">epsilon</th>
<th data-quarto-table-cell-role="th">app_installs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-09-02</td>
<td>0.342627</td>
<td>0.581017</td>
<td>0.009625</td>
<td>0.072294</td>
<td>0.120001</td>
<td>0.333521</td>
<td>0.155484</td>
<td>0.263665</td>
<td>0.004368</td>
<td>0.032807</td>
<td>0.037153</td>
<td>0.014950</td>
<td>0.002870</td>
<td>0.031515</td>
<td>0.15</td>
<td>0.154459</td>
<td>844.469551</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-09-09</td>
<td>0.349177</td>
<td>0.000000</td>
<td>0.018831</td>
<td>0.007122</td>
<td>0.180000</td>
<td>0.336700</td>
<td>0.243973</td>
<td>0.145016</td>
<td>0.010948</td>
<td>0.021276</td>
<td>0.054459</td>
<td>0.008815</td>
<td>0.007042</td>
<td>0.020725</td>
<td>0.15</td>
<td>0.177488</td>
<td>935.229200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-09-16</td>
<td>0.292217</td>
<td>0.000000</td>
<td>0.029268</td>
<td>0.011185</td>
<td>-0.120000</td>
<td>0.339827</td>
<td>0.266793</td>
<td>0.079759</td>
<td>0.019303</td>
<td>0.016778</td>
<td>0.058559</td>
<td>0.005049</td>
<td>0.012091</td>
<td>0.016433</td>
<td>0.15</td>
<td>0.052790</td>
<td>514.748757</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-09-23</td>
<td>0.893449</td>
<td>0.000000</td>
<td>0.073220</td>
<td>0.056761</td>
<td>-0.180000</td>
<td>0.342904</td>
<td>0.552183</td>
<td>0.043867</td>
<td>0.043844</td>
<td>0.034986</td>
<td>0.100264</td>
<td>0.002841</td>
<td>0.025502</td>
<td>0.033520</td>
<td>0.15</td>
<td>-0.034546</td>
<td>440.486094</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-09-30</td>
<td>0.197823</td>
<td>0.000000</td>
<td>0.073854</td>
<td>0.175182</td>
<td>0.120000</td>
<td>0.345932</td>
<td>0.393473</td>
<td>0.024127</td>
<td>0.057629</td>
<td>0.098740</td>
<td>0.079038</td>
<td>0.001583</td>
<td>0.032228</td>
<td>0.087892</td>
<td>0.15</td>
<td>0.090876</td>
<td>907.549889</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This is how the target looks.</p>
<div id="206dfbea" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">"date_week"</span>).app_installs.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-12-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We also add the original media to the DataFrame so we can visualize it before any transformations and use it as model input.</p>
<div id="2fa5d631" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]] <span class="op">=</span> df[[<span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>, <span class="st">"x4"</span>]]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_original_scale"</span>] <span class="op">*=</span> scaler_x1</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_original_scale"</span>] <span class="op">*=</span> scaler_x2</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_original_scale"</span>] <span class="op">*=</span> scaler_x3</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_original_scale"</span>] <span class="op">*=</span> scaler_x4</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"app_installs"</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_week</th>
<th data-quarto-table-cell-role="th">x1_original_scale</th>
<th data-quarto-table-cell-role="th">x2_original_scale</th>
<th data-quarto-table-cell-role="th">x3_original_scale</th>
<th data-quarto-table-cell-role="th">app_installs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-09-02</td>
<td>102.788211</td>
<td>162.684671</td>
<td>0.481258</td>
<td>844.469551</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-09-09</td>
<td>104.753127</td>
<td>0.000000</td>
<td>0.941552</td>
<td>935.229200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-09-16</td>
<td>87.665114</td>
<td>0.000000</td>
<td>1.463382</td>
<td>514.748757</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-09-23</td>
<td>268.034637</td>
<td>0.000000</td>
<td>3.661005</td>
<td>440.486094</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-09-30</td>
<td>59.346861</td>
<td>0.000000</td>
<td>3.692695</td>
<td>907.549889</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="building-the-model" class="level1">
<h1>🏗️ Building the model</h1>
<p>The YAML configuration encodes a fully Bayesian MMM with priors over the core response mechanics and temporal structure. For model specifics and worked examples, see the PyMC‑Marketing <a href="https://www.pymc-marketing.io/en/stable/gallery/gallery.html">Example Gallery</a> and <a href="https://www.pymc-marketing.io/en/stable/api/index.html">API</a>.</p>
<p>Here we split the data into train and test sets. Not to evaluate the fit; instead, we use the test set to compare the results of the optimization, checking if it will be “better” than the budget recommendations.</p>
<div id="b1389c7f" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> df.query(<span class="st">"date_week &lt;= '2025-08-30'"</span>).copy()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> df_train[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train[<span class="st">"app_installs"</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df.query(<span class="st">"date_week &gt; '2025-08-30'"</span>).copy()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> df_test[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test[<span class="st">"app_installs"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Because the model was defined previously in the YAML, building it is straightforward and takes only a few lines.</p>
<div id="fc3b80bd" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mmm <span class="op">=</span> build_mmm_from_yaml(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>y_train,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    config_path<span class="op">=</span><span class="st">"pymc_model.yml"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we fit the model and check convergence.</p>
<div id="9bb4f92e" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mmm.fit(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>y_train,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>mmm.sample_posterior_predictive(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="5200" value="5200">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="1300" value="1300">
                        </progress>
                    </td>
                    <td>1300</td>
                    <td>0</td>
                    <td>0.11</td>
                    <td>31</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="1300" value="1300">
                        </progress>
                    </td>
                    <td>1300</td>
                    <td>0</td>
                    <td>0.10</td>
                    <td>63</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="1300" value="1300">
                        </progress>
                    </td>
                    <td>1300</td>
                    <td>0</td>
                    <td>0.11</td>
                    <td>31</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="1300" value="1300">
                        </progress>
                    </td>
                    <td>1300</td>
                    <td>0</td>
                    <td>0.11</td>
                    <td>31</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"95db31e60f3c4ddaa7d205266e7bafae","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"457e395f09eb4e0f85fefd5347f341ab","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewbox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewbox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme="dark"],
html[data-theme="dark"],
body[data-theme="dark"],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1f1f1f;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
  height: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: "►";
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: "▼";
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: "(";
}

.xr-dim-list:after {
  content: ")";
}

.xr-dim-list li:not(:last-child):after {
  content: ",";
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class="xr-text-repr-fallback">&lt;xarray.Dataset&gt; Size: 2MB
Dimensions:           (date: 52, sample: 2000)
Coordinates:
  * date              (date) datetime64[ns] 416B 2024-09-02 ... 2025-08-25
  * sample            (sample) object 16kB MultiIndex
  * chain             (sample) int64 16kB 0 0 0 0 0 0 0 0 0 ... 3 3 3 3 3 3 3 3
  * draw              (sample) int64 16kB 0 1 2 3 4 5 ... 495 496 497 498 499
Data variables:
    y                 (date, sample) float64 832kB 1.1 1.482 ... 1.375 0.03829
    y_original_scale  (date, sample) float64 832kB 1.095e+03 1.475e+03 ... 38.1
Attributes:
    created_at:                 2025-09-02T15:03:19.440956+00:00
    arviz_version:              0.21.0
    inference_library:          pymc
    inference_library_version:  5.25.1</pre><div class="xr-wrap" style="display:none"><div class="xr-header"><div class="xr-obj-type">xarray.Dataset</div></div><ul class="xr-sections"><li class="xr-section-item"><input id="section-3894b28c-fac1-4a3f-b319-a9341990ece8" class="xr-section-summary-in" type="checkbox" disabled=""><label for="section-3894b28c-fac1-4a3f-b319-a9341990ece8" class="xr-section-summary" title="Expand/collapse section">Dimensions:</label><div class="xr-section-inline-details"><ul class="xr-dim-list"><li><span class="xr-has-index">date</span>: 52</li><li><span class="xr-has-index">sample</span>: 2000</li></ul></div><div class="xr-section-details"></div></li><li class="xr-section-item"><input id="section-9c58255a-b944-4ae8-9187-1aa11bc5f46f" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-9c58255a-b944-4ae8-9187-1aa11bc5f46f" class="xr-section-summary">Coordinates: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">date</span></div><div class="xr-var-dims">(date)</div><div class="xr-var-dtype">datetime64[ns]</div><div class="xr-var-preview xr-preview">2024-09-02 ... 2025-08-25</div><input id="attrs-b47ab137-952e-4c77-bd6f-f98e62ae9c0f" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-b47ab137-952e-4c77-bd6f-f98e62ae9c0f" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-a6e58189-122b-45c9-8229-f12fafda8656" class="xr-var-data-in" type="checkbox"><label for="data-a6e58189-122b-45c9-8229-f12fafda8656" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array(['2024-09-02T00:00:00.000000000', '2024-09-09T00:00:00.000000000',
       '2024-09-16T00:00:00.000000000', '2024-09-23T00:00:00.000000000',
       '2024-09-30T00:00:00.000000000', '2024-10-07T00:00:00.000000000',
       '2024-10-14T00:00:00.000000000', '2024-10-21T00:00:00.000000000',
       '2024-10-28T00:00:00.000000000', '2024-11-04T00:00:00.000000000',
       '2024-11-11T00:00:00.000000000', '2024-11-18T00:00:00.000000000',
       '2024-11-25T00:00:00.000000000', '2024-12-02T00:00:00.000000000',
       '2024-12-09T00:00:00.000000000', '2024-12-16T00:00:00.000000000',
       '2024-12-23T00:00:00.000000000', '2024-12-30T00:00:00.000000000',
       '2025-01-06T00:00:00.000000000', '2025-01-13T00:00:00.000000000',
       '2025-01-20T00:00:00.000000000', '2025-01-27T00:00:00.000000000',
       '2025-02-03T00:00:00.000000000', '2025-02-10T00:00:00.000000000',
       '2025-02-17T00:00:00.000000000', '2025-02-24T00:00:00.000000000',
       '2025-03-03T00:00:00.000000000', '2025-03-10T00:00:00.000000000',
       '2025-03-17T00:00:00.000000000', '2025-03-24T00:00:00.000000000',
       '2025-03-31T00:00:00.000000000', '2025-04-07T00:00:00.000000000',
       '2025-04-14T00:00:00.000000000', '2025-04-21T00:00:00.000000000',
       '2025-04-28T00:00:00.000000000', '2025-05-05T00:00:00.000000000',
       '2025-05-12T00:00:00.000000000', '2025-05-19T00:00:00.000000000',
       '2025-05-26T00:00:00.000000000', '2025-06-02T00:00:00.000000000',
       '2025-06-09T00:00:00.000000000', '2025-06-16T00:00:00.000000000',
       '2025-06-23T00:00:00.000000000', '2025-06-30T00:00:00.000000000',
       '2025-07-07T00:00:00.000000000', '2025-07-14T00:00:00.000000000',
       '2025-07-21T00:00:00.000000000', '2025-07-28T00:00:00.000000000',
       '2025-08-04T00:00:00.000000000', '2025-08-11T00:00:00.000000000',
       '2025-08-18T00:00:00.000000000', '2025-08-25T00:00:00.000000000'],
      dtype='datetime64[ns]')</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">sample</span></div><div class="xr-var-dims">(sample)</div><div class="xr-var-dtype">object</div><div class="xr-var-preview xr-preview">MultiIndex</div><input id="attrs-a2eac8e5-c8ab-459c-9679-ba8b15adf8d1" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-a2eac8e5-c8ab-459c-9679-ba8b15adf8d1" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-4f9e47b7-11ad-4d7b-ab97-86175257583c" class="xr-var-data-in" type="checkbox"><label for="data-4f9e47b7-11ad-4d7b-ab97-86175257583c" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([(0, 0), (0, 1), (0, 2), ..., (3, 497), (3, 498), (3, 499)], dtype=object)</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">chain</span></div><div class="xr-var-dims">(sample)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0 0 0 0 0 0 0 0 ... 3 3 3 3 3 3 3 3</div><input id="attrs-7a4920d0-7653-4ab3-ac5e-0df15201f9d4" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-7a4920d0-7653-4ab3-ac5e-0df15201f9d4" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-58369d9a-595b-40e1-b5dc-4ede0dc7d7dc" class="xr-var-data-in" type="checkbox"><label for="data-58369d9a-595b-40e1-b5dc-4ede0dc7d7dc" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([0, 0, 0, ..., 3, 3, 3])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span class="xr-has-index">draw</span></div><div class="xr-var-dims">(sample)</div><div class="xr-var-dtype">int64</div><div class="xr-var-preview xr-preview">0 1 2 3 4 5 ... 495 496 497 498 499</div><input id="attrs-e8a96d30-f2d5-4b8b-9dae-231827cbdb56" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-e8a96d30-f2d5-4b8b-9dae-231827cbdb56" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-a0a3814d-5b27-49cc-98aa-a674b0d59f4b" class="xr-var-data-in" type="checkbox"><label for="data-a0a3814d-5b27-49cc-98aa-a674b0d59f4b" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([  0,   1,   2, ..., 497, 498, 499])</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-88257e77-a562-4973-8d00-92a839e62c14" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-88257e77-a562-4973-8d00-92a839e62c14" class="xr-section-summary">Data variables: <span>(2)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-var-name"><span>y</span></div><div class="xr-var-dims">(date, sample)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">1.1 1.482 2.196 ... 1.375 0.03829</div><input id="attrs-aaf62027-ed72-4b97-88f0-d4d2f8327c87" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-aaf62027-ed72-4b97-88f0-d4d2f8327c87" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-1104c880-bf6b-4213-bdb5-febb2252d3bb" class="xr-var-data-in" type="checkbox"><label for="data-1104c880-bf6b-4213-bdb5-febb2252d3bb" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([[1.10046376, 1.48223506, 2.1955386 , ..., 0.54750498, 2.51726368,
        2.28408282],
       [0.16650521, 3.43133933, 0.26637452, ..., 1.42749722, 0.27062395,
        0.57967649],
       [0.56776237, 1.27514195, 0.48324084, ..., 0.92168378, 0.92254179,
        3.28625954],
       ...,
       [0.18217287, 0.7784404 , 0.99589786, ..., 0.3352403 , 1.08227801,
        3.23752939],
       [0.46625045, 0.84496526, 0.56362764, ..., 1.80404267, 0.16434128,
        0.64053605],
       [0.33083515, 0.41383744, 0.08532088, ..., 0.07563847, 1.3749999 ,
        0.03828513]])</pre></div></li><li class="xr-var-item"><div class="xr-var-name"><span>y_original_scale</span></div><div class="xr-var-dims">(date, sample)</div><div class="xr-var-dtype">float64</div><div class="xr-var-preview xr-preview">1.095e+03 1.475e+03 ... 38.1</div><input id="attrs-aa3df4b5-093e-43e9-ba03-e5d502bbb1f3" class="xr-var-attrs-in" type="checkbox" disabled=""><label for="attrs-aa3df4b5-093e-43e9-ba03-e5d502bbb1f3" title="Show/Hide attributes"><svg class="icon xr-icon-file-text2"><use href="#icon-file-text2"></use></svg></label><input id="data-820a2b80-efc0-41d6-a226-97bac2737650" class="xr-var-data-in" type="checkbox"><label for="data-820a2b80-efc0-41d6-a226-97bac2737650" title="Show/Hide data repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-var-attrs"><dl class="xr-attrs"></dl></div><div class="xr-var-data"><pre>array([[1095.19409128, 1475.13724952, 2185.02506694, ...,  544.88320768,
        2505.20954088, 2273.14528242],
       [ 165.70788563, 3414.90806101,  265.09895954, ..., 1420.66152142,
         269.32804098,  576.90065413],
       [ 565.04359032, 1269.03581642,  480.92680241, ...,  917.27021906,
         918.12411735, 3270.52299438],
       ...,
       [ 181.30051596,  774.71277048,  991.12891293, ...,  333.63497257,
        1077.09542741, 3222.02619248],
       [ 464.01776871,  840.919069  ,  560.92865733, ..., 1795.40385374,
         163.55431512,  637.468789  ],
       [ 329.2509134 ,  411.85574076,   84.91231072, ...,   75.27626502,
        1368.41559187,   38.10180035]])</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-120c0812-a0a1-49a2-b5ff-f30ab93385a9" class="xr-section-summary-in" type="checkbox"><label for="section-120c0812-a0a1-49a2-b5ff-f30ab93385a9" class="xr-section-summary">Indexes: <span>(2)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><ul class="xr-var-list"><li class="xr-var-item"><div class="xr-index-name"><div>date</div></div><div class="xr-index-preview">PandasIndex</div><input type="checkbox" disabled=""><label></label><input id="index-51d20ff3-62ed-4b86-9044-eafe389951bf" class="xr-index-data-in" type="checkbox"><label for="index-51d20ff3-62ed-4b86-9044-eafe389951bf" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(DatetimeIndex(['2024-09-02', '2024-09-09', '2024-09-16', '2024-09-23',
               '2024-09-30', '2024-10-07', '2024-10-14', '2024-10-21',
               '2024-10-28', '2024-11-04', '2024-11-11', '2024-11-18',
               '2024-11-25', '2024-12-02', '2024-12-09', '2024-12-16',
               '2024-12-23', '2024-12-30', '2025-01-06', '2025-01-13',
               '2025-01-20', '2025-01-27', '2025-02-03', '2025-02-10',
               '2025-02-17', '2025-02-24', '2025-03-03', '2025-03-10',
               '2025-03-17', '2025-03-24', '2025-03-31', '2025-04-07',
               '2025-04-14', '2025-04-21', '2025-04-28', '2025-05-05',
               '2025-05-12', '2025-05-19', '2025-05-26', '2025-06-02',
               '2025-06-09', '2025-06-16', '2025-06-23', '2025-06-30',
               '2025-07-07', '2025-07-14', '2025-07-21', '2025-07-28',
               '2025-08-04', '2025-08-11', '2025-08-18', '2025-08-25'],
              dtype='datetime64[ns]', name='date', freq=None))</pre></div></li><li class="xr-var-item"><div class="xr-index-name"><div>sample<br>chain<br>draw</div></div><div class="xr-index-preview">PandasMultiIndex</div><input type="checkbox" disabled=""><label></label><input id="index-63b6e9bc-ae9f-4f78-86e4-cb28fe94901a" class="xr-index-data-in" type="checkbox"><label for="index-63b6e9bc-ae9f-4f78-86e4-cb28fe94901a" title="Show/Hide index repr"><svg class="icon xr-icon-database"><use href="#icon-database"></use></svg></label><div class="xr-index-data"><pre>PandasIndex(MultiIndex([(0,   0),
            (0,   1),
            (0,   2),
            (0,   3),
            (0,   4),
            (0,   5),
            (0,   6),
            (0,   7),
            (0,   8),
            (0,   9),
            ...
            (3, 490),
            (3, 491),
            (3, 492),
            (3, 493),
            (3, 494),
            (3, 495),
            (3, 496),
            (3, 497),
            (3, 498),
            (3, 499)],
           name='sample', length=2000))</pre></div></li></ul></div></li><li class="xr-section-item"><input id="section-7f0a9e8a-4846-4f96-94bb-ee75ef12f929" class="xr-section-summary-in" type="checkbox" checked=""><label for="section-7f0a9e8a-4846-4f96-94bb-ee75ef12f929" class="xr-section-summary">Attributes: <span>(4)</span></label><div class="xr-section-inline-details"></div><div class="xr-section-details"><dl class="xr-attrs"><dt><span>created_at :</span></dt><dd>2025-09-02T15:03:19.440956+00:00</dd><dt><span>arviz_version :</span></dt><dd>0.21.0</dd><dt><span>inference_library :</span></dt><dd>pymc</dd><dt><span>inference_library_version :</span></dt><dd>5.25.1</dd></dl></div></li></ul></div></div>
</div>
</div>
<p>Great, no divergences 🔥</p>
<div id="40384e22" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mmm.idata.sample_stats.diverging.<span class="bu">sum</span>().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>0</code></pre>
</div>
</div>
<p>Now we inspect the parameters relevant for optimization.</p>
<div id="f813e566" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>media_vars <span class="op">=</span> [</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adstock_alpha"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> az.plot_trace(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>mmm.fit_result,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>media_vars,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    compact<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    backend_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"layout"</span>: <span class="st">"constrained"</span>},</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>plt.gcf().suptitle(<span class="st">"Model Trace"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>, y<span class="op">=</span><span class="fl">1.03</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-18-output-1.png" width="811" height="427" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As expected, some parameters are well identified while others remain uncertain.</p>
<p>Sampling saturation curves from the posterior helps us visualize parameter uncertainty as bands around each channel’s response. Wide bands indicate poorly identified marginal returns; allocating in those regions increases outcome variance because small parameter shifts cause large changes in response.</p>
<div id="ab6125b7" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">3</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes.ravel():</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b991fd7728f54b898374b6c79b32da9c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-19-output-3.png" width="795" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The picture is clear: channels like X1 and X3 exhibit more variation across spend levels, allowing the model to learn their parameters more precisely. Channels like X2 and X4 have relatively constant spending with less variation, so their parameters are estimated with greater uncertainty.</p>
</section>
<section id="understanding-uncertainty" class="level1">
<h1>🎲 Understanding uncertainty</h1>
<p>In a Bayesian MMM we explicitly model two forms of uncertainty that compound in forecasts and in budget decisions:</p>
<ul>
<li><p>Aleatoric uncertainty: randomness in outcomes conditional on fixed parameters. In the simulation, this is <code>epsilon</code>. Formally, if parameters are <span class="math inline">\(\theta\)</span>, aleatoric uncertainty is the spread of <span class="math inline">\(p(y\mid x,\theta)\)</span> once we model the likelihood as <span class="math inline">\(\mathcal{N}(0, \sigma^2)\)</span>. In our model, the parameter <span class="math inline">\(\sigma\)</span> explicitly captures aleatoric uncertainty: it quantifies the amount of outcome variability that remains even if all structural parameters <span class="math inline">\(\theta\)</span> were known exactly. It represents inherent unpredictability due to unobserved micro-variation, demand shocks, or logging noise. Even with infinite data, aleatoric uncertainty remains.</p></li>
<li><p>Epistemic uncertainty: uncertainty about the parameters and latent functions themselves due to limited or weakly informative data. This is the spread of the posterior <span class="math inline">\(p(\theta\mid \text{data})\)</span>. It shrinks with more data, better priors, or richer experimental variation. In our model it includes carryover memory (adstock <span class="math inline">\(\alpha\)</span>), saturation curvature and half-saturation (Michaelis–Menten <span class="math inline">\(\alpha,\lambda\)</span>), trend slopes, and seasonal Fourier weights.</p></li>
</ul>
<p>Why this separation matters for planning:</p>
<ol type="1">
<li><p>Outcome distribution under a plan. For a given allocation plan <span class="math inline">\(b\)</span> over channels and time, the posterior predictive is <span class="math display">\[
p\big(Y(b)\mid \text{data}\big) = \int p\big(Y(b)\mid \theta\big)\, p(\theta\mid \text{data})\, d\theta,
\]</span> which mixes aleatoric variability (the inner term) and epistemic variability (integration over <span class="math inline">\(\theta\)</span>). Our Monte Carlo estimator samples <span class="math inline">\(\theta^{(s)}\)</span> from the posterior, simulates carryover and saturation under <span class="math inline">\(b\)</span>, and draws predictive outcomes.</p></li>
<li><p>Example: known vs unknown curvature. Suppose a channel’s saturation is well learned around historical spends but not beyond. Two plans with the same total spend differ in risk:</p>
<ul>
<li>Plan A concentrates around the historical mode (epistemic low), yielding a narrow predictive distribution.</li>
<li>Plan B pushes beyond observed spends (epistemic high), producing a wider distribution and heavier downside tails if the curve flattens earlier than hoped.</li>
</ul></li>
</ol>
<p>During optimization, we focus on the second component —epistemic uncertainty— and can choose how much confidence we require around it. Once we choose an allocation, then we incorporate aleatoric uncertainty to quantify the total response distribution, if we want to.</p>
</section>
<section id="optimization" class="level1">
<h1>🧭 Optimization</h1>
<p>Lets thing about our model and their outputs, starting with the posterior predictive distribution: <span class="math display">\[
p\big(Y(b)\mid \text{data}\big) = \int p\big(Y(b)\mid \theta\big)\, p(\theta\mid \text{data})\, d\theta
\]</span></p>
<p>As you can see, the posterior predictive distribution incorporates both aleatoric and epistemic uncertainty, meaning, the optimization problem reduces to choosing an allocation <span class="math inline">\(b\)</span> that optimizes a scalar summary of this distribution.</p>
<p>Formally, let <span class="math inline">\(b \in \mathbb{R}^C\)</span> denote a feasible allocation (e.g., channel budgets) with constraints <span class="math display">\[
\sum_{c=1}^C b_c = B, \qquad \underline{b}_c \leq b_c \leq \overline{b}_c.
\]</span></p>
<p>For each candidate allocation <span class="math inline">\(b\)</span>, we obtain Monte Carlo draws from the posterior predictive distribution: <span class="math display">\[
\{Y^{(s)}(b)\}_{s=1}^S \sim p(Y \mid \mathrm{do}(X=b), \mathcal{D}),
\]</span></p>
<p>A statistic is then computed (for example, the mean, a quantile, a risk-adjusted score, or the mean tightness score). <span class="math display">\[
\phi\!\left(\{Y^{(s)}(b)\}\right)
\]</span></p>
<p>By consequence, the optimization problem solved by SLSQP is simply <span class="math display">\[
\min_{b \in \mathcal{B}} J(b), \qquad J(b) = f\!\left(\phi(\{Y^{(s)}(b)\})\right),
\]</span></p>
<p>where <span class="math inline">\(f\)</span> is defined so the solver minimizes the chosen statistic from the posterior predictive distribution.</p>
<p>This formulation is flexible: by changing <span class="math inline">\(\phi\)</span>, we can target risk-neutral or risk-sensitive criteria or even heuristics, while always grounding the decision in the posterior predictive distribution.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Assumption notes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do we say do=<span class="math inline">\((X=b)\)</span>?</p>
<ul>
<li><strong>Structural invariance</strong>: The response functions (trend, seasonality, adstock, saturation, link) are invariant under interventions <span class="math inline">\(b\)</span> over the optimization horizon.</li>
<li><strong>No unmeasured confounding</strong>: Conditional on included covariates and time controls, there are no unmeasured (especially time-varying) confounders affecting both spend and outcome; the backdoor criterion holds.</li>
</ul>
<p>We use <span class="math inline">\(p\big(Y \mid \mathrm{do}(X=b), \mathcal{D}\big)\)</span> as shorthand for the posterior predictive under these assumptions. When allocations move far outside support, results become extrapolative and should be treated as sensitivity analysis rather than identified effects.</p>
</div>
</div>
<section id="define-the-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="define-the-optimizer">🛠️ Define the optimizer</h2>
<p>Initializing the optimizer is straightforward: pass the model and the date range.</p>
<div id="269f744f" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>optimizable_model <span class="op">=</span> MultiDimensionalBudgetOptimizerWrapper(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>mmm, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span>df_test.date_week.<span class="bu">min</span>().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>), </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span>df_test.date_week.<span class="bu">max</span>().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Start date: </span><span class="sc">{</span>optimizable_model<span class="sc">.</span>start_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"End date: </span><span class="sc">{</span>optimizable_model<span class="sc">.</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start date: 2025-09-01
End date: 2025-09-01</code></pre>
</div>
</div>
<p>We’ll use the test set to define the budget and optimization period so we can compare the resulting allocation to our current plan.</p>
<div id="73242394" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>channels <span class="op">=</span> [<span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>num_periods <span class="op">=</span> optimizable_model.num_periods</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>time_unit_budget <span class="op">=</span> df_test[channels].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total budget to allocate: </span><span class="sc">{</span>num_periods <span class="op">*</span> time_unit_budget<span class="sc">:,.0f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total budget to allocate: 59</code></pre>
</div>
</div>
<p>Given the budget and channels, we can estimate the response for our initial plan.</p>
<div id="10503cd8" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>initial_budget <span class="op">=</span> df_test[channels].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>).to_xarray().rename({<span class="st">"index"</span>:<span class="st">"channel"</span>})</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>initial_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>initial_budget,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> optimizable_model.plot.budget_allocation(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">=</span>initial_posterior_response,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-22-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The bar chart shows allocation and response per channel. To see totals, we can sum and create a simple scatter plot with a label for the ROAS.</p>
<div id="83f3787d" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatterplot with spend and mean response</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>spend <span class="op">=</span> initial_posterior_response.allocation.<span class="bu">sum</span>().values</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>mean_response <span class="op">=</span> initial_posterior_response.total_media_contribution_original_scale.mean(dim<span class="op">=</span><span class="st">'sample'</span>).values</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>initial_roas <span class="op">=</span> mean_response <span class="op">/</span> spend</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, label<span class="op">=</span><span class="ss">f"ROAS: </span><span class="sc">{</span>initial_roas<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Spend'</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean Response'</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Spend vs Mean Response'</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="st">'small'</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-23-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We got a ROAS of <span class="math inline">\(3.9\)</span> for the initial plan, which is below our target ROAS (let’s say <span class="math inline">\(8\)</span>). Now we run a vanilla optimization to maximize mean response: can we reallocate to achieve a higher response given the same budget?</p>
<div id="e301aa31" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>allocation_strategy, optimization_result <span class="op">=</span> optimizable_model.optimize_budget(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>naive_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>allocation_strategy,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>naive_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(naive_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> optimizable_model.plot.budget_allocation(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">=</span>naive_posterior_response,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Budget allocation by channel:
  x1_original_scale: 0
  x2_original_scale: 0
  x3_original_scale: 16
  x4_original_scale: 42
Total Allocated Budget: 59</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-24-output-2.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Yes, we can allocate to achieve a higher response. Let’s compare the optimized response against the baseline plan.</p>
<div id="240831a2" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatterplot with spend and mean response</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>mean_response_v2 <span class="op">=</span> naive_posterior_response.total_media_contribution_original_scale.mean(dim<span class="op">=</span><span class="st">'sample'</span>).values</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>roas_v2 <span class="op">=</span> mean_response_v2 <span class="op">/</span> spend</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the delta in response</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>response_delta <span class="op">=</span> mean_response_v2.<span class="bu">sum</span>() <span class="op">-</span> mean_response.<span class="bu">sum</span>()</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response_v2, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation (+</span><span class="sc">{</span>response_delta<span class="sc">:.1f}</span><span class="ss"> response, ROAS: </span><span class="sc">{</span>roas_v2<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Guessed allocation"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Spend'</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean Response'</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Spend vs Mean Response'</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="st">'small'</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-25-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The optimized allocation is ~<span class="math inline">\(500\)</span> units higher than the guessed allocation, and the new estimated ROAS is <span class="math inline">\(13\)</span> which it’s over our expectations. As consequence, we assume we’ll get an estimate Y revenue in the next N periods and planning against this incoming cashflow we’ll get back.</p>
<p>The plotwist? We got a lower response, which mean a lower ROAS and we got in serious financial problems because we don’t have enough cash to payback providers or services.</p>
<p>Why this happen? Maximizing the mean response is risk-neutral. It often reallocates budget toward regions with potential high returns even if they are weakly identified, increasing dispersion of outcomes. This is rational when stakeholders are indifferent to risk. However, that’s not the case for every company. Sometimes our stakeholders need to know how certain we are about expected outcomes.</p>
<p>By inspecting posterior predictive samples under each allocation, we can quantify uncertainty and answer this question, based on the model current understanding.</p>
<p>Let’s plot the response distributions for both baseline and optimized allocations.</p>
<div id="730df96f" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>optimized_values <span class="op">=</span> naive_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>guessed_values <span class="op">=</span> initial_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>optimized_mean <span class="op">=</span> optimized_values.mean()</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>guessed_mean <span class="op">=</span> guessed_values.mean()</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-26-output-1.png" width="810" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As expected, the means differ (we optimized to increase it), and so does the certainty around the mean. Like an excersise, lets observe how probable is to get a response higher and lower than the mean.</p>
<div id="330e41da" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>optimized_mean,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-27-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This makes everything clear now, the chances of getting some higher or equal than the mean where 43% but the chances of getting some lower than the mean where 56%. It’s no surprise that we got a lower response and a lower ROAS.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 First Takeaway
</div>
</div>
<div class="callout-body-container callout-body">
<p>Comparing full distributions makes risk transparent: width quantifies forecast reliability, skewness reveals asymmetry of upside vs downside, and overlaps show practical indistinguishability.</p>
</div>
</div>
<p>Where this risk is coming from? The new allocation is riskier, but why? Let’s look at each spend level relative to its saturation curve.</p>
<div id="f274321c" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">10</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for optimal allocation on each subplot</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>allocation_values <span class="op">=</span> naive_posterior_response.allocation.values</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>channel_names <span class="op">=</span> naive_posterior_response.allocation.channel.values</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, allocation_value) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes.ravel(), allocation_values)):</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    ax.axvline(allocation_value, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Optimal allocation"</span>)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aeeff19f665243d49e3bae5d94592699","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-28-output-3.png" width="796" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Vertical lines are located at the spend allocation given for each channel. For channels as x4, the model has few observations at those spend levels, so posterior bands are wide and the induced response distribution is diffuse. Risk-aware optimization tends to pull spend toward well-identified regions (often near inflection), trading a small mean decrease for a large reduction in variance.</p>
<p>Could we understand this in advance? and if so, would we prefer a different type of allocation? Which get us closer to our objective in a safer way? -A narrower distribution with a slightly lower mean can be preferable when shortfall risk is costly-.</p>
<p>The short answer is <strong>definetly</strong>. Let’s create now a new optimization process that will be risk-aware.</p>
</section>
</section>
<section id="risk-metrics-consistent-with-pymc-marketing" class="level1">
<h1>⚖️ Risk metrics consistent with PyMC-Marketing</h1>
<p>Below are the definitions of two risk-aware metrics as implemented in the PyMC-Marketing library.</p>
<hr>
<section id="tail-distance" class="level2">
<h2 class="anchored" data-anchor-id="tail-distance">🌪️ Tail Distance</h2>
<p>For a confidence level <span class="math inline">\(\gamma \in (0,1)\)</span>,</p>
<p><span class="math display">\[
\operatorname{TailDistance}_\gamma(Y) \;=\;
\big|Q_{1-\gamma}(Y) - \mu\big| \;+\; \big|\mu - Q_{\gamma}(Y)\big|,
\]</span></p>
<p>where - <span class="math inline">\(\mu = \mathbb{E}[Y]\)</span> is the mean (estimated by the sample mean),<br>
- <span class="math inline">\(Q_q(Y)\)</span> is the <span class="math inline">\(q\)</span>-th quantile of the distribution of <span class="math inline">\(Y\)</span>.</p>
<p>This metric measures the <strong>spread of the distribution’s tails around the mean</strong>.<br>
Larger values indicate wider tails and thus higher uncertainty.</p>
<hr>
</section>
<section id="mean-tightness-score-mts" class="level2">
<h2 class="anchored" data-anchor-id="mean-tightness-score-mts">🎯 Mean Tightness Score (MTS)</h2>
<p>The Mean Tightness Score combines the mean with a penalty for tail spread:</p>
<p><span class="math display">\[
\operatorname{MTS}(Y; \alpha, \gamma) \;=\;
\mu \;-\; \alpha \cdot \operatorname{TailDistance}_\gamma(Y),
\]</span></p>
<p>where - <span class="math inline">\(\mu = \mathbb{E}[Y]\)</span> is the mean,<br>
- <span class="math inline">\(\gamma\)</span> is the confidence level used for the tail distance,<br>
- <span class="math inline">\(\alpha &gt; 0\)</span> is a penalty weight that controls the trade-off between higher mean and tighter distribution.</p>
<p>Interpretation:<br>
- <strong>Higher is better:</strong> Allocations with higher means and smaller dispersion score better. This provides a balance between risk-neutral (maximize mean) and risk-averse (penalize uncertainty) optimization.</p>
<p>Let’s optimize with the Mean Tightness Score and see the resulting allocation.</p>
<div id="29b1ea0c" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mts_budget_allocation, mts_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>ut.mean_tightness_score(alpha<span class="op">=</span><span class="fl">0.15</span>),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>, <span class="st">"ftol"</span>: <span class="fl">1e-16</span>}},</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>mts_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>mts_budget_allocation,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>mts_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(mts_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Budget allocation by channel:
  x1_original_scale: 16
  x2_original_scale: 38
  x3_original_scale: 2
  x4_original_scale: 1
Total Allocated Budget: 59</code></pre>
</div>
</div>
<p>Great, it looks like the allocation shifts toward better-identified regions. Let’s plot the saturation curves to see where the allocation lands.</p>
<div id="cdb3dd7a" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">4</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for optimal allocation on each subplot</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>allocation_values <span class="op">=</span> mts_posterior_response.allocation.values</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, allocation_value) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes.ravel(), allocation_values)):</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    ax.axvline(allocation_value, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Optimal allocation"</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"19c196c13c57437f99b029753eb76722","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-30-output-3.png" width="798" height="390" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As expected, recommendations for every channel lie in well-known regions.</p>
<p>The consequence: the posterior distribution narrows because budget concentrates in well-learned, less-nonlinear regions.</p>
<p>Let’s plot posterior distributions for this lower-risk allocation.</p>
<div id="7bb74832" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>optimized_risk_values <span class="op">=</span> mts_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    optimized_risk_values,</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Risk-adjusted allocation"</span>,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>risk_adjusted_mean <span class="op">=</span> optimized_risk_values.mean()</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>ax.axvline(risk_adjusted_mean, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>ax.text(risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.4</span>, </span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightgreen"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-31-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This makes it clear: we gained much more certainty—a risk-averse (lower-variance) response distribution. You may be thinking that playing in known regions tends to reduce the mean. Do you want to know why?</p>
<p>Posterior response curves tend to be more certain at the origin because two sources of uncertainty are minimized there: structurally, we know that zero spend produces zero incremental effect, and empirically, the lowest spend region is often well supported in historical data. As spend increases, especially beyond historically observed levels, epistemic uncertainty about the saturation and curvature parameters dominates, widening the credible intervals.</p>
<p>Does that mean we are doomed to lower values if we want certainty? Not at all, we can change the utility to prefer riskier options 🔥.</p>
<p>Let’s run a more risk-seeking allocation 👀</p>
<div id="9e948629" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>inverse_mts_budget_allocation, inverse_mts_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>ut.mean_tightness_score(alpha<span class="op">=</span><span class="fl">0.95</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>, <span class="st">"ftol"</span>: <span class="fl">1e-16</span>}},</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>inverse_mts_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>inverse_mts_budget_allocation,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>inverse_mts_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(inverse_mts_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Budget allocation by channel:
  x1_original_scale: 38
  x2_original_scale: 0
  x3_original_scale: 8
  x4_original_scale: 12
Total Allocated Budget: 59</code></pre>
</div>
</div>
<p>Flipping the tightness preference (alpha parameter) induces risk-seeking behavior, moving allocations toward higher-variance, high-upside regions.</p>
<p>Now we choose an allocation that is less certain but with higher potential upside than the baseline. Let’s plot the response distributions.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Second Takeaway
</div>
</div>
<div class="callout-body-container callout-body">
<p>Discover your risk preferences and adjust your objective function to reflect them. You don’t need to commit to a single function or approach, you can build a custom one which tailor your needs.</p>
</div>
</div>
<div id="c6f6c6d3" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>optimized_inverse_risk_values <span class="op">=</span> inverse_mts_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    optimized_risk_values,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Risk-adjusted allocation"</span>,</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    optimized_inverse_risk_values,</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Inverse Risk-adjusted allocation"</span>,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_mean <span class="op">=</span> optimized_inverse_risk_values.mean()</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>ax.axvline(risk_adjusted_mean, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>ax.axvline(inverse_risk_adjusted_mean, color<span class="op">=</span><span class="st">"orange"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>ax.text(risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.4</span>, </span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightgreen"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>ax.text(inverse_risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.2</span>, </span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Inverse Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>inverse_risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"orange"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-33-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Great, the new allocation is riskier, and the mean is higher (still less uncertant than the risk-neutral allocation). We can go beyond visuals and quantify this.</p>
<p>Because all are posterior distributions, we can check the density that has each response distribution at their respective mean. We’ll be using kernel density estimation (KDE). This value, denoted <span class="math inline">\(\hat{f}(\mu)\)</span>, represents the estimated height of the probability density function at the mean. Importantly, this is not itself a probability but a density, with units of “1 over the units of the variable.” Higher values of <span class="math inline">\(\hat{f}(\mu)\)</span> indicate that the distribution is sharply peaked around the mean, reflecting greater certainty that posterior draws will lie close to the central value. Conversely, lower values correspond to flatter, more diffuse posteriors, indicating higher uncertainty.</p>
<p>Let’s check the density at the mean for each allocation.</p>
<div id="53cfa359" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> gaussian_kde</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kde_density_at_point(x, x0):</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gaussian KDE density estimate at x0 using Scott's rule bandwidth."""</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    kde <span class="op">=</span> gaussian_kde(x)  <span class="co"># Scott's rule by default</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(kde.evaluate([x0])[<span class="dv">0</span>])</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>optimized_density <span class="op">=</span> kde_density_at_point(optimized_values, optimized_mean)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>guessed_density <span class="op">=</span> kde_density_at_point(guessed_values, guessed_mean)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>risk_adjusted_density <span class="op">=</span> kde_density_at_point(optimized_risk_values, risk_adjusted_mean)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_density <span class="op">=</span> kde_density_at_point(optimized_inverse_risk_values, inverse_risk_adjusted_mean)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimized allocation response density at mean: </span><span class="sc">{</span>optimized_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Guessed allocation response density at mean: </span><span class="sc">{</span>guessed_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Risk-adjusted allocation response density at mean: </span><span class="sc">{</span>risk_adjusted_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Inverse Risk-adjusted allocation response density at mean: </span><span class="sc">{</span>inverse_risk_adjusted_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Optimized allocation response density at mean: 0.001
Guessed allocation response density at mean: 0.005
Risk-adjusted allocation response density at mean: 0.013
Inverse Risk-adjusted allocation response density at mean: 0.003</code></pre>
</div>
</div>
<p>The density estimations tell the same story as the plots. How can we use this to take actions? For example, suppose we want to hit a target ROAS of <span class="math inline">\(9.5\)</span>, then we can check the density of the ROAS distribution at <span class="math inline">\(9.5\)</span> for each response distribution given their respective allocation strategy.</p>
<div id="8b651487" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>optimized_roas <span class="op">=</span> optimized_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>guessed_roas <span class="op">=</span> guessed_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>risk_adjusted_roas <span class="op">=</span> optimized_risk_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_roas <span class="op">=</span> optimized_inverse_risk_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate kde density at 9.5</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>_target_roas <span class="op">=</span> <span class="fl">9.5</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _target_roas)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _target_roas)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _target_roas)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _target_roas)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>ax.axvline(_target_roas, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-35-output-1.png" width="790" height="426" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If we want to hit a target ROAS of <span class="math inline">\(9.5\)</span>, the risk-neutral optimized allocation is the most certain, followed by the inverse risk-adjusted allocation.</p>
<p>If instead our target ROAS is <span class="math inline">\(7\)</span>, the inverse risk-adjusted allocation concentrates more density around that value, and the risk-neutral optimized allocation has less density around it.</p>
<div id="9c4a36ab" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate kde density at 7</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>_roas_target <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _roas_target)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _roas_target)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _roas_target)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _roas_target)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>ax.axvline(_roas_target, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-36-output-1.png" width="790" height="426" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Under this paradigm, you can define a target estimate and select an allocation that maximizes the probability of hitting it. One way is to create a function that reduces variance with respect to the target, favoring narrower distributions with density near the target.</p>
<p>Let’s make this custom utility function, and see how it performs.</p>
<div id="b7123ac2" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> pt</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc_marketing.mmm.utility <span class="im">as</span> ut</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> target_hit_probability(target, num_periods):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Target hit probability utility function.</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Minimizing the mean squared error between predicted ROAS and the target</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Adding a variance penalty to encourage tighter distributions.</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co">    target : float</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">        The target ROAS value to optimize towards</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co">    num_periods : int</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of time periods for the budget allocation</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="co">    callable</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="co">        A utility function that can be used with the budget optimizer.</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns negative objective (since optimizer minimizes).</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _function(samples, budgets):</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        roas_samples <span class="op">=</span> samples <span class="op">/</span> (pt.<span class="bu">sum</span>(budgets) <span class="op">*</span> num_periods)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use mean squared error from target, which provides smoother gradients</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        mse_from_target <span class="op">=</span> pt.mean((roas_samples <span class="op">-</span> target) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add penalty for variance to encourage tighter distributions around target</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>        variance_penalty <span class="op">=</span> pt.var(roas_samples)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine MSE and variance penalty with weighting</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Higher variance penalty encourages narrower distributions</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        total_objective <span class="op">=</span> mse_from_target <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> variance_penalty</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>total_objective</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _function</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>_roas_target <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>custom_utility_budget_allocation, custom_utility_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>target_hit_probability(_roas_target, num_periods),</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>}},</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>custom_utility_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>custom_utility_budget_allocation,</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>custom_utility_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(custom_utility_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Budget allocation by channel:
  x1_original_scale: 23
  x2_original_scale: 0
  x3_original_scale: 23
  x4_original_scale: 12
Total Allocated Budget: 59</code></pre>
</div>
</div>
<p>The allocation is similar to those observed before. Let’s plot the ROAS distributions.</p>
<div id="73b22e33" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>custom_utility_values <span class="op">=</span> custom_utility_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>custom_utility_roas <span class="op">=</span> custom_utility_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _roas_target)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _roas_target)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _roas_target)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _roas_target)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>custom_utility_kde_density <span class="op">=</span> kde_density_at_point(custom_utility_roas, _roas_target)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>az.plot_dist(custom_utility_roas, color<span class="op">=</span><span class="st">"purple"</span>, label<span class="op">=</span><span class="ss">f"Custom utility allocation: </span><span class="sc">{</span>custom_utility_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>ax.axvline(_roas_target, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-38-output-1.png" width="790" height="426" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Great 🙌🏻 The initial optimized allocation which was risk neutral, had initially the higher density around the target ROAS, but the density around it was not high enough, the new allocation bring a more certain answer around the target, because the objective function was built for it.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Key Insight
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we have a custom utility function that allows us to optimize for a target ROAS. Nevertheless, you can build other utilities and use them as objectives. You can also introduce risk-aware constraints—without on top of your business constraints.</p>
</div>
</div>
<p>Let’s observe our final posterior around the target ROAS.</p>
<div id="d0646036" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    custom_utility_roas, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>_roas_target</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-39-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We could report: the probability of achieving ROAS ≥ 10 with this allocation is 31%, and ROAS &lt; 10 is 69%. If we need more certainty, we can make the optimization more risk-averse.</p>
<p>Now, if you want to think really bayesian, then you can define a region of practical equivalence, and check the probability of the ROAS being in that region. For example, you can ask yourself: Would I do something different if ROAS is 7, 9 or 11? If the answer it’s no, then you find your ROPE.</p>
<p>Let’s say we want to know the probability of the ROAS being between <span class="math inline">\(7\)</span> and <span class="math inline">\(11\)</span>.</p>
<div id="7e280209" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate probability of ROAS being between 7 and 9</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>prob_7_to_11 <span class="op">=</span> np.mean((custom_utility_roas <span class="op">&gt;=</span> <span class="dv">7</span>) <span class="op">&amp;</span> (custom_utility_roas <span class="op">&lt;=</span> <span class="dv">11</span>))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior with reference values and region</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    custom_utility_roas, </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>_roas_target,</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for the region of interest</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="dv">7</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">"ROAS = 7"</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="dv">11</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">"ROAS = 11"</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text box with probability</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, </span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'P(7 ≤ ROAS ≤ 11) = </span><span class="sc">{</span>prob_7_to_11<span class="sc">:.2%}</span><span class="ss">'</span>, </span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>),</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_models_and_risk_optimization_files/figure-html/cell-40-output-1.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
💡 Key Insight
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can <strong>define a region of practical equivalence (ROPE)</strong>, in order to be more precise with your decision making. This is quite natural way to think about a problem, and lightens the burden of the decision maker to commit to a single number. At the end of the day, we don’t need to be 99.999% precise around every single answer, or number, we can be 95% or 90% precise and sometimes that’s enough. <em>Identify if thats your case, and think accordingly</em>.</p>
</div>
</div>
</section>
</section>
<section id="takeaways-on-uncertainty" class="level1">
<h1>✅ Takeaways on uncertainty</h1>
<ul>
<li><strong>Treat uncertainty as first-class</strong>: Optimize over the full posterior predictive, not point estimates. Compare plans by their distributions, not just expected means.</li>
<li><strong>Separate uncertainty types</strong>: Aleatoric (irreducible noise) vs epistemic (learnable model/parameter uncertainty). Planning choices mostly shift epistemic risk; always communicate both.</li>
<li><strong>Find your risk appetite</strong>: Ask stakeholders how certain we must be about reported results. What changes if they are a bit higher or lower?</li>
<li><strong>Choose a utility aligned to risk appetite</strong>: Working with the mean is risk-neutral; quantiles, TailDistance, CVaR, or MTS are more risk-aware.</li>
<li><strong>Communicate distributions, not single numbers</strong>: Show HDIs/quantiles and probabilities (e.g., P(ROAS ≥ target)). It’s better to understand the full spectrum of possibilities than to follow single numbers and be short-sighted.</li>
<li><strong>Define a region of practical equivalence (ROPE)</strong>: Once you are comfortable with the uncertainty, play with ROPEs and find out how much you could lighten the estimated answer, and if you will do anything different if this one change under a range of values.</li>
</ul>
</section>
<section id="limitations" class="level1">
<h1>🚧 Limitations</h1>
<ul>
<li>This approach represents the model’s confidence, but models can be very certain about a wrong answer. Always add business knowledge and guardrails to keep recommendations realistic.</li>
</ul>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Hope this article was helpful to understand how to use Bayesian media mix models to optimize your media spend. Understand uncertanty it’s a powerful tool to make better decisions, but it’s not a silver bullet.</p>
<p>The current example is a simple one, real life applications are more complex and require more sophisticated models, risk functions, and complex optimization problems, where constraints and business knowledge are key.</p>
<p>At <a href="https://www.pymc-labs.com/">PyMC Labs</a> we’re building tools to make this process easier. If you’re interested in learning more, explore the PyMC‑Marketing <a href="https://www.pymc-marketing.io/en/stable/gallery/gallery.html">Example Gallery</a> and <a href="https://www.pymc-marketing.io/en/stable/api/index.html">API</a>, our <a href="https://docs.pymc-marketing.com/">documentation</a> and <a href="https://www.pymc-labs.com/blog-posts">blog</a>.</p>
<p>You can get a 30 minutes free consultation with our team to discuss your specific needs and how we can help you.</p>
<ul>
<li>1:1 Session with me: <a href="https://calendar.app.google/vX9DziLkdMSAAszU8">Book a call</a></li>
<li>Discovery session with PyMC Labs team: <a href="https://www.pymc-labs.com/?utm_source=carlos_trujillo&amp;utm_medium=pydata_berlin&amp;utm_campaign=bayesian_mmm_article">Book a call</a></li>
</ul>
<p>Thanks if you read this far!</p>


<!-- -->

</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"19c196c13c57437f99b029753eb76722":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_1d0ee4bf15d04e899551af93a82286a2","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"1d0ee4bf15d04e899551af93a82286a2":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"26dc201d763342b89bee1a272bff7e38":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"457e395f09eb4e0f85fefd5347f341ab":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_e6c9294fefea4973907118dfce616566","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"95db31e60f3c4ddaa7d205266e7bafae":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_26dc201d763342b89bee1a272bff7e38","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Computing ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00\n</pre>\n","text/plain":"Computing ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"aeeff19f665243d49e3bae5d94592699":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_f66f0bd6b9e0418596d08ffb8d5947c3","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"b991fd7728f54b898374b6c79b32da9c":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_e3622492ce35460a9db1e98febad8c5f","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"e3622492ce35460a9db1e98febad8c5f":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e6c9294fefea4973907118dfce616566":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"f66f0bd6b9e0418596d08ffb8d5947c3":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/cetagostini\.github\.io\/cetagostini\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian Models and Risk Optimization"</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-08-20"</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [MMM, python, optimization, media mix modeling, bayesian, pymc, pydata, germany, berlin]</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "../images/bayesian_models_and_risk_optimization.png"</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> cetagostini_web</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># 📘 Introduction</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>This article explores how Bayesian Media Mix Modeling (MMM) represents uncertainty and how we can optimize budget decisions under risk. We build a generative view of media response (carryover via adstock, diminishing returns via saturation, trend and seasonality) and use full posterior predictive distributions to compare allocations not only by expected outcomes but also by dispersion and tail risk.</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>This material accompanies my PyData Berlin 2025 talk, where I discuss practical risk-aware optimization for MMM: moving beyond mean-only plans to objectives that explicitly incorporate uncertainty—and how to communicate these trade-offs to stakeholders.</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="fu"># 📦 Import libraries</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.builders.yaml <span class="im">import</span> build_mmm_from_yaml</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> GeometricAdstock, MichaelisMentenSaturation</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.budget_optimizer <span class="im">import</span> optimizer_xarray_builder</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm.multidimensional <span class="im">import</span> (</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    MultiDimensionalBudgetOptimizerWrapper,</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.prior <span class="im">import</span> Prior</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> utility <span class="im">as</span> ut</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> ndimage</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="fu"># ⚙️ Notebook setup </span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-darkgrid"</span>)</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.dpi"</span>] <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"xtick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"ytick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({<span class="st">"figure.constrained_layout.use"</span>: <span class="va">True</span>})</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>seed: <span class="bu">int</span> <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">map</span>(<span class="bu">ord</span>, <span class="st">"pydata_berlin_2025"</span>))</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>rng: np.random.Generator <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span>seed)</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>default_figsize <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">4</span>) <span class="co"># repeat to use later</span></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🧪 Data generation process</span></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>This section encodes a generative story for media response with clear uncertainty sources. We simulate outcomes as</span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>y_t = \beta_0 + \sum_{c} f(x_{c,t}; \theta_c) + \text{trend}_t + \text{seasonality}_t + \varepsilon_t</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_t$ is the observed outcome (e.g., app installs or revenue) at time $t$</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_0$ is the baseline intercept</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$f(x_{c,t}; \theta_c)$ is the media response function for channel $c$ with spend $x_{c,t}$ and parameters $\theta_c$.</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\text{trend}_t$ captures long-term growth or decline patterns</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\text{seasonality}_t$ models periodic effects (weekly, monthly patterns)</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\varepsilon_t$ represents aleatoric uncertainty—irreducible noise from unobserved factors, measurement error, and inherent randomness that remains even with perfect knowledge of all parameters</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>We do not consider interactions; the causal DAG looks like this:</span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> graphviz.Digraph()</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Media Spend"</span>)</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Trend"</span>, style<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Seasonality"</span>, style<span class="op">=</span><span class="st">"dashed"</span>)</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>graph.node(<span class="st">"Target"</span>)</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Media Spend"</span>, <span class="st">"Target"</span>)</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Trend"</span>, <span class="st">"Target"</span>)</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>graph.edge(<span class="st">"Seasonality"</span>, <span class="st">"Target"</span>)</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>graph</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a><span class="fu">## 📆 Date range</span></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>We start by defining the date range.</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a><span class="co"># date range</span></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>min_date <span class="op">=</span> pd.to_datetime(<span class="st">"2024-09-01"</span>)</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>max_date <span class="op">=</span> pd.to_datetime(<span class="st">"2025-09-01"</span>)</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"date_week"</span>: pd.date_range(start<span class="op">=</span>min_date, end<span class="op">=</span>max_date, freq<span class="op">=</span><span class="st">"W-MON"</span>)}</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> df.shape[<span class="dv">0</span>]</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of observations: </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a><span class="fu">## 📣 Media data</span></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a><span class="co"># media data</span></span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a>scaler_x1 <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a>scaler_x2 <span class="op">=</span> <span class="dv">280</span></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>scaler_x3 <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>scaler_x4 <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>y_scaler <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a><span class="co"># media data</span></span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">1.0</span>, size<span class="op">=</span>n)</span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1"</span>] <span class="op">=</span> np.where(x1 <span class="op">&gt;</span> <span class="fl">0.8</span>, x1, x1 <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.6</span>, size<span class="op">=</span>n)</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2"</span>] <span class="op">=</span> np.where(x2 <span class="op">&gt;</span> <span class="fl">0.5</span>, x2, <span class="dv">0</span>)</span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a>x3 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span>n)</span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3"</span>] <span class="op">=</span> np.where(x3 <span class="op">&gt;</span> <span class="fl">0.7</span>, x3, x3 <span class="op">/</span> <span class="dv">6</span>)</span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a>x4 <span class="op">=</span> rng.uniform(low<span class="op">=</span><span class="fl">0.0</span>, high<span class="op">=</span><span class="fl">0.2</span>, size<span class="op">=</span>n)</span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4"</span>] <span class="op">=</span> np.where(x4 <span class="op">&gt;</span> <span class="fl">0.15</span>, x4, x4 <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">4</span>, ncols<span class="op">=</span><span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>, layout<span class="op">=</span><span class="st">"constrained"</span></span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">3</span>])</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">3</span>].<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Media Costs Data"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## 📈 Trend and seasonality components</span></span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a>We define trend and seasonality. Seasonality follows a 4-week cycle modeled with a Fourier basis; trend is linear.</span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Fourier components for monthly seasonality</span></span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>monthly_period <span class="op">=</span> <span class="dv">4</span>  <span class="co"># 4-week cycle</span></span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.arange(n)</span>
<span id="cb49-176"><a href="#cb49-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-177"><a href="#cb49-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sin-cos signals for fourier components</span></span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a>monthly_sin <span class="op">=</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> monthly_period)</span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a>monthly_cos <span class="op">=</span> np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> monthly_period)</span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine sin-cos to create the desired pattern</span></span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Use coefficients to shape the pattern</span></span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> monthly_sin <span class="op">+</span> <span class="fl">0.4</span> <span class="op">*</span> monthly_cos</span>
<span id="cb49-184"><a href="#cb49-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-185"><a href="#cb49-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply smoothing using ndimage to reduce sharp transitions</span></span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> ndimage.gaussian_filter1d(monthly_pattern, sigma<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-188"><a href="#cb49-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize to [-1, 1] range</span></span>
<span id="cb49-189"><a href="#cb49-189" aria-hidden="true" tabindex="-1"></a>monthly_pattern <span class="op">=</span> (monthly_pattern <span class="op">/</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(monthly_pattern))) <span class="op">*</span> <span class="fl">.18</span></span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"monthly_effect"</span>] <span class="op">=</span> monthly_pattern</span>
<span id="cb49-192"><a href="#cb49-192" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"trend"</span>] <span class="op">=</span> (np.linspace(start<span class="op">=</span><span class="fl">0.0</span>, stop<span class="op">=</span><span class="dv">10</span>, num<span class="op">=</span>n) <span class="op">+</span> <span class="dv">10</span>) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> <span class="dv">8</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb49-193"><a href="#cb49-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot monthly pattern</span></span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a>ax1.plot(df[<span class="st">"date_week"</span>], monthly_pattern, label<span class="op">=</span><span class="st">"Monthly Pattern (Smoothed)"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb49-198"><a href="#cb49-198" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"Pattern Value"</span>)</span>
<span id="cb49-199"><a href="#cb49-199" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"Monthly Fourier Pattern (4-week cycle, Smoothed)"</span>)</span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb49-201"><a href="#cb49-201" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb49-202"><a href="#cb49-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-203"><a href="#cb49-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend</span></span>
<span id="cb49-204"><a href="#cb49-204" aria-hidden="true" tabindex="-1"></a>ax2.plot(df[<span class="st">"date_week"</span>], df[<span class="st">"trend"</span>], label<span class="op">=</span><span class="st">"Trend"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb49-205"><a href="#cb49-205" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb49-206"><a href="#cb49-206" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"Trend Value"</span>)</span>
<span id="cb49-207"><a href="#cb49-207" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"Linear Trend Component"</span>)</span>
<span id="cb49-208"><a href="#cb49-208" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb49-209"><a href="#cb49-209" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb49-210"><a href="#cb49-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-211"><a href="#cb49-211" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-212"><a href="#cb49-212" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-213"><a href="#cb49-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-214"><a href="#cb49-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-215"><a href="#cb49-215" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🔁 Adstock and saturation transformations</span></span>
<span id="cb49-216"><a href="#cb49-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-217"><a href="#cb49-217" aria-hidden="true" tabindex="-1"></a>First, we apply the adstock transformation to the media data.</span>
<span id="cb49-218"><a href="#cb49-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-221"><a href="#cb49-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-222"><a href="#cb49-222" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-223"><a href="#cb49-223" aria-hidden="true" tabindex="-1"></a><span class="co"># apply geometric adstock transformation</span></span>
<span id="cb49-224"><a href="#cb49-224" aria-hidden="true" tabindex="-1"></a>alpha: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.55</span></span>
<span id="cb49-225"><a href="#cb49-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-226"><a href="#cb49-226" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb49-227"><a href="#cb49-227" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x1"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb49-228"><a href="#cb49-228" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb49-229"><a href="#cb49-229" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-230"><a href="#cb49-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-231"><a href="#cb49-231" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb49-232"><a href="#cb49-232" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x2"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb49-233"><a href="#cb49-233" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb49-234"><a href="#cb49-234" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-235"><a href="#cb49-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-236"><a href="#cb49-236" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb49-237"><a href="#cb49-237" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x3"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb49-238"><a href="#cb49-238" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb49-239"><a href="#cb49-239" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-240"><a href="#cb49-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-241"><a href="#cb49-241" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_adstock"</span>] <span class="op">=</span> (</span>
<span id="cb49-242"><a href="#cb49-242" aria-hidden="true" tabindex="-1"></a>    GeometricAdstock(l_max<span class="op">=</span><span class="dv">8</span>, normalize<span class="op">=</span><span class="va">True</span>).function(x<span class="op">=</span>df[<span class="st">"x4"</span>].to_numpy(), alpha<span class="op">=</span>alpha)</span>
<span id="cb49-243"><a href="#cb49-243" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">eval</span>()</span>
<span id="cb49-244"><a href="#cb49-244" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-245"><a href="#cb49-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-246"><a href="#cb49-246" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb49-247"><a href="#cb49-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-248"><a href="#cb49-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-249"><a href="#cb49-249" aria-hidden="true" tabindex="-1"></a>Then we apply the saturation transformation to the adstock transformed media data.</span>
<span id="cb49-250"><a href="#cb49-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-253"><a href="#cb49-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-254"><a href="#cb49-254" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-255"><a href="#cb49-255" aria-hidden="true" tabindex="-1"></a>alpha_sat_x1: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb49-256"><a href="#cb49-256" aria-hidden="true" tabindex="-1"></a>lam_sat_x1: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.1</span></span>
<span id="cb49-257"><a href="#cb49-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-258"><a href="#cb49-258" aria-hidden="true" tabindex="-1"></a>alpha_sat_x2: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb49-259"><a href="#cb49-259" aria-hidden="true" tabindex="-1"></a>lam_sat_x2: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb49-260"><a href="#cb49-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-261"><a href="#cb49-261" aria-hidden="true" tabindex="-1"></a>alpha_sat_x3: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb49-262"><a href="#cb49-262" aria-hidden="true" tabindex="-1"></a>lam_sat_x3: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb49-263"><a href="#cb49-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-264"><a href="#cb49-264" aria-hidden="true" tabindex="-1"></a>alpha_sat_x4: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb49-265"><a href="#cb49-265" aria-hidden="true" tabindex="-1"></a>lam_sat_x4: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb49-266"><a href="#cb49-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-267"><a href="#cb49-267" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb49-268"><a href="#cb49-268" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb49-269"><a href="#cb49-269" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x1_adstock"</span>].to_numpy(),</span>
<span id="cb49-270"><a href="#cb49-270" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x1,</span>
<span id="cb49-271"><a href="#cb49-271" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x1,</span>
<span id="cb49-272"><a href="#cb49-272" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb49-273"><a href="#cb49-273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-274"><a href="#cb49-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-275"><a href="#cb49-275" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb49-276"><a href="#cb49-276" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb49-277"><a href="#cb49-277" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x2_adstock"</span>].to_numpy(),</span>
<span id="cb49-278"><a href="#cb49-278" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x2,</span>
<span id="cb49-279"><a href="#cb49-279" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x2,</span>
<span id="cb49-280"><a href="#cb49-280" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb49-281"><a href="#cb49-281" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-282"><a href="#cb49-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-283"><a href="#cb49-283" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb49-284"><a href="#cb49-284" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb49-285"><a href="#cb49-285" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x3_adstock"</span>].to_numpy(),  </span>
<span id="cb49-286"><a href="#cb49-286" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x3,</span>
<span id="cb49-287"><a href="#cb49-287" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x3,</span>
<span id="cb49-288"><a href="#cb49-288" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb49-289"><a href="#cb49-289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-290"><a href="#cb49-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-291"><a href="#cb49-291" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_adstock_saturated"</span>] <span class="op">=</span> (</span>
<span id="cb49-292"><a href="#cb49-292" aria-hidden="true" tabindex="-1"></a>    MichaelisMentenSaturation().function(</span>
<span id="cb49-293"><a href="#cb49-293" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>df[<span class="st">"x4_adstock"</span>].to_numpy(),</span>
<span id="cb49-294"><a href="#cb49-294" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha_sat_x4,</span>
<span id="cb49-295"><a href="#cb49-295" aria-hidden="true" tabindex="-1"></a>        lam<span class="op">=</span>lam_sat_x4,</span>
<span id="cb49-296"><a href="#cb49-296" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">eval</span>()</span>
<span id="cb49-297"><a href="#cb49-297" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-298"><a href="#cb49-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-299"><a href="#cb49-299" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb49-300"><a href="#cb49-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-301"><a href="#cb49-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-302"><a href="#cb49-302" aria-hidden="true" tabindex="-1"></a>Let's visualize how the media data look after adstock and saturation, and how they translate into units of Y (app installs or revenue).</span>
<span id="cb49-303"><a href="#cb49-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-306"><a href="#cb49-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-307"><a href="#cb49-307" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-308"><a href="#cb49-308" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb49-309"><a href="#cb49-309" aria-hidden="true" tabindex="-1"></a>    nrows<span class="op">=</span><span class="dv">3</span>, ncols<span class="op">=</span><span class="dv">4</span>, sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">False</span>, layout<span class="op">=</span><span class="st">"constrained"</span></span>
<span id="cb49-310"><a href="#cb49-310" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-311"><a href="#cb49-311" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb49-312"><a href="#cb49-312" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb49-313"><a href="#cb49-313" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb49-314"><a href="#cb49-314" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb49-315"><a href="#cb49-315" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x1_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb49-316"><a href="#cb49-316" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x2_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C1"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb49-317"><a href="#cb49-317" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">2</span>])</span>
<span id="cb49-318"><a href="#cb49-318" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb49-319"><a href="#cb49-319" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x3_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C2"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb49-320"><a href="#cb49-320" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, <span class="dv">3</span>])</span>
<span id="cb49-321"><a href="#cb49-321" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4_adstock"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb49-322"><a href="#cb49-322" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"date_week"</span>, y<span class="op">=</span><span class="st">"x4_adstock_saturated"</span>, data<span class="op">=</span>df, color<span class="op">=</span><span class="st">"C3"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb49-323"><a href="#cb49-323" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Media Costs Data - Transformed"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb49-324"><a href="#cb49-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-325"><a href="#cb49-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-326"><a href="#cb49-326" aria-hidden="true" tabindex="-1"></a>We now add the intercept and noise, and sum the transformed media, trend, and seasonality components.</span>
<span id="cb49-327"><a href="#cb49-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-330"><a href="#cb49-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-331"><a href="#cb49-331" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-332"><a href="#cb49-332" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"intercept"</span>] <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb49-333"><a href="#cb49-333" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"epsilon"</span>] <span class="op">=</span> rng.normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">0.075</span>, size<span class="op">=</span>n)</span>
<span id="cb49-334"><a href="#cb49-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-335"><a href="#cb49-335" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"app_installs"</span>] <span class="op">=</span> df[[<span class="st">"intercept"</span>, <span class="st">"x1_adstock_saturated"</span>, <span class="st">"x2_adstock_saturated"</span>, <span class="st">"x3_adstock_saturated"</span>, <span class="st">"x4_adstock_saturated"</span>, <span class="st">"trend"</span>, <span class="st">"monthly_effect"</span>, <span class="st">"epsilon"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-336"><a href="#cb49-336" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"app_installs"</span>] <span class="op">*=</span> y_scaler</span>
<span id="cb49-337"><a href="#cb49-337" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb49-338"><a href="#cb49-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-339"><a href="#cb49-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-340"><a href="#cb49-340" aria-hidden="true" tabindex="-1"></a>This is how the target looks.</span>
<span id="cb49-341"><a href="#cb49-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-344"><a href="#cb49-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-345"><a href="#cb49-345" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-346"><a href="#cb49-346" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">"date_week"</span>).app_installs.plot()<span class="op">;</span></span>
<span id="cb49-347"><a href="#cb49-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-348"><a href="#cb49-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-349"><a href="#cb49-349" aria-hidden="true" tabindex="-1"></a>We also add the original media to the DataFrame so we can visualize it before any transformations and use it as model input.</span>
<span id="cb49-350"><a href="#cb49-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-353"><a href="#cb49-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-354"><a href="#cb49-354" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-355"><a href="#cb49-355" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]] <span class="op">=</span> df[[<span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>, <span class="st">"x4"</span>]]</span>
<span id="cb49-356"><a href="#cb49-356" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x1_original_scale"</span>] <span class="op">*=</span> scaler_x1</span>
<span id="cb49-357"><a href="#cb49-357" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x2_original_scale"</span>] <span class="op">*=</span> scaler_x2</span>
<span id="cb49-358"><a href="#cb49-358" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x3_original_scale"</span>] <span class="op">*=</span> scaler_x3</span>
<span id="cb49-359"><a href="#cb49-359" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"x4_original_scale"</span>] <span class="op">*=</span> scaler_x4</span>
<span id="cb49-360"><a href="#cb49-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-361"><a href="#cb49-361" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"app_installs"</span>]].head()</span>
<span id="cb49-362"><a href="#cb49-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-363"><a href="#cb49-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-364"><a href="#cb49-364" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🏗️ Building the model</span></span>
<span id="cb49-365"><a href="#cb49-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-366"><a href="#cb49-366" aria-hidden="true" tabindex="-1"></a>The YAML configuration encodes a fully Bayesian MMM with priors over the core response mechanics and temporal structure. For model specifics and worked examples, see the PyMC‑Marketing <span class="co">[</span><span class="ot">Example Gallery</span><span class="co">](https://www.pymc-marketing.io/en/stable/gallery/gallery.html)</span> and <span class="co">[</span><span class="ot">API</span><span class="co">](https://www.pymc-marketing.io/en/stable/api/index.html)</span>.</span>
<span id="cb49-367"><a href="#cb49-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-368"><a href="#cb49-368" aria-hidden="true" tabindex="-1"></a>Here we split the data into train and test sets. Not to evaluate the fit; instead, we use the test set to compare the results of the optimization, checking if it will be "better" than the budget recommendations.</span>
<span id="cb49-369"><a href="#cb49-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-372"><a href="#cb49-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-373"><a href="#cb49-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-374"><a href="#cb49-374" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> df.query(<span class="st">"date_week &lt;= '2025-08-30'"</span>).copy()</span>
<span id="cb49-375"><a href="#cb49-375" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> df_train[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]]</span>
<span id="cb49-376"><a href="#cb49-376" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train[<span class="st">"app_installs"</span>]</span>
<span id="cb49-377"><a href="#cb49-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-378"><a href="#cb49-378" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df.query(<span class="st">"date_week &gt; '2025-08-30'"</span>).copy()</span>
<span id="cb49-379"><a href="#cb49-379" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> df_test[[<span class="st">"date_week"</span>, <span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]]</span>
<span id="cb49-380"><a href="#cb49-380" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test[<span class="st">"app_installs"</span>]</span>
<span id="cb49-381"><a href="#cb49-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-382"><a href="#cb49-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-383"><a href="#cb49-383" aria-hidden="true" tabindex="-1"></a>Because the model was defined previously in the YAML, building it is straightforward and takes only a few lines.</span>
<span id="cb49-384"><a href="#cb49-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-387"><a href="#cb49-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-388"><a href="#cb49-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-389"><a href="#cb49-389" aria-hidden="true" tabindex="-1"></a>mmm <span class="op">=</span> build_mmm_from_yaml(</span>
<span id="cb49-390"><a href="#cb49-390" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb49-391"><a href="#cb49-391" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>y_train,</span>
<span id="cb49-392"><a href="#cb49-392" aria-hidden="true" tabindex="-1"></a>    config_path<span class="op">=</span><span class="st">"pymc_model.yml"</span>,</span>
<span id="cb49-393"><a href="#cb49-393" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-394"><a href="#cb49-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-395"><a href="#cb49-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-396"><a href="#cb49-396" aria-hidden="true" tabindex="-1"></a>Now we fit the model and check convergence.</span>
<span id="cb49-397"><a href="#cb49-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-400"><a href="#cb49-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-401"><a href="#cb49-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-402"><a href="#cb49-402" aria-hidden="true" tabindex="-1"></a>mmm.fit(</span>
<span id="cb49-403"><a href="#cb49-403" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb49-404"><a href="#cb49-404" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>y_train,</span>
<span id="cb49-405"><a href="#cb49-405" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb49-406"><a href="#cb49-406" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-407"><a href="#cb49-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-408"><a href="#cb49-408" aria-hidden="true" tabindex="-1"></a>mmm.sample_posterior_predictive(</span>
<span id="cb49-409"><a href="#cb49-409" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>x_train,</span>
<span id="cb49-410"><a href="#cb49-410" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-411"><a href="#cb49-411" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-412"><a href="#cb49-412" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb49-413"><a href="#cb49-413" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-414"><a href="#cb49-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-415"><a href="#cb49-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-416"><a href="#cb49-416" aria-hidden="true" tabindex="-1"></a>Great, no divergences 🔥</span>
<span id="cb49-417"><a href="#cb49-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-420"><a href="#cb49-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-421"><a href="#cb49-421" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-422"><a href="#cb49-422" aria-hidden="true" tabindex="-1"></a>mmm.idata.sample_stats.diverging.<span class="bu">sum</span>().item()</span>
<span id="cb49-423"><a href="#cb49-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-424"><a href="#cb49-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-425"><a href="#cb49-425" aria-hidden="true" tabindex="-1"></a>Now we inspect the parameters relevant for optimization.</span>
<span id="cb49-426"><a href="#cb49-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-429"><a href="#cb49-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-430"><a href="#cb49-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-431"><a href="#cb49-431" aria-hidden="true" tabindex="-1"></a>media_vars <span class="op">=</span> [</span>
<span id="cb49-432"><a href="#cb49-432" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha"</span>,</span>
<span id="cb49-433"><a href="#cb49-433" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam"</span>,</span>
<span id="cb49-434"><a href="#cb49-434" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adstock_alpha"</span>,</span>
<span id="cb49-435"><a href="#cb49-435" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb49-436"><a href="#cb49-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-437"><a href="#cb49-437" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> az.plot_trace(</span>
<span id="cb49-438"><a href="#cb49-438" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>mmm.fit_result,</span>
<span id="cb49-439"><a href="#cb49-439" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>media_vars,</span>
<span id="cb49-440"><a href="#cb49-440" aria-hidden="true" tabindex="-1"></a>    compact<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-441"><a href="#cb49-441" aria-hidden="true" tabindex="-1"></a>    backend_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"layout"</span>: <span class="st">"constrained"</span>},</span>
<span id="cb49-442"><a href="#cb49-442" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-443"><a href="#cb49-443" aria-hidden="true" tabindex="-1"></a>plt.gcf().suptitle(<span class="st">"Model Trace"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>, y<span class="op">=</span><span class="fl">1.03</span>)<span class="op">;</span></span>
<span id="cb49-444"><a href="#cb49-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-445"><a href="#cb49-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-446"><a href="#cb49-446" aria-hidden="true" tabindex="-1"></a>As expected, some parameters are well identified while others remain uncertain.</span>
<span id="cb49-447"><a href="#cb49-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-448"><a href="#cb49-448" aria-hidden="true" tabindex="-1"></a>Sampling saturation curves from the posterior helps us visualize parameter uncertainty as bands around each channel’s response. Wide bands indicate poorly identified marginal returns; allocating in those regions increases outcome variance because small parameter shifts cause large changes in response.</span>
<span id="cb49-449"><a href="#cb49-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-452"><a href="#cb49-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-453"><a href="#cb49-453" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-454"><a href="#cb49-454" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb49-455"><a href="#cb49-455" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">3</span></span>
<span id="cb49-456"><a href="#cb49-456" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-457"><a href="#cb49-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-458"><a href="#cb49-458" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb49-459"><a href="#cb49-459" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb49-460"><a href="#cb49-460" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-461"><a href="#cb49-461" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb49-462"><a href="#cb49-462" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb49-463"><a href="#cb49-463" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb49-464"><a href="#cb49-464" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb49-465"><a href="#cb49-465" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb49-466"><a href="#cb49-466" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-467"><a href="#cb49-467" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-468"><a href="#cb49-468" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-469"><a href="#cb49-469" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-470"><a href="#cb49-470" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb49-471"><a href="#cb49-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-472"><a href="#cb49-472" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-473"><a href="#cb49-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-474"><a href="#cb49-474" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes.ravel():</span>
<span id="cb49-475"><a href="#cb49-475" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb49-476"><a href="#cb49-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-477"><a href="#cb49-477" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-478"><a href="#cb49-478" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb49-479"><a href="#cb49-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-480"><a href="#cb49-480" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-481"><a href="#cb49-481" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-482"><a href="#cb49-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-483"><a href="#cb49-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-484"><a href="#cb49-484" aria-hidden="true" tabindex="-1"></a>The picture is clear: channels like X1 and X3 exhibit more variation across spend levels, allowing the model to learn their parameters more precisely. Channels like X2 and X4 have relatively constant spending with less variation, so their parameters are estimated with greater uncertainty.</span>
<span id="cb49-485"><a href="#cb49-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-486"><a href="#cb49-486" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🎲 Understanding uncertainty</span></span>
<span id="cb49-487"><a href="#cb49-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-488"><a href="#cb49-488" aria-hidden="true" tabindex="-1"></a>In a Bayesian MMM we explicitly model two forms of uncertainty that compound in forecasts and in budget decisions:</span>
<span id="cb49-489"><a href="#cb49-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-490"><a href="#cb49-490" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Aleatoric uncertainty: randomness in outcomes conditional on fixed parameters. In the simulation, this is <span class="in">`epsilon`</span>. Formally, if parameters are $\theta$, aleatoric uncertainty is the spread of $p(y\mid x,\theta)$ once we model the likelihood as $\mathcal{N}(0, \sigma^2)$. In our model, the parameter $\sigma$ explicitly captures aleatoric uncertainty: it quantifies the amount of outcome variability that remains even if all structural parameters $\theta$ were known exactly. It represents inherent unpredictability due to unobserved micro-variation, demand shocks, or logging noise. Even with infinite data, aleatoric uncertainty remains.</span>
<span id="cb49-491"><a href="#cb49-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-492"><a href="#cb49-492" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Epistemic uncertainty: uncertainty about the parameters and latent functions themselves due to limited or weakly informative data. This is the spread of the posterior $p(\theta\mid \text{data})$. It shrinks with more data, better priors, or richer experimental variation. In our model it includes carryover memory (adstock $\alpha$), saturation curvature and half-saturation (Michaelis–Menten $\alpha,\lambda$), trend slopes, and seasonal Fourier weights.</span>
<span id="cb49-493"><a href="#cb49-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-494"><a href="#cb49-494" aria-hidden="true" tabindex="-1"></a>Why this separation matters for planning:</span>
<span id="cb49-495"><a href="#cb49-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-496"><a href="#cb49-496" aria-hidden="true" tabindex="-1"></a>1) Outcome distribution under a plan. For a given allocation plan $b$ over channels and time, the posterior predictive is</span>
<span id="cb49-497"><a href="#cb49-497" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-498"><a href="#cb49-498" aria-hidden="true" tabindex="-1"></a>p\big(Y(b)\mid \text{data}\big) = \int p\big(Y(b)\mid \theta\big)\, p(\theta\mid \text{data})\, d\theta,</span>
<span id="cb49-499"><a href="#cb49-499" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-500"><a href="#cb49-500" aria-hidden="true" tabindex="-1"></a>which mixes aleatoric variability (the inner term) and epistemic variability (integration over $\theta$). Our Monte Carlo estimator samples $\theta^{(s)}$ from the posterior, simulates carryover and saturation under $b$, and draws predictive outcomes.</span>
<span id="cb49-501"><a href="#cb49-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-502"><a href="#cb49-502" aria-hidden="true" tabindex="-1"></a>2) Example: known vs unknown curvature. Suppose a channel’s saturation is well learned around historical spends but not beyond. Two plans with the same total spend differ in risk:</span>
<span id="cb49-503"><a href="#cb49-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-504"><a href="#cb49-504" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Plan A concentrates around the historical mode (epistemic low), yielding a narrow predictive distribution.</span>
<span id="cb49-505"><a href="#cb49-505" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Plan B pushes beyond observed spends (epistemic high), producing a wider distribution and heavier downside tails if the curve flattens earlier than hoped.</span>
<span id="cb49-506"><a href="#cb49-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-507"><a href="#cb49-507" aria-hidden="true" tabindex="-1"></a>During optimization, we focus on the second component —epistemic uncertainty— and can choose how much confidence we require around it. Once we choose an allocation, then we incorporate aleatoric uncertainty to quantify the total response distribution, if we want to.</span>
<span id="cb49-508"><a href="#cb49-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-509"><a href="#cb49-509" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🧭 Optimization</span></span>
<span id="cb49-510"><a href="#cb49-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-511"><a href="#cb49-511" aria-hidden="true" tabindex="-1"></a>Lets thing about our model and their outputs, starting with the posterior predictive distribution:</span>
<span id="cb49-512"><a href="#cb49-512" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-513"><a href="#cb49-513" aria-hidden="true" tabindex="-1"></a>p\big(Y(b)\mid \text{data}\big) = \int p\big(Y(b)\mid \theta\big)\, p(\theta\mid \text{data})\, d\theta</span>
<span id="cb49-514"><a href="#cb49-514" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-515"><a href="#cb49-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-516"><a href="#cb49-516" aria-hidden="true" tabindex="-1"></a>As you can see, the posterior predictive distribution incorporates both aleatoric and epistemic uncertainty, meaning, the optimization problem reduces to choosing an allocation $b$ that optimizes a scalar summary of this distribution.</span>
<span id="cb49-517"><a href="#cb49-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-518"><a href="#cb49-518" aria-hidden="true" tabindex="-1"></a>Formally, let $b \in \mathbb{R}^C$ denote a feasible allocation (e.g., channel budgets) with constraints</span>
<span id="cb49-519"><a href="#cb49-519" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-520"><a href="#cb49-520" aria-hidden="true" tabindex="-1"></a>\sum_{c=1}^C b_c = B, \qquad \underline{b}_c \leq b_c \leq \overline{b}_c.</span>
<span id="cb49-521"><a href="#cb49-521" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-522"><a href="#cb49-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-523"><a href="#cb49-523" aria-hidden="true" tabindex="-1"></a>For each candidate allocation $b$, we obtain Monte Carlo draws from the posterior predictive distribution:</span>
<span id="cb49-524"><a href="#cb49-524" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-525"><a href="#cb49-525" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>Y^{(s)}(b)<span class="sc">\}</span>_{s=1}^S \sim p(Y \mid \mathrm{do}(X=b), \mathcal{D}),</span>
<span id="cb49-526"><a href="#cb49-526" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-527"><a href="#cb49-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-528"><a href="#cb49-528" aria-hidden="true" tabindex="-1"></a>A statistic is then computed (for example, the mean, a quantile, a risk-adjusted score, or the mean tightness score). </span>
<span id="cb49-529"><a href="#cb49-529" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-530"><a href="#cb49-530" aria-hidden="true" tabindex="-1"></a>\phi<span class="sc">\!</span>\left(<span class="sc">\{</span>Y^{(s)}(b)<span class="sc">\}</span>\right)</span>
<span id="cb49-531"><a href="#cb49-531" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb49-532"><a href="#cb49-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-533"><a href="#cb49-533" aria-hidden="true" tabindex="-1"></a>By consequence, the optimization problem solved by SLSQP is simply</span>
<span id="cb49-534"><a href="#cb49-534" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-535"><a href="#cb49-535" aria-hidden="true" tabindex="-1"></a>\min_{b \in \mathcal{B}} J(b), \qquad J(b) = f<span class="sc">\!</span>\left(\phi(<span class="sc">\{</span>Y^{(s)}(b)<span class="sc">\}</span>)\right),</span>
<span id="cb49-536"><a href="#cb49-536" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-537"><a href="#cb49-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-538"><a href="#cb49-538" aria-hidden="true" tabindex="-1"></a>where $f$ is defined so the solver minimizes the chosen statistic from the posterior predictive distribution.  </span>
<span id="cb49-539"><a href="#cb49-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-540"><a href="#cb49-540" aria-hidden="true" tabindex="-1"></a>This formulation is flexible: by changing $\phi$, we can target risk-neutral or risk-sensitive criteria or even heuristics, while always grounding the decision in the posterior predictive distribution.</span>
<span id="cb49-541"><a href="#cb49-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-542"><a href="#cb49-542" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb49-543"><a href="#cb49-543" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Assumption notes</span></span>
<span id="cb49-544"><a href="#cb49-544" aria-hidden="true" tabindex="-1"></a>Why do we say do=$(X=b)$?</span>
<span id="cb49-545"><a href="#cb49-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-546"><a href="#cb49-546" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Structural invariance**: The response functions (trend, seasonality, adstock, saturation, link) are invariant under interventions $b$ over the optimization horizon.</span>
<span id="cb49-547"><a href="#cb49-547" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**No unmeasured confounding**: Conditional on included covariates and time controls, there are no unmeasured (especially time-varying) confounders affecting both spend and outcome; the backdoor criterion holds.</span>
<span id="cb49-548"><a href="#cb49-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-549"><a href="#cb49-549" aria-hidden="true" tabindex="-1"></a>We use $p\big(Y \mid \mathrm{do}(X=b), \mathcal{D}\big)$ as shorthand for the posterior predictive under these assumptions. When allocations move far outside support, results become extrapolative and should be treated as sensitivity analysis rather than identified effects.</span>
<span id="cb49-550"><a href="#cb49-550" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-551"><a href="#cb49-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-552"><a href="#cb49-552" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🛠️ Define the optimizer</span></span>
<span id="cb49-553"><a href="#cb49-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-554"><a href="#cb49-554" aria-hidden="true" tabindex="-1"></a>Initializing the optimizer is straightforward: pass the model and the date range.</span>
<span id="cb49-555"><a href="#cb49-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-558"><a href="#cb49-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-559"><a href="#cb49-559" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-560"><a href="#cb49-560" aria-hidden="true" tabindex="-1"></a>optimizable_model <span class="op">=</span> MultiDimensionalBudgetOptimizerWrapper(</span>
<span id="cb49-561"><a href="#cb49-561" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>mmm, </span>
<span id="cb49-562"><a href="#cb49-562" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span>df_test.date_week.<span class="bu">min</span>().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>), </span>
<span id="cb49-563"><a href="#cb49-563" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span>df_test.date_week.<span class="bu">max</span>().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb49-564"><a href="#cb49-564" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-565"><a href="#cb49-565" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Start date: </span><span class="sc">{</span>optimizable_model<span class="sc">.</span>start_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-566"><a href="#cb49-566" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"End date: </span><span class="sc">{</span>optimizable_model<span class="sc">.</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-567"><a href="#cb49-567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-568"><a href="#cb49-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-569"><a href="#cb49-569" aria-hidden="true" tabindex="-1"></a>We'll use the test set to define the budget and optimization period so we can compare the resulting allocation to our current plan.</span>
<span id="cb49-572"><a href="#cb49-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-573"><a href="#cb49-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false </span></span>
<span id="cb49-574"><a href="#cb49-574" aria-hidden="true" tabindex="-1"></a>channels <span class="op">=</span> [<span class="st">"x1_original_scale"</span>, <span class="st">"x2_original_scale"</span>, <span class="st">"x3_original_scale"</span>, <span class="st">"x4_original_scale"</span>]</span>
<span id="cb49-575"><a href="#cb49-575" aria-hidden="true" tabindex="-1"></a>num_periods <span class="op">=</span> optimizable_model.num_periods</span>
<span id="cb49-576"><a href="#cb49-576" aria-hidden="true" tabindex="-1"></a>time_unit_budget <span class="op">=</span> df_test[channels].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb49-577"><a href="#cb49-577" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total budget to allocate: </span><span class="sc">{</span>num_periods <span class="op">*</span> time_unit_budget<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb49-578"><a href="#cb49-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-579"><a href="#cb49-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-580"><a href="#cb49-580" aria-hidden="true" tabindex="-1"></a>Given the budget and channels, we can estimate the response for our initial plan.</span>
<span id="cb49-581"><a href="#cb49-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-584"><a href="#cb49-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-585"><a href="#cb49-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-586"><a href="#cb49-586" aria-hidden="true" tabindex="-1"></a>initial_budget <span class="op">=</span> df_test[channels].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>).to_xarray().rename({<span class="st">"index"</span>:<span class="st">"channel"</span>})</span>
<span id="cb49-587"><a href="#cb49-587" aria-hidden="true" tabindex="-1"></a>initial_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb49-588"><a href="#cb49-588" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>initial_budget,</span>
<span id="cb49-589"><a href="#cb49-589" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-590"><a href="#cb49-590" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-591"><a href="#cb49-591" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb49-592"><a href="#cb49-592" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-593"><a href="#cb49-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-594"><a href="#cb49-594" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> optimizable_model.plot.budget_allocation(</span>
<span id="cb49-595"><a href="#cb49-595" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">=</span>initial_posterior_response,</span>
<span id="cb49-596"><a href="#cb49-596" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb49-597"><a href="#cb49-597" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-598"><a href="#cb49-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-599"><a href="#cb49-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-600"><a href="#cb49-600" aria-hidden="true" tabindex="-1"></a>The bar chart shows allocation and response per channel. To see totals, we can sum and create a simple scatter plot with a label for the ROAS.</span>
<span id="cb49-601"><a href="#cb49-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-604"><a href="#cb49-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-605"><a href="#cb49-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-606"><a href="#cb49-606" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatterplot with spend and mean response</span></span>
<span id="cb49-607"><a href="#cb49-607" aria-hidden="true" tabindex="-1"></a>spend <span class="op">=</span> initial_posterior_response.allocation.<span class="bu">sum</span>().values</span>
<span id="cb49-608"><a href="#cb49-608" aria-hidden="true" tabindex="-1"></a>mean_response <span class="op">=</span> initial_posterior_response.total_media_contribution_original_scale.mean(dim<span class="op">=</span><span class="st">'sample'</span>).values</span>
<span id="cb49-609"><a href="#cb49-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-610"><a href="#cb49-610" aria-hidden="true" tabindex="-1"></a>initial_roas <span class="op">=</span> mean_response <span class="op">/</span> spend</span>
<span id="cb49-611"><a href="#cb49-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-612"><a href="#cb49-612" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, label<span class="op">=</span><span class="ss">f"ROAS: </span><span class="sc">{</span>initial_roas<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb49-613"><a href="#cb49-613" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Spend'</span>)</span>
<span id="cb49-614"><a href="#cb49-614" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean Response'</span>)</span>
<span id="cb49-615"><a href="#cb49-615" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Spend vs Mean Response'</span>)</span>
<span id="cb49-616"><a href="#cb49-616" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb49-617"><a href="#cb49-617" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="st">'small'</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb49-618"><a href="#cb49-618" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-619"><a href="#cb49-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-620"><a href="#cb49-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-621"><a href="#cb49-621" aria-hidden="true" tabindex="-1"></a>We got a ROAS of $3.9$ for the initial plan, which is below our target ROAS (let's say $8$). Now we run a vanilla optimization to maximize mean response: can we reallocate to achieve a higher response given the same budget?</span>
<span id="cb49-622"><a href="#cb49-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-625"><a href="#cb49-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-626"><a href="#cb49-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-627"><a href="#cb49-627" aria-hidden="true" tabindex="-1"></a>allocation_strategy, optimization_result <span class="op">=</span> optimizable_model.optimize_budget(</span>
<span id="cb49-628"><a href="#cb49-628" aria-hidden="true" tabindex="-1"></a>    budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb49-629"><a href="#cb49-629" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-630"><a href="#cb49-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-631"><a href="#cb49-631" aria-hidden="true" tabindex="-1"></a>naive_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb49-632"><a href="#cb49-632" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>allocation_strategy,</span>
<span id="cb49-633"><a href="#cb49-633" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-634"><a href="#cb49-634" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-635"><a href="#cb49-635" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb49-636"><a href="#cb49-636" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-637"><a href="#cb49-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-638"><a href="#cb49-638" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb49-639"><a href="#cb49-639" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb49-640"><a href="#cb49-640" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb49-641"><a href="#cb49-641" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>naive_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb49-642"><a href="#cb49-642" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-643"><a href="#cb49-643" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb49-644"><a href="#cb49-644" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(naive_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb49-645"><a href="#cb49-645" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-646"><a href="#cb49-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-647"><a href="#cb49-647" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> optimizable_model.plot.budget_allocation(</span>
<span id="cb49-648"><a href="#cb49-648" aria-hidden="true" tabindex="-1"></a>    samples<span class="op">=</span>naive_posterior_response,</span>
<span id="cb49-649"><a href="#cb49-649" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb49-650"><a href="#cb49-650" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-651"><a href="#cb49-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-652"><a href="#cb49-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-653"><a href="#cb49-653" aria-hidden="true" tabindex="-1"></a>Yes, we can allocate to achieve a higher response. Let's compare the optimized response against the baseline plan.</span>
<span id="cb49-654"><a href="#cb49-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-657"><a href="#cb49-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-658"><a href="#cb49-658" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-659"><a href="#cb49-659" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatterplot with spend and mean response</span></span>
<span id="cb49-660"><a href="#cb49-660" aria-hidden="true" tabindex="-1"></a>mean_response_v2 <span class="op">=</span> naive_posterior_response.total_media_contribution_original_scale.mean(dim<span class="op">=</span><span class="st">'sample'</span>).values</span>
<span id="cb49-661"><a href="#cb49-661" aria-hidden="true" tabindex="-1"></a>roas_v2 <span class="op">=</span> mean_response_v2 <span class="op">/</span> spend</span>
<span id="cb49-662"><a href="#cb49-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-663"><a href="#cb49-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the delta in response</span></span>
<span id="cb49-664"><a href="#cb49-664" aria-hidden="true" tabindex="-1"></a>response_delta <span class="op">=</span> mean_response_v2.<span class="bu">sum</span>() <span class="op">-</span> mean_response.<span class="bu">sum</span>()</span>
<span id="cb49-665"><a href="#cb49-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-666"><a href="#cb49-666" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response_v2, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation (+</span><span class="sc">{</span>response_delta<span class="sc">:.1f}</span><span class="ss"> response, ROAS: </span><span class="sc">{</span>roas_v2<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb49-667"><a href="#cb49-667" aria-hidden="true" tabindex="-1"></a>plt.scatter(spend, mean_response, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">100</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Guessed allocation"</span>)</span>
<span id="cb49-668"><a href="#cb49-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-669"><a href="#cb49-669" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Spend'</span>)</span>
<span id="cb49-670"><a href="#cb49-670" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Mean Response'</span>)</span>
<span id="cb49-671"><a href="#cb49-671" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Spend vs Mean Response'</span>)</span>
<span id="cb49-672"><a href="#cb49-672" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb49-673"><a href="#cb49-673" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="st">'small'</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb49-674"><a href="#cb49-674" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-675"><a href="#cb49-675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-676"><a href="#cb49-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-677"><a href="#cb49-677" aria-hidden="true" tabindex="-1"></a>The optimized allocation is ~$500$ units higher than the guessed allocation, and the new estimated ROAS is $13$ which it's over our expectations. As consequence, we assume we'll get an estimate Y revenue in the next N periods and planning against this incoming cashflow we'll get back.</span>
<span id="cb49-678"><a href="#cb49-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-679"><a href="#cb49-679" aria-hidden="true" tabindex="-1"></a>The plotwist? We got a lower response, which mean a lower ROAS and we got in serious financial problems because we don't have enough cash to payback providers or services.</span>
<span id="cb49-680"><a href="#cb49-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-681"><a href="#cb49-681" aria-hidden="true" tabindex="-1"></a>Why this happen? Maximizing the mean response is risk-neutral. It often reallocates budget toward regions with potential high returns even if they are weakly identified, increasing dispersion of outcomes. This is rational when stakeholders are indifferent to risk. However, that's not the case for every company. Sometimes our stakeholders need to know how certain we are about expected outcomes.</span>
<span id="cb49-682"><a href="#cb49-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-683"><a href="#cb49-683" aria-hidden="true" tabindex="-1"></a>By inspecting posterior predictive samples under each allocation, we can quantify uncertainty and answer this question, based on the model current understanding.</span>
<span id="cb49-684"><a href="#cb49-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-685"><a href="#cb49-685" aria-hidden="true" tabindex="-1"></a>Let's plot the response distributions for both baseline and optimized allocations.</span>
<span id="cb49-686"><a href="#cb49-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-689"><a href="#cb49-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-690"><a href="#cb49-690" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-691"><a href="#cb49-691" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-692"><a href="#cb49-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-693"><a href="#cb49-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb49-694"><a href="#cb49-694" aria-hidden="true" tabindex="-1"></a>optimized_values <span class="op">=</span> naive_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb49-695"><a href="#cb49-695" aria-hidden="true" tabindex="-1"></a>guessed_values <span class="op">=</span> initial_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb49-696"><a href="#cb49-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-697"><a href="#cb49-697" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-698"><a href="#cb49-698" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-699"><a href="#cb49-699" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb49-700"><a href="#cb49-700" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb49-701"><a href="#cb49-701" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb49-702"><a href="#cb49-702" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-703"><a href="#cb49-703" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-704"><a href="#cb49-704" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-705"><a href="#cb49-705" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb49-706"><a href="#cb49-706" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb49-707"><a href="#cb49-707" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb49-708"><a href="#cb49-708" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-709"><a href="#cb49-709" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-710"><a href="#cb49-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-711"><a href="#cb49-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb49-712"><a href="#cb49-712" aria-hidden="true" tabindex="-1"></a>optimized_mean <span class="op">=</span> optimized_values.mean()</span>
<span id="cb49-713"><a href="#cb49-713" aria-hidden="true" tabindex="-1"></a>guessed_mean <span class="op">=</span> guessed_values.mean()</span>
<span id="cb49-714"><a href="#cb49-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-715"><a href="#cb49-715" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-716"><a href="#cb49-716" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-717"><a href="#cb49-717" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-718"><a href="#cb49-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-719"><a href="#cb49-719" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb49-720"><a href="#cb49-720" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb49-721"><a href="#cb49-721" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-722"><a href="#cb49-722" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-723"><a href="#cb49-723" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-724"><a href="#cb49-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-725"><a href="#cb49-725" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb49-726"><a href="#cb49-726" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-727"><a href="#cb49-727" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-728"><a href="#cb49-728" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-729"><a href="#cb49-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-730"><a href="#cb49-730" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb49-731"><a href="#cb49-731" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb49-732"><a href="#cb49-732" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-733"><a href="#cb49-733" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-734"><a href="#cb49-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-735"><a href="#cb49-735" aria-hidden="true" tabindex="-1"></a>As expected, the means differ (we optimized to increase it), and so does the certainty around the mean. Like an excersise, lets observe how probable is to get a response higher and lower than the mean.</span>
<span id="cb49-736"><a href="#cb49-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-739"><a href="#cb49-739" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-740"><a href="#cb49-740" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-741"><a href="#cb49-741" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb49-742"><a href="#cb49-742" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb49-743"><a href="#cb49-743" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>default_figsize,</span>
<span id="cb49-744"><a href="#cb49-744" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>optimized_mean,</span>
<span id="cb49-745"><a href="#cb49-745" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-746"><a href="#cb49-746" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-747"><a href="#cb49-747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-748"><a href="#cb49-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-749"><a href="#cb49-749" aria-hidden="true" tabindex="-1"></a>This makes everything clear now, the chances of getting some higher or equal than the mean where 43% but the chances of getting some lower than the mean where 56%. It's no surprise that we got a lower response and a lower ROAS.</span>
<span id="cb49-750"><a href="#cb49-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-751"><a href="#cb49-751" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon=false}</span>
<span id="cb49-752"><a href="#cb49-752" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 First Takeaway</span></span>
<span id="cb49-753"><a href="#cb49-753" aria-hidden="true" tabindex="-1"></a>Comparing full distributions makes risk transparent: width quantifies forecast reliability, skewness reveals asymmetry of upside vs downside, and overlaps show practical indistinguishability. </span>
<span id="cb49-754"><a href="#cb49-754" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-755"><a href="#cb49-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-756"><a href="#cb49-756" aria-hidden="true" tabindex="-1"></a>Where this risk is coming from? The new allocation is riskier, but why? Let's look at each spend level relative to its saturation curve.</span>
<span id="cb49-759"><a href="#cb49-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-760"><a href="#cb49-760" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-761"><a href="#cb49-761" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb49-762"><a href="#cb49-762" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">10</span></span>
<span id="cb49-763"><a href="#cb49-763" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-764"><a href="#cb49-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-765"><a href="#cb49-765" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb49-766"><a href="#cb49-766" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb49-767"><a href="#cb49-767" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-768"><a href="#cb49-768" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb49-769"><a href="#cb49-769" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb49-770"><a href="#cb49-770" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb49-771"><a href="#cb49-771" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb49-772"><a href="#cb49-772" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb49-773"><a href="#cb49-773" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-774"><a href="#cb49-774" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-775"><a href="#cb49-775" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-776"><a href="#cb49-776" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-777"><a href="#cb49-777" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb49-778"><a href="#cb49-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-779"><a href="#cb49-779" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-780"><a href="#cb49-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-781"><a href="#cb49-781" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for optimal allocation on each subplot</span></span>
<span id="cb49-782"><a href="#cb49-782" aria-hidden="true" tabindex="-1"></a>allocation_values <span class="op">=</span> naive_posterior_response.allocation.values</span>
<span id="cb49-783"><a href="#cb49-783" aria-hidden="true" tabindex="-1"></a>channel_names <span class="op">=</span> naive_posterior_response.allocation.channel.values</span>
<span id="cb49-784"><a href="#cb49-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-785"><a href="#cb49-785" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, allocation_value) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes.ravel(), allocation_values)):</span>
<span id="cb49-786"><a href="#cb49-786" aria-hidden="true" tabindex="-1"></a>    ax.axvline(allocation_value, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Optimal allocation"</span>)</span>
<span id="cb49-787"><a href="#cb49-787" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb49-788"><a href="#cb49-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-789"><a href="#cb49-789" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-790"><a href="#cb49-790" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb49-791"><a href="#cb49-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-792"><a href="#cb49-792" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-793"><a href="#cb49-793" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-794"><a href="#cb49-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-795"><a href="#cb49-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-796"><a href="#cb49-796" aria-hidden="true" tabindex="-1"></a>Vertical lines are located at the spend allocation given for each channel. For channels as x4, the model has few observations at those spend levels, so posterior bands are wide and the induced response distribution is diffuse. Risk-aware optimization tends to pull spend toward well-identified regions (often near inflection), trading a small mean decrease for a large reduction in variance.</span>
<span id="cb49-797"><a href="#cb49-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-798"><a href="#cb49-798" aria-hidden="true" tabindex="-1"></a>Could we understand this in advance? and if so, would we prefer a different type of allocation? Which get us closer to our objective in a safer way? -A narrower distribution with a slightly lower mean can be preferable when shortfall risk is costly-.</span>
<span id="cb49-799"><a href="#cb49-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-800"><a href="#cb49-800" aria-hidden="true" tabindex="-1"></a>The short answer is **definetly**. Let's create now a new optimization process that will be risk-aware. </span>
<span id="cb49-801"><a href="#cb49-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-802"><a href="#cb49-802" aria-hidden="true" tabindex="-1"></a><span class="fu"># ⚖️ Risk metrics consistent with PyMC-Marketing</span></span>
<span id="cb49-803"><a href="#cb49-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-804"><a href="#cb49-804" aria-hidden="true" tabindex="-1"></a>Below are the definitions of two risk-aware metrics as implemented in the PyMC-Marketing library.</span>
<span id="cb49-805"><a href="#cb49-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-806"><a href="#cb49-806" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb49-807"><a href="#cb49-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-808"><a href="#cb49-808" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🌪️ Tail Distance</span></span>
<span id="cb49-809"><a href="#cb49-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-810"><a href="#cb49-810" aria-hidden="true" tabindex="-1"></a>For a confidence level $\gamma \in (0,1)$,</span>
<span id="cb49-811"><a href="#cb49-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-812"><a href="#cb49-812" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-813"><a href="#cb49-813" aria-hidden="true" tabindex="-1"></a>\operatorname{TailDistance}_\gamma(Y) \;=\; </span>
<span id="cb49-814"><a href="#cb49-814" aria-hidden="true" tabindex="-1"></a>\big|Q_{1-\gamma}(Y) - \mu\big| \;+\; \big|\mu - Q_{\gamma}(Y)\big|,</span>
<span id="cb49-815"><a href="#cb49-815" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-816"><a href="#cb49-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-817"><a href="#cb49-817" aria-hidden="true" tabindex="-1"></a>where </span>
<span id="cb49-818"><a href="#cb49-818" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu = \mathbb{E}<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$ is the mean (estimated by the sample mean),  </span>
<span id="cb49-819"><a href="#cb49-819" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Q_q(Y)$ is the $q$-th quantile of the distribution of $Y$.</span>
<span id="cb49-820"><a href="#cb49-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-821"><a href="#cb49-821" aria-hidden="true" tabindex="-1"></a>This metric measures the **spread of the distribution's tails around the mean**.  </span>
<span id="cb49-822"><a href="#cb49-822" aria-hidden="true" tabindex="-1"></a>Larger values indicate wider tails and thus higher uncertainty.</span>
<span id="cb49-823"><a href="#cb49-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-824"><a href="#cb49-824" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb49-825"><a href="#cb49-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-826"><a href="#cb49-826" aria-hidden="true" tabindex="-1"></a><span class="fu">## 🎯 Mean Tightness Score (MTS)</span></span>
<span id="cb49-827"><a href="#cb49-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-828"><a href="#cb49-828" aria-hidden="true" tabindex="-1"></a>The Mean Tightness Score combines the mean with a penalty for tail spread:</span>
<span id="cb49-829"><a href="#cb49-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-830"><a href="#cb49-830" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-831"><a href="#cb49-831" aria-hidden="true" tabindex="-1"></a>\operatorname{MTS}(Y; \alpha, \gamma) \;=\; </span>
<span id="cb49-832"><a href="#cb49-832" aria-hidden="true" tabindex="-1"></a>\mu \;-\; \alpha \cdot \operatorname{TailDistance}_\gamma(Y),</span>
<span id="cb49-833"><a href="#cb49-833" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb49-834"><a href="#cb49-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-835"><a href="#cb49-835" aria-hidden="true" tabindex="-1"></a>where </span>
<span id="cb49-836"><a href="#cb49-836" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu = \mathbb{E}<span class="co">[</span><span class="ot">Y</span><span class="co">]</span>$ is the mean,  </span>
<span id="cb49-837"><a href="#cb49-837" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\gamma$ is the confidence level used for the tail distance,  </span>
<span id="cb49-838"><a href="#cb49-838" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\alpha &gt; 0$ is a penalty weight that controls the trade-off between higher mean and tighter distribution.</span>
<span id="cb49-839"><a href="#cb49-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-840"><a href="#cb49-840" aria-hidden="true" tabindex="-1"></a>Interpretation:  </span>
<span id="cb49-841"><a href="#cb49-841" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Higher is better:** Allocations with higher means and smaller dispersion score better.  This provides a balance between risk-neutral (maximize mean) and risk-averse (penalize uncertainty) optimization.</span>
<span id="cb49-842"><a href="#cb49-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-843"><a href="#cb49-843" aria-hidden="true" tabindex="-1"></a>Let's optimize with the Mean Tightness Score and see the resulting allocation.</span>
<span id="cb49-844"><a href="#cb49-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-847"><a href="#cb49-847" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-848"><a href="#cb49-848" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-849"><a href="#cb49-849" aria-hidden="true" tabindex="-1"></a>mts_budget_allocation, mts_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb49-850"><a href="#cb49-850" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb49-851"><a href="#cb49-851" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb49-852"><a href="#cb49-852" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>ut.mean_tightness_score(alpha<span class="op">=</span><span class="fl">0.15</span>),</span>
<span id="cb49-853"><a href="#cb49-853" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-854"><a href="#cb49-854" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>, <span class="st">"ftol"</span>: <span class="fl">1e-16</span>}},</span>
<span id="cb49-855"><a href="#cb49-855" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-856"><a href="#cb49-856" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-857"><a href="#cb49-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-858"><a href="#cb49-858" aria-hidden="true" tabindex="-1"></a>mts_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb49-859"><a href="#cb49-859" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>mts_budget_allocation,</span>
<span id="cb49-860"><a href="#cb49-860" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-861"><a href="#cb49-861" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-862"><a href="#cb49-862" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb49-863"><a href="#cb49-863" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-864"><a href="#cb49-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-865"><a href="#cb49-865" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb49-866"><a href="#cb49-866" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb49-867"><a href="#cb49-867" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb49-868"><a href="#cb49-868" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb49-869"><a href="#cb49-869" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>mts_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb49-870"><a href="#cb49-870" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-871"><a href="#cb49-871" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb49-872"><a href="#cb49-872" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(mts_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb49-873"><a href="#cb49-873" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-874"><a href="#cb49-874" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-875"><a href="#cb49-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-876"><a href="#cb49-876" aria-hidden="true" tabindex="-1"></a>Great, it looks like the allocation shifts toward better-identified regions. Let's plot the saturation curves to see where the allocation lands.</span>
<span id="cb49-879"><a href="#cb49-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-880"><a href="#cb49-880" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-881"><a href="#cb49-881" aria-hidden="true" tabindex="-1"></a>curve <span class="op">=</span> mmm.saturation.sample_curve(</span>
<span id="cb49-882"><a href="#cb49-882" aria-hidden="true" tabindex="-1"></a>    mmm.idata.posterior[[<span class="st">"saturation_alpha"</span>, <span class="st">"saturation_lam"</span>]], max_value<span class="op">=</span><span class="dv">4</span></span>
<span id="cb49-883"><a href="#cb49-883" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-884"><a href="#cb49-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-885"><a href="#cb49-885" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> mmm.plot.saturation_curves(</span>
<span id="cb49-886"><a href="#cb49-886" aria-hidden="true" tabindex="-1"></a>    curve,</span>
<span id="cb49-887"><a href="#cb49-887" aria-hidden="true" tabindex="-1"></a>    original_scale<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-888"><a href="#cb49-888" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb49-889"><a href="#cb49-889" aria-hidden="true" tabindex="-1"></a>    hdi_probs<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb49-890"><a href="#cb49-890" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span>rng,</span>
<span id="cb49-891"><a href="#cb49-891" aria-hidden="true" tabindex="-1"></a>    subplot_kwargs<span class="op">=</span>{<span class="st">"figsize"</span>: default_figsize, <span class="st">"ncols"</span>: <span class="dv">4</span>, <span class="st">"sharey"</span>: <span class="va">True</span>},</span>
<span id="cb49-892"><a href="#cb49-892" aria-hidden="true" tabindex="-1"></a>    rc_params<span class="op">=</span>{</span>
<span id="cb49-893"><a href="#cb49-893" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-894"><a href="#cb49-894" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-895"><a href="#cb49-895" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-896"><a href="#cb49-896" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">10</span>,</span>
<span id="cb49-897"><a href="#cb49-897" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb49-898"><a href="#cb49-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-899"><a href="#cb49-899" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-900"><a href="#cb49-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-901"><a href="#cb49-901" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for optimal allocation on each subplot</span></span>
<span id="cb49-902"><a href="#cb49-902" aria-hidden="true" tabindex="-1"></a>allocation_values <span class="op">=</span> mts_posterior_response.allocation.values</span>
<span id="cb49-903"><a href="#cb49-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-904"><a href="#cb49-904" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, allocation_value) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes.ravel(), allocation_values)):</span>
<span id="cb49-905"><a href="#cb49-905" aria-hidden="true" tabindex="-1"></a>    ax.axvline(allocation_value, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Optimal allocation"</span>)</span>
<span id="cb49-906"><a href="#cb49-906" aria-hidden="true" tabindex="-1"></a>    ax.title.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb49-907"><a href="#cb49-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-908"><a href="#cb49-908" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fig._suptitle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-909"><a href="#cb49-909" aria-hidden="true" tabindex="-1"></a>    fig._suptitle.set_fontsize(<span class="dv">12</span>)</span>
<span id="cb49-910"><a href="#cb49-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-911"><a href="#cb49-911" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-912"><a href="#cb49-912" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-913"><a href="#cb49-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-914"><a href="#cb49-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-915"><a href="#cb49-915" aria-hidden="true" tabindex="-1"></a>As expected, recommendations for every channel lie in well-known regions.</span>
<span id="cb49-916"><a href="#cb49-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-917"><a href="#cb49-917" aria-hidden="true" tabindex="-1"></a>The consequence: the posterior distribution narrows because budget concentrates in well-learned, less-nonlinear regions.</span>
<span id="cb49-918"><a href="#cb49-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-919"><a href="#cb49-919" aria-hidden="true" tabindex="-1"></a>Let's plot posterior distributions for this lower-risk allocation.</span>
<span id="cb49-920"><a href="#cb49-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-923"><a href="#cb49-923" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-924"><a href="#cb49-924" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-925"><a href="#cb49-925" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-926"><a href="#cb49-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-927"><a href="#cb49-927" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb49-928"><a href="#cb49-928" aria-hidden="true" tabindex="-1"></a>optimized_risk_values <span class="op">=</span> mts_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb49-929"><a href="#cb49-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-930"><a href="#cb49-930" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-931"><a href="#cb49-931" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-932"><a href="#cb49-932" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb49-933"><a href="#cb49-933" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb49-934"><a href="#cb49-934" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb49-935"><a href="#cb49-935" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-936"><a href="#cb49-936" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-937"><a href="#cb49-937" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-938"><a href="#cb49-938" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb49-939"><a href="#cb49-939" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb49-940"><a href="#cb49-940" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb49-941"><a href="#cb49-941" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-942"><a href="#cb49-942" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-943"><a href="#cb49-943" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-944"><a href="#cb49-944" aria-hidden="true" tabindex="-1"></a>    optimized_risk_values,</span>
<span id="cb49-945"><a href="#cb49-945" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb49-946"><a href="#cb49-946" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Risk-adjusted allocation"</span>,</span>
<span id="cb49-947"><a href="#cb49-947" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-948"><a href="#cb49-948" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-949"><a href="#cb49-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-950"><a href="#cb49-950" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb49-951"><a href="#cb49-951" aria-hidden="true" tabindex="-1"></a>risk_adjusted_mean <span class="op">=</span> optimized_risk_values.mean()</span>
<span id="cb49-952"><a href="#cb49-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-953"><a href="#cb49-953" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-954"><a href="#cb49-954" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-955"><a href="#cb49-955" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-956"><a href="#cb49-956" aria-hidden="true" tabindex="-1"></a>ax.axvline(risk_adjusted_mean, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-957"><a href="#cb49-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-958"><a href="#cb49-958" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb49-959"><a href="#cb49-959" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb49-960"><a href="#cb49-960" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-961"><a href="#cb49-961" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-962"><a href="#cb49-962" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-963"><a href="#cb49-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-964"><a href="#cb49-964" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb49-965"><a href="#cb49-965" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-966"><a href="#cb49-966" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-967"><a href="#cb49-967" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-968"><a href="#cb49-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-969"><a href="#cb49-969" aria-hidden="true" tabindex="-1"></a>ax.text(risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.4</span>, </span>
<span id="cb49-970"><a href="#cb49-970" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-971"><a href="#cb49-971" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightgreen"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-972"><a href="#cb49-972" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-973"><a href="#cb49-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-974"><a href="#cb49-974" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb49-975"><a href="#cb49-975" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb49-976"><a href="#cb49-976" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-977"><a href="#cb49-977" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-978"><a href="#cb49-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-979"><a href="#cb49-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-980"><a href="#cb49-980" aria-hidden="true" tabindex="-1"></a>This makes it clear: we gained much more certainty—a risk-averse (lower-variance) response distribution. You may be thinking that playing in known regions tends to reduce the mean. Do you want to know why?</span>
<span id="cb49-981"><a href="#cb49-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-982"><a href="#cb49-982" aria-hidden="true" tabindex="-1"></a>Posterior response curves tend to be more certain at the origin because two sources of uncertainty are minimized there: structurally, we know that zero spend produces zero incremental effect, and empirically, the lowest spend region is often well supported in historical data. As spend increases, especially beyond historically observed levels, epistemic uncertainty about the saturation and curvature parameters dominates, widening the credible intervals.</span>
<span id="cb49-983"><a href="#cb49-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-984"><a href="#cb49-984" aria-hidden="true" tabindex="-1"></a>Does that mean we are doomed to lower values if we want certainty? Not at all, we can change the utility to prefer riskier options 🔥.</span>
<span id="cb49-985"><a href="#cb49-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-986"><a href="#cb49-986" aria-hidden="true" tabindex="-1"></a>Let's run a more risk-seeking allocation 👀</span>
<span id="cb49-987"><a href="#cb49-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-990"><a href="#cb49-990" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-991"><a href="#cb49-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-992"><a href="#cb49-992" aria-hidden="true" tabindex="-1"></a>inverse_mts_budget_allocation, inverse_mts_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb49-993"><a href="#cb49-993" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb49-994"><a href="#cb49-994" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb49-995"><a href="#cb49-995" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>ut.mean_tightness_score(alpha<span class="op">=</span><span class="fl">0.95</span>),</span>
<span id="cb49-996"><a href="#cb49-996" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-997"><a href="#cb49-997" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>, <span class="st">"ftol"</span>: <span class="fl">1e-16</span>}},</span>
<span id="cb49-998"><a href="#cb49-998" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-999"><a href="#cb49-999" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1000"><a href="#cb49-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1001"><a href="#cb49-1001" aria-hidden="true" tabindex="-1"></a>inverse_mts_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb49-1002"><a href="#cb49-1002" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>inverse_mts_budget_allocation,</span>
<span id="cb49-1003"><a href="#cb49-1003" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-1004"><a href="#cb49-1004" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-1005"><a href="#cb49-1005" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb49-1006"><a href="#cb49-1006" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1007"><a href="#cb49-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1008"><a href="#cb49-1008" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb49-1009"><a href="#cb49-1009" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb49-1010"><a href="#cb49-1010" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb49-1011"><a href="#cb49-1011" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb49-1012"><a href="#cb49-1012" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>inverse_mts_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb49-1013"><a href="#cb49-1013" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-1014"><a href="#cb49-1014" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb49-1015"><a href="#cb49-1015" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(inverse_mts_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb49-1016"><a href="#cb49-1016" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1017"><a href="#cb49-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1018"><a href="#cb49-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1019"><a href="#cb49-1019" aria-hidden="true" tabindex="-1"></a>Flipping the tightness preference (alpha parameter) induces risk-seeking behavior, moving allocations toward higher-variance, high-upside regions.</span>
<span id="cb49-1020"><a href="#cb49-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1021"><a href="#cb49-1021" aria-hidden="true" tabindex="-1"></a>Now we choose an allocation that is less certain but with higher potential upside than the baseline. Let's plot the response distributions. </span>
<span id="cb49-1022"><a href="#cb49-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1023"><a href="#cb49-1023" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon=false}</span>
<span id="cb49-1024"><a href="#cb49-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Second Takeaway</span></span>
<span id="cb49-1025"><a href="#cb49-1025" aria-hidden="true" tabindex="-1"></a>Discover your risk preferences and adjust your objective function to reflect them. You don't need to commit to a single function or approach, you can build a custom one which tailor your needs.</span>
<span id="cb49-1026"><a href="#cb49-1026" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-1027"><a href="#cb49-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1030"><a href="#cb49-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1031"><a href="#cb49-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1032"><a href="#cb49-1032" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-1033"><a href="#cb49-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1034"><a href="#cb49-1034" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the values</span></span>
<span id="cb49-1035"><a href="#cb49-1035" aria-hidden="true" tabindex="-1"></a>optimized_inverse_risk_values <span class="op">=</span> inverse_mts_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb49-1036"><a href="#cb49-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1037"><a href="#cb49-1037" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-1038"><a href="#cb49-1038" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-1039"><a href="#cb49-1039" aria-hidden="true" tabindex="-1"></a>    optimized_values,</span>
<span id="cb49-1040"><a href="#cb49-1040" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb49-1041"><a href="#cb49-1041" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Optimized allocation"</span>,</span>
<span id="cb49-1042"><a href="#cb49-1042" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-1043"><a href="#cb49-1043" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1044"><a href="#cb49-1044" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-1045"><a href="#cb49-1045" aria-hidden="true" tabindex="-1"></a>    guessed_values,</span>
<span id="cb49-1046"><a href="#cb49-1046" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb49-1047"><a href="#cb49-1047" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Guessed allocation"</span>,</span>
<span id="cb49-1048"><a href="#cb49-1048" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-1049"><a href="#cb49-1049" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1050"><a href="#cb49-1050" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-1051"><a href="#cb49-1051" aria-hidden="true" tabindex="-1"></a>    optimized_risk_values,</span>
<span id="cb49-1052"><a href="#cb49-1052" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb49-1053"><a href="#cb49-1053" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Risk-adjusted allocation"</span>,</span>
<span id="cb49-1054"><a href="#cb49-1054" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-1055"><a href="#cb49-1055" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1056"><a href="#cb49-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1057"><a href="#cb49-1057" aria-hidden="true" tabindex="-1"></a>az.plot_dist(</span>
<span id="cb49-1058"><a href="#cb49-1058" aria-hidden="true" tabindex="-1"></a>    optimized_inverse_risk_values,</span>
<span id="cb49-1059"><a href="#cb49-1059" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb49-1060"><a href="#cb49-1060" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Inverse Risk-adjusted allocation"</span>,</span>
<span id="cb49-1061"><a href="#cb49-1061" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb49-1062"><a href="#cb49-1062" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1063"><a href="#cb49-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1064"><a href="#cb49-1064" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate means</span></span>
<span id="cb49-1065"><a href="#cb49-1065" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_mean <span class="op">=</span> optimized_inverse_risk_values.mean()</span>
<span id="cb49-1066"><a href="#cb49-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1067"><a href="#cb49-1067" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-1068"><a href="#cb49-1068" aria-hidden="true" tabindex="-1"></a>ax.axvline(optimized_mean, color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-1069"><a href="#cb49-1069" aria-hidden="true" tabindex="-1"></a>ax.axvline(guessed_mean, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-1070"><a href="#cb49-1070" aria-hidden="true" tabindex="-1"></a>ax.axvline(risk_adjusted_mean, color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-1071"><a href="#cb49-1071" aria-hidden="true" tabindex="-1"></a>ax.axvline(inverse_risk_adjusted_mean, color<span class="op">=</span><span class="st">"orange"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb49-1072"><a href="#cb49-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1073"><a href="#cb49-1073" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text boxes with mean values</span></span>
<span id="cb49-1074"><a href="#cb49-1074" aria-hidden="true" tabindex="-1"></a>ax.text(optimized_mean <span class="op">+</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.8</span>, </span>
<span id="cb49-1075"><a href="#cb49-1075" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Optimized Mean:</span><span class="ch">\n</span><span class="sc">{</span>optimized_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-1076"><a href="#cb49-1076" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-1077"><a href="#cb49-1077" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-1078"><a href="#cb49-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1079"><a href="#cb49-1079" aria-hidden="true" tabindex="-1"></a>ax.text(guessed_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span>, </span>
<span id="cb49-1080"><a href="#cb49-1080" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Guessed Mean:</span><span class="ch">\n</span><span class="sc">{</span>guessed_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-1081"><a href="#cb49-1081" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightcoral"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-1082"><a href="#cb49-1082" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-1083"><a href="#cb49-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1084"><a href="#cb49-1084" aria-hidden="true" tabindex="-1"></a>ax.text(risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.4</span>, </span>
<span id="cb49-1085"><a href="#cb49-1085" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-1086"><a href="#cb49-1086" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightgreen"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-1087"><a href="#cb49-1087" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-1088"><a href="#cb49-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1089"><a href="#cb49-1089" aria-hidden="true" tabindex="-1"></a>ax.text(inverse_risk_adjusted_mean <span class="op">-</span> <span class="dv">10</span>, ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.2</span>, </span>
<span id="cb49-1090"><a href="#cb49-1090" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'Inverse Risk-adjusted Mean:</span><span class="ch">\n</span><span class="sc">{</span>inverse_risk_adjusted_mean<span class="sc">:.1f}</span><span class="ss">'</span>, </span>
<span id="cb49-1091"><a href="#cb49-1091" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"orange"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb49-1092"><a href="#cb49-1092" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb49-1093"><a href="#cb49-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1094"><a href="#cb49-1094" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Response Distribution"</span>)</span>
<span id="cb49-1095"><a href="#cb49-1095" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Total Media Contribution"</span>)</span>
<span id="cb49-1096"><a href="#cb49-1096" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-1097"><a href="#cb49-1097" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1098"><a href="#cb49-1098" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1099"><a href="#cb49-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1100"><a href="#cb49-1100" aria-hidden="true" tabindex="-1"></a>Great, the new allocation is riskier, and the mean is higher (still less uncertant than the risk-neutral allocation). We can go beyond visuals and quantify this.</span>
<span id="cb49-1101"><a href="#cb49-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1102"><a href="#cb49-1102" aria-hidden="true" tabindex="-1"></a>Because all are posterior distributions, we can check the density that has each response distribution at their respective mean. We'll be using kernel density estimation (KDE). This value, denoted $\hat{f}(\mu)$, represents the estimated height of the probability density function at the mean. Importantly, this is not itself a probability but a density, with units of “1 over the units of the variable.” Higher values of $\hat{f}(\mu)$ indicate that the distribution is sharply peaked around the mean, reflecting greater certainty that posterior draws will lie close to the central value. Conversely, lower values correspond to flatter, more diffuse posteriors, indicating higher uncertainty.</span>
<span id="cb49-1103"><a href="#cb49-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1104"><a href="#cb49-1104" aria-hidden="true" tabindex="-1"></a>Let's check the density at the mean for each allocation.</span>
<span id="cb49-1105"><a href="#cb49-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1108"><a href="#cb49-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1109"><a href="#cb49-1109" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1110"><a href="#cb49-1110" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> gaussian_kde</span>
<span id="cb49-1111"><a href="#cb49-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1112"><a href="#cb49-1112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kde_density_at_point(x, x0):</span>
<span id="cb49-1113"><a href="#cb49-1113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gaussian KDE density estimate at x0 using Scott's rule bandwidth."""</span></span>
<span id="cb49-1114"><a href="#cb49-1114" aria-hidden="true" tabindex="-1"></a>    kde <span class="op">=</span> gaussian_kde(x)  <span class="co"># Scott's rule by default</span></span>
<span id="cb49-1115"><a href="#cb49-1115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(kde.evaluate([x0])[<span class="dv">0</span>])</span>
<span id="cb49-1116"><a href="#cb49-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1117"><a href="#cb49-1117" aria-hidden="true" tabindex="-1"></a>optimized_density <span class="op">=</span> kde_density_at_point(optimized_values, optimized_mean)</span>
<span id="cb49-1118"><a href="#cb49-1118" aria-hidden="true" tabindex="-1"></a>guessed_density <span class="op">=</span> kde_density_at_point(guessed_values, guessed_mean)</span>
<span id="cb49-1119"><a href="#cb49-1119" aria-hidden="true" tabindex="-1"></a>risk_adjusted_density <span class="op">=</span> kde_density_at_point(optimized_risk_values, risk_adjusted_mean)</span>
<span id="cb49-1120"><a href="#cb49-1120" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_density <span class="op">=</span> kde_density_at_point(optimized_inverse_risk_values, inverse_risk_adjusted_mean)</span>
<span id="cb49-1121"><a href="#cb49-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1122"><a href="#cb49-1122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimized allocation response density at mean: </span><span class="sc">{</span>optimized_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb49-1123"><a href="#cb49-1123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Guessed allocation response density at mean: </span><span class="sc">{</span>guessed_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb49-1124"><a href="#cb49-1124" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Risk-adjusted allocation response density at mean: </span><span class="sc">{</span>risk_adjusted_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb49-1125"><a href="#cb49-1125" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Inverse Risk-adjusted allocation response density at mean: </span><span class="sc">{</span>inverse_risk_adjusted_density<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb49-1126"><a href="#cb49-1126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1127"><a href="#cb49-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1128"><a href="#cb49-1128" aria-hidden="true" tabindex="-1"></a>The density estimations tell the same story as the plots. How can we use this to take actions? For example, suppose we want to hit a target ROAS of $9.5$, then we can check the density of the ROAS distribution at $9.5$ for each response distribution given their respective allocation strategy.</span>
<span id="cb49-1129"><a href="#cb49-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1132"><a href="#cb49-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1133"><a href="#cb49-1133" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1134"><a href="#cb49-1134" aria-hidden="true" tabindex="-1"></a>optimized_roas <span class="op">=</span> optimized_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb49-1135"><a href="#cb49-1135" aria-hidden="true" tabindex="-1"></a>guessed_roas <span class="op">=</span> guessed_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb49-1136"><a href="#cb49-1136" aria-hidden="true" tabindex="-1"></a>risk_adjusted_roas <span class="op">=</span> optimized_risk_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb49-1137"><a href="#cb49-1137" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_roas <span class="op">=</span> optimized_inverse_risk_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb49-1138"><a href="#cb49-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1139"><a href="#cb49-1139" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate kde density at 9.5</span></span>
<span id="cb49-1140"><a href="#cb49-1140" aria-hidden="true" tabindex="-1"></a>_target_roas <span class="op">=</span> <span class="fl">9.5</span></span>
<span id="cb49-1141"><a href="#cb49-1141" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _target_roas)</span>
<span id="cb49-1142"><a href="#cb49-1142" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _target_roas)</span>
<span id="cb49-1143"><a href="#cb49-1143" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _target_roas)</span>
<span id="cb49-1144"><a href="#cb49-1144" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _target_roas)</span>
<span id="cb49-1145"><a href="#cb49-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1146"><a href="#cb49-1146" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb49-1147"><a href="#cb49-1147" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-1148"><a href="#cb49-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1149"><a href="#cb49-1149" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-1150"><a href="#cb49-1150" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1151"><a href="#cb49-1151" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1152"><a href="#cb49-1152" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1153"><a href="#cb49-1153" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1154"><a href="#cb49-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1155"><a href="#cb49-1155" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-1156"><a href="#cb49-1156" aria-hidden="true" tabindex="-1"></a>ax.axvline(_target_roas, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb49-1157"><a href="#cb49-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1158"><a href="#cb49-1158" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-1159"><a href="#cb49-1159" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb49-1160"><a href="#cb49-1160" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb49-1161"><a href="#cb49-1161" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-1162"><a href="#cb49-1162" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1163"><a href="#cb49-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1164"><a href="#cb49-1164" aria-hidden="true" tabindex="-1"></a>If we want to hit a target ROAS of $9.5$, the risk-neutral optimized allocation is the most certain, followed by the inverse risk-adjusted allocation.</span>
<span id="cb49-1165"><a href="#cb49-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1166"><a href="#cb49-1166" aria-hidden="true" tabindex="-1"></a>If instead our target ROAS is $7$, the inverse risk-adjusted allocation concentrates more density around that value, and the risk-neutral optimized allocation has less density around it.</span>
<span id="cb49-1167"><a href="#cb49-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1170"><a href="#cb49-1170" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1171"><a href="#cb49-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1172"><a href="#cb49-1172" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate kde density at 7</span></span>
<span id="cb49-1173"><a href="#cb49-1173" aria-hidden="true" tabindex="-1"></a>_roas_target <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb49-1174"><a href="#cb49-1174" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _roas_target)</span>
<span id="cb49-1175"><a href="#cb49-1175" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _roas_target)</span>
<span id="cb49-1176"><a href="#cb49-1176" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _roas_target)</span>
<span id="cb49-1177"><a href="#cb49-1177" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _roas_target)</span>
<span id="cb49-1178"><a href="#cb49-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1179"><a href="#cb49-1179" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb49-1180"><a href="#cb49-1180" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-1181"><a href="#cb49-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1182"><a href="#cb49-1182" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-1183"><a href="#cb49-1183" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1184"><a href="#cb49-1184" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1185"><a href="#cb49-1185" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1186"><a href="#cb49-1186" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1187"><a href="#cb49-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1188"><a href="#cb49-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-1189"><a href="#cb49-1189" aria-hidden="true" tabindex="-1"></a>ax.axvline(_roas_target, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb49-1190"><a href="#cb49-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1191"><a href="#cb49-1191" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-1192"><a href="#cb49-1192" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb49-1193"><a href="#cb49-1193" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb49-1194"><a href="#cb49-1194" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-1195"><a href="#cb49-1195" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1196"><a href="#cb49-1196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1197"><a href="#cb49-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1198"><a href="#cb49-1198" aria-hidden="true" tabindex="-1"></a>Under this paradigm, you can define a target estimate and select an allocation that maximizes the probability of hitting it. One way is to create a function that reduces variance with respect to the target, favoring narrower distributions with density near the target.</span>
<span id="cb49-1199"><a href="#cb49-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1200"><a href="#cb49-1200" aria-hidden="true" tabindex="-1"></a>Let's make this custom utility function, and see how it performs.</span>
<span id="cb49-1201"><a href="#cb49-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1204"><a href="#cb49-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1205"><a href="#cb49-1205" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1206"><a href="#cb49-1206" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> pt</span>
<span id="cb49-1207"><a href="#cb49-1207" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc_marketing.mmm.utility <span class="im">as</span> ut</span>
<span id="cb49-1208"><a href="#cb49-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1209"><a href="#cb49-1209" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> target_hit_probability(target, num_periods):</span>
<span id="cb49-1210"><a href="#cb49-1210" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb49-1211"><a href="#cb49-1211" aria-hidden="true" tabindex="-1"></a><span class="co">    Target hit probability utility function.</span></span>
<span id="cb49-1212"><a href="#cb49-1212" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-1213"><a href="#cb49-1213" aria-hidden="true" tabindex="-1"></a><span class="co">    Minimizing the mean squared error between predicted ROAS and the target</span></span>
<span id="cb49-1214"><a href="#cb49-1214" aria-hidden="true" tabindex="-1"></a><span class="co">    Adding a variance penalty to encourage tighter distributions.</span></span>
<span id="cb49-1215"><a href="#cb49-1215" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-1216"><a href="#cb49-1216" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb49-1217"><a href="#cb49-1217" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb49-1218"><a href="#cb49-1218" aria-hidden="true" tabindex="-1"></a><span class="co">    target : float</span></span>
<span id="cb49-1219"><a href="#cb49-1219" aria-hidden="true" tabindex="-1"></a><span class="co">        The target ROAS value to optimize towards</span></span>
<span id="cb49-1220"><a href="#cb49-1220" aria-hidden="true" tabindex="-1"></a><span class="co">    num_periods : int</span></span>
<span id="cb49-1221"><a href="#cb49-1221" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of time periods for the budget allocation</span></span>
<span id="cb49-1222"><a href="#cb49-1222" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb49-1223"><a href="#cb49-1223" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb49-1224"><a href="#cb49-1224" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb49-1225"><a href="#cb49-1225" aria-hidden="true" tabindex="-1"></a><span class="co">    callable</span></span>
<span id="cb49-1226"><a href="#cb49-1226" aria-hidden="true" tabindex="-1"></a><span class="co">        A utility function that can be used with the budget optimizer.</span></span>
<span id="cb49-1227"><a href="#cb49-1227" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns negative objective (since optimizer minimizes).</span></span>
<span id="cb49-1228"><a href="#cb49-1228" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-1229"><a href="#cb49-1229" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _function(samples, budgets):</span>
<span id="cb49-1230"><a href="#cb49-1230" aria-hidden="true" tabindex="-1"></a>        roas_samples <span class="op">=</span> samples <span class="op">/</span> (pt.<span class="bu">sum</span>(budgets) <span class="op">*</span> num_periods)</span>
<span id="cb49-1231"><a href="#cb49-1231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-1232"><a href="#cb49-1232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use mean squared error from target, which provides smoother gradients</span></span>
<span id="cb49-1233"><a href="#cb49-1233" aria-hidden="true" tabindex="-1"></a>        mse_from_target <span class="op">=</span> pt.mean((roas_samples <span class="op">-</span> target) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb49-1234"><a href="#cb49-1234" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-1235"><a href="#cb49-1235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add penalty for variance to encourage tighter distributions around target</span></span>
<span id="cb49-1236"><a href="#cb49-1236" aria-hidden="true" tabindex="-1"></a>        variance_penalty <span class="op">=</span> pt.var(roas_samples)</span>
<span id="cb49-1237"><a href="#cb49-1237" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-1238"><a href="#cb49-1238" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine MSE and variance penalty with weighting</span></span>
<span id="cb49-1239"><a href="#cb49-1239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Higher variance penalty encourages narrower distributions</span></span>
<span id="cb49-1240"><a href="#cb49-1240" aria-hidden="true" tabindex="-1"></a>        total_objective <span class="op">=</span> mse_from_target <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> variance_penalty</span>
<span id="cb49-1241"><a href="#cb49-1241" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-1242"><a href="#cb49-1242" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>total_objective</span>
<span id="cb49-1243"><a href="#cb49-1243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _function</span>
<span id="cb49-1244"><a href="#cb49-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1245"><a href="#cb49-1245" aria-hidden="true" tabindex="-1"></a>_roas_target <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb49-1246"><a href="#cb49-1246" aria-hidden="true" tabindex="-1"></a>custom_utility_budget_allocation, custom_utility_optimizer_result, callback_results <span class="op">=</span> (</span>
<span id="cb49-1247"><a href="#cb49-1247" aria-hidden="true" tabindex="-1"></a>    optimizable_model.optimize_budget(</span>
<span id="cb49-1248"><a href="#cb49-1248" aria-hidden="true" tabindex="-1"></a>        budget<span class="op">=</span>time_unit_budget,</span>
<span id="cb49-1249"><a href="#cb49-1249" aria-hidden="true" tabindex="-1"></a>        utility_function<span class="op">=</span>target_hit_probability(_roas_target, num_periods),</span>
<span id="cb49-1250"><a href="#cb49-1250" aria-hidden="true" tabindex="-1"></a>        callback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-1251"><a href="#cb49-1251" aria-hidden="true" tabindex="-1"></a>        minimize_kwargs<span class="op">=</span>{<span class="st">"options"</span>: {<span class="st">"maxiter"</span>: <span class="dv">2_000</span>}},</span>
<span id="cb49-1252"><a href="#cb49-1252" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-1253"><a href="#cb49-1253" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1254"><a href="#cb49-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1255"><a href="#cb49-1255" aria-hidden="true" tabindex="-1"></a>custom_utility_posterior_response <span class="op">=</span> optimizable_model.sample_response_distribution(</span>
<span id="cb49-1256"><a href="#cb49-1256" aria-hidden="true" tabindex="-1"></a>    allocation_strategy<span class="op">=</span>custom_utility_budget_allocation,</span>
<span id="cb49-1257"><a href="#cb49-1257" aria-hidden="true" tabindex="-1"></a>    include_carryover<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-1258"><a href="#cb49-1258" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-1259"><a href="#cb49-1259" aria-hidden="true" tabindex="-1"></a>    additional_var_names<span class="op">=</span>[<span class="st">"y_original_scale"</span>]</span>
<span id="cb49-1260"><a href="#cb49-1260" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1261"><a href="#cb49-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1262"><a href="#cb49-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Print budget allocation by channel</span></span>
<span id="cb49-1263"><a href="#cb49-1263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget allocation by channel:"</span>)</span>
<span id="cb49-1264"><a href="#cb49-1264" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel <span class="kw">in</span> channels:</span>
<span id="cb49-1265"><a href="#cb49-1265" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb49-1266"><a href="#cb49-1266" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>custom_utility_posterior_response<span class="sc">.</span>allocation<span class="sc">.</span>sel(channel<span class="op">=</span>channel)<span class="sc">.</span>astype(<span class="bu">int</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb49-1267"><a href="#cb49-1267" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-1268"><a href="#cb49-1268" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb49-1269"><a href="#cb49-1269" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total Allocated Budget: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(custom_utility_posterior_response.allocation.to_numpy())<span class="sc">:,.0f}</span><span class="ss">"</span></span>
<span id="cb49-1270"><a href="#cb49-1270" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1271"><a href="#cb49-1271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1272"><a href="#cb49-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1273"><a href="#cb49-1273" aria-hidden="true" tabindex="-1"></a>The allocation is similar to those observed before. Let's plot the ROAS distributions.</span>
<span id="cb49-1274"><a href="#cb49-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1277"><a href="#cb49-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1278"><a href="#cb49-1278" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1279"><a href="#cb49-1279" aria-hidden="true" tabindex="-1"></a>custom_utility_values <span class="op">=</span> custom_utility_posterior_response.total_media_contribution_original_scale.values</span>
<span id="cb49-1280"><a href="#cb49-1280" aria-hidden="true" tabindex="-1"></a>custom_utility_roas <span class="op">=</span> custom_utility_values <span class="op">/</span> (time_unit_budget<span class="op">*</span>num_periods)</span>
<span id="cb49-1281"><a href="#cb49-1281" aria-hidden="true" tabindex="-1"></a>optimized_kde_density <span class="op">=</span> kde_density_at_point(optimized_roas, _roas_target)</span>
<span id="cb49-1282"><a href="#cb49-1282" aria-hidden="true" tabindex="-1"></a>guessed_kde_density <span class="op">=</span> kde_density_at_point(guessed_roas, _roas_target)</span>
<span id="cb49-1283"><a href="#cb49-1283" aria-hidden="true" tabindex="-1"></a>risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(risk_adjusted_roas, _roas_target)</span>
<span id="cb49-1284"><a href="#cb49-1284" aria-hidden="true" tabindex="-1"></a>inverse_risk_adjusted_kde_density <span class="op">=</span> kde_density_at_point(inverse_risk_adjusted_roas, _roas_target)</span>
<span id="cb49-1285"><a href="#cb49-1285" aria-hidden="true" tabindex="-1"></a>custom_utility_kde_density <span class="op">=</span> kde_density_at_point(custom_utility_roas, _roas_target)</span>
<span id="cb49-1286"><a href="#cb49-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1287"><a href="#cb49-1287" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the ROAS distributions</span></span>
<span id="cb49-1288"><a href="#cb49-1288" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-1289"><a href="#cb49-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1290"><a href="#cb49-1290" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb49-1291"><a href="#cb49-1291" aria-hidden="true" tabindex="-1"></a>az.plot_dist(optimized_roas, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="ss">f"Optimized allocation: </span><span class="sc">{</span>optimized_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1292"><a href="#cb49-1292" aria-hidden="true" tabindex="-1"></a>az.plot_dist(guessed_roas, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="ss">f"Guessed allocation: </span><span class="sc">{</span>guessed_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1293"><a href="#cb49-1293" aria-hidden="true" tabindex="-1"></a>az.plot_dist(risk_adjusted_roas, color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="ss">f"Risk-adjusted allocation: </span><span class="sc">{</span>risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1294"><a href="#cb49-1294" aria-hidden="true" tabindex="-1"></a>az.plot_dist(inverse_risk_adjusted_roas, color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="ss">f"Inverse Risk-adjusted allocation: </span><span class="sc">{</span>inverse_risk_adjusted_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1295"><a href="#cb49-1295" aria-hidden="true" tabindex="-1"></a>az.plot_dist(custom_utility_roas, color<span class="op">=</span><span class="st">"purple"</span>, label<span class="op">=</span><span class="ss">f"Custom utility allocation: </span><span class="sc">{</span>custom_utility_kde_density<span class="sc">:.3f}</span><span class="ss">"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb49-1296"><a href="#cb49-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1297"><a href="#cb49-1297" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for means</span></span>
<span id="cb49-1298"><a href="#cb49-1298" aria-hidden="true" tabindex="-1"></a>ax.axvline(_roas_target, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Target ROAS"</span>)</span>
<span id="cb49-1299"><a href="#cb49-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1300"><a href="#cb49-1300" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-1301"><a href="#cb49-1301" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"ROAS Distribution"</span>)</span>
<span id="cb49-1302"><a href="#cb49-1302" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"ROAS"</span>)</span>
<span id="cb49-1303"><a href="#cb49-1303" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-1304"><a href="#cb49-1304" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1305"><a href="#cb49-1305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1306"><a href="#cb49-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1307"><a href="#cb49-1307" aria-hidden="true" tabindex="-1"></a>Great 🙌🏻 The initial optimized allocation which was risk neutral, had initially the higher density around the target ROAS, but the density around it was not high enough, the new allocation bring a more certain answer around the target, because the objective function was built for it.</span>
<span id="cb49-1308"><a href="#cb49-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1309"><a href="#cb49-1309" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon=false}</span>
<span id="cb49-1310"><a href="#cb49-1310" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Key Insight</span></span>
<span id="cb49-1311"><a href="#cb49-1311" aria-hidden="true" tabindex="-1"></a>Here we have a custom utility function that allows us to optimize for a target ROAS. Nevertheless, you can build other utilities and use them as objectives. You can also introduce risk-aware constraints—without on top of your business constraints.</span>
<span id="cb49-1312"><a href="#cb49-1312" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-1313"><a href="#cb49-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1314"><a href="#cb49-1314" aria-hidden="true" tabindex="-1"></a>Let's observe our final posterior around the target ROAS.</span>
<span id="cb49-1315"><a href="#cb49-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1318"><a href="#cb49-1318" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1319"><a href="#cb49-1319" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1320"><a href="#cb49-1320" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb49-1321"><a href="#cb49-1321" aria-hidden="true" tabindex="-1"></a>    custom_utility_roas, </span>
<span id="cb49-1322"><a href="#cb49-1322" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>_roas_target</span>
<span id="cb49-1323"><a href="#cb49-1323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1324"><a href="#cb49-1324" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1325"><a href="#cb49-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1326"><a href="#cb49-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1327"><a href="#cb49-1327" aria-hidden="true" tabindex="-1"></a>We could report: the probability of achieving ROAS ≥ 10 with this allocation is 31%, and ROAS &lt; 10 is 69%. If we need more certainty, we can make the optimization more risk-averse.</span>
<span id="cb49-1328"><a href="#cb49-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1329"><a href="#cb49-1329" aria-hidden="true" tabindex="-1"></a>Now, if you want to think really bayesian, then you can define a region of practical equivalence, and check the probability of the ROAS being in that region. For example, you can ask yourself: Would I do something different if ROAS is 7, 9 or 11? If the answer it's no, then you find your ROPE. </span>
<span id="cb49-1330"><a href="#cb49-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1331"><a href="#cb49-1331" aria-hidden="true" tabindex="-1"></a>Let's say we want to know the probability of the ROAS being between $7$ and $11$.</span>
<span id="cb49-1332"><a href="#cb49-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1335"><a href="#cb49-1335" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb49-1336"><a href="#cb49-1336" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb49-1337"><a href="#cb49-1337" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate probability of ROAS being between 7 and 9</span></span>
<span id="cb49-1338"><a href="#cb49-1338" aria-hidden="true" tabindex="-1"></a>prob_7_to_11 <span class="op">=</span> np.mean((custom_utility_roas <span class="op">&gt;=</span> <span class="dv">7</span>) <span class="op">&amp;</span> (custom_utility_roas <span class="op">&lt;=</span> <span class="dv">11</span>))</span>
<span id="cb49-1339"><a href="#cb49-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1340"><a href="#cb49-1340" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior with reference values and region</span></span>
<span id="cb49-1341"><a href="#cb49-1341" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb49-1342"><a href="#cb49-1342" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(</span>
<span id="cb49-1343"><a href="#cb49-1343" aria-hidden="true" tabindex="-1"></a>    custom_utility_roas, </span>
<span id="cb49-1344"><a href="#cb49-1344" aria-hidden="true" tabindex="-1"></a>    ref_val<span class="op">=</span>_roas_target,</span>
<span id="cb49-1345"><a href="#cb49-1345" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax</span>
<span id="cb49-1346"><a href="#cb49-1346" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-1347"><a href="#cb49-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1348"><a href="#cb49-1348" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vertical lines for the region of interest</span></span>
<span id="cb49-1349"><a href="#cb49-1349" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="dv">7</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">"ROAS = 7"</span>)</span>
<span id="cb49-1350"><a href="#cb49-1350" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="dv">11</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">"ROAS = 11"</span>)</span>
<span id="cb49-1351"><a href="#cb49-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1352"><a href="#cb49-1352" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text box with probability</span></span>
<span id="cb49-1353"><a href="#cb49-1353" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, </span>
<span id="cb49-1354"><a href="#cb49-1354" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'P(7 ≤ ROAS ≤ 11) = </span><span class="sc">{</span>prob_7_to_11<span class="sc">:.2%}</span><span class="ss">'</span>, </span>
<span id="cb49-1355"><a href="#cb49-1355" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb49-1356"><a href="#cb49-1356" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, facecolor<span class="op">=</span><span class="st">"lightblue"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>),</span>
<span id="cb49-1357"><a href="#cb49-1357" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb49-1358"><a href="#cb49-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1359"><a href="#cb49-1359" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb49-1360"><a href="#cb49-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-1361"><a href="#cb49-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1362"><a href="#cb49-1362" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip icon=false}</span>
<span id="cb49-1363"><a href="#cb49-1363" aria-hidden="true" tabindex="-1"></a><span class="fu">## 💡 Key Insight</span></span>
<span id="cb49-1364"><a href="#cb49-1364" aria-hidden="true" tabindex="-1"></a>You can **define a region of practical equivalence (ROPE)**, in order to be more precise with your decision making. This is quite natural way to think about a problem, and lightens the burden of the decision maker to commit to a single number. At the end of the day, we don't need to be 99.999% precise around every single answer, or number, we can be 95% or 90% precise and sometimes that's enough. *Identify if thats your case, and think accordingly*.</span>
<span id="cb49-1365"><a href="#cb49-1365" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-1366"><a href="#cb49-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1367"><a href="#cb49-1367" aria-hidden="true" tabindex="-1"></a><span class="fu"># ✅ Takeaways on uncertainty</span></span>
<span id="cb49-1368"><a href="#cb49-1368" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Treat uncertainty as first-class**: Optimize over the full posterior predictive, not point estimates. Compare plans by their distributions, not just expected means.</span>
<span id="cb49-1369"><a href="#cb49-1369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Separate uncertainty types**: Aleatoric (irreducible noise) vs epistemic (learnable model/parameter uncertainty). Planning choices mostly shift epistemic risk; always communicate both.</span>
<span id="cb49-1370"><a href="#cb49-1370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Find your risk appetite**: Ask stakeholders how certain we must be about reported results. What changes if they are a bit higher or lower?</span>
<span id="cb49-1371"><a href="#cb49-1371" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Choose a utility aligned to risk appetite**: Working with the mean is risk-neutral; quantiles, TailDistance, CVaR, or MTS are more risk-aware.</span>
<span id="cb49-1372"><a href="#cb49-1372" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Communicate distributions, not single numbers**: Show HDIs/quantiles and probabilities (e.g., P(ROAS ≥ target)). It's better to understand the full spectrum of possibilities than to follow single numbers and be short-sighted.</span>
<span id="cb49-1373"><a href="#cb49-1373" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Define a region of practical equivalence (ROPE)**: Once you are comfortable with the uncertainty, play with ROPEs and find out how much you could lighten the estimated answer, and if you will do anything different if this one change under a range of values.</span>
<span id="cb49-1374"><a href="#cb49-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1375"><a href="#cb49-1375" aria-hidden="true" tabindex="-1"></a><span class="fu"># 🚧 Limitations</span></span>
<span id="cb49-1376"><a href="#cb49-1376" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This approach represents the model’s confidence, but models can be very certain about a wrong answer. Always add business knowledge and guardrails to keep recommendations realistic.</span>
<span id="cb49-1377"><a href="#cb49-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1378"><a href="#cb49-1378" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion</span></span>
<span id="cb49-1379"><a href="#cb49-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1380"><a href="#cb49-1380" aria-hidden="true" tabindex="-1"></a>Hope this article was helpful to understand how to use Bayesian media mix models to optimize your media spend. Understand uncertanty it's a powerful tool to make better decisions, but it's not a silver bullet.</span>
<span id="cb49-1381"><a href="#cb49-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1382"><a href="#cb49-1382" aria-hidden="true" tabindex="-1"></a>The current example is a simple one, real life applications are more complex and require more sophisticated models, risk functions, and complex optimization problems, where constraints and business knowledge are key.</span>
<span id="cb49-1383"><a href="#cb49-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1384"><a href="#cb49-1384" aria-hidden="true" tabindex="-1"></a>At <span class="co">[</span><span class="ot">PyMC Labs</span><span class="co">](https://www.pymc-labs.com/)</span> we're building tools to make this process easier. If you're interested in learning more, explore the PyMC‑Marketing <span class="co">[</span><span class="ot">Example Gallery</span><span class="co">](https://www.pymc-marketing.io/en/stable/gallery/gallery.html)</span> and <span class="co">[</span><span class="ot">API</span><span class="co">](https://www.pymc-marketing.io/en/stable/api/index.html)</span>, our <span class="co">[</span><span class="ot">documentation</span><span class="co">](https://docs.pymc-marketing.com/)</span> and <span class="co">[</span><span class="ot">blog</span><span class="co">](https://www.pymc-labs.com/blog-posts)</span>.</span>
<span id="cb49-1385"><a href="#cb49-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1386"><a href="#cb49-1386" aria-hidden="true" tabindex="-1"></a>You can get a 30 minutes free consultation with our team to discuss your specific needs and how we can help you.</span>
<span id="cb49-1387"><a href="#cb49-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1388"><a href="#cb49-1388" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>1:1 Session with me: <span class="co">[</span><span class="ot">Book a call</span><span class="co">](https://calendar.app.google/vX9DziLkdMSAAszU8)</span></span>
<span id="cb49-1389"><a href="#cb49-1389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Discovery session with PyMC Labs team: <span class="co">[</span><span class="ot">Book a call</span><span class="co">](https://www.pymc-labs.com/?utm_source=carlos_trujillo&amp;utm_medium=pydata_berlin&amp;utm_campaign=bayesian_mmm_article)</span></span>
<span id="cb49-1390"><a href="#cb49-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-1391"><a href="#cb49-1391" aria-hidden="true" tabindex="-1"></a>Thanks if you read this far!</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Connect with me:
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2023 Carlos Trujillo
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/cetagostini/cetagostini.github.io/edit/main/articles/bayesian_models_and_risk_optimization/bayesian_models_and_risk_optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cetagostini/cetagostini.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cetagostini">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cetagostini">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/cetagostini">
      <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://instagram.com/cetagostini">
      <i class="bi bi-instagram" role="img" aria-label="Instagram">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:carlos.trujillo.agostini@gmail.com">
      <i class="bi bi-envelope" role="img" aria-label="Email">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script src="../../js/cookie-consent.js"></script>




</body></html>