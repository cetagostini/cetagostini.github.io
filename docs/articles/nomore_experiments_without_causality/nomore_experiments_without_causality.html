<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-04-01">

<title>Media Mix Model calibration is useless without causal knowledge – Marketing Science Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/icon/fav.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9902c68886862a72ad4d9bc7825eafd7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
  .navbar-title {
    font-weight: 700;
    background: linear-gradient(90deg, #383acf 0%, #9c27b0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Media Mix Model calibration is useless without causal knowledge – Marketing Science Blog">
<meta property="og:description" content="">
<meta property="og:image" content="https://cetagostini.github.io/cetagostini.github.io/articles/images/nomore_experiments_without_causality.png">
<meta property="og:site_name" content="Marketing Science Blog">
<meta name="twitter:title" content="Media Mix Model calibration is useless without causal knowledge – Marketing Science Blog">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://cetagostini.github.io/cetagostini.github.io/articles/images/nomore_experiments_without_causality.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Marketing Science Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../articles.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#why-marketers-love-calibration" id="toc-why-marketers-love-calibration" class="nav-link" data-scroll-target="#why-marketers-love-calibration">Why marketers love calibration</a></li>
  <li><a href="#what-is-calibrationmathematically" id="toc-what-is-calibrationmathematically" class="nav-link" data-scroll-target="#what-is-calibrationmathematically">What <em>is</em> calibration—mathematically?</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a>
  <ul class="collapse">
  <li><a href="#collider-bias" id="toc-collider-bias" class="nav-link" data-scroll-target="#collider-bias">1. Collider Bias</a></li>
  <li><a href="#mediator-effects" id="toc-mediator-effects" class="nav-link" data-scroll-target="#mediator-effects">2. Mediator Effects</a></li>
  <li><a href="#confounding-from-events" id="toc-confounding-from-events" class="nav-link" data-scroll-target="#confounding-from-events">3. Confounding from Events</a></li>
  <li><a href="#minimal-adjustment-set-for-x2" id="toc-minimal-adjustment-set-for-x2" class="nav-link" data-scroll-target="#minimal-adjustment-set-for-x2">4. Minimal Adjustment Set for X2</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/cetagostini/cetagostini.github.io/edit/main/articles/nomore_experiments_without_causality/nomore_experiments_without_causality.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cetagostini/cetagostini.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add the navbar-title class to the navbar brand
    const navbarBrand = document.querySelector('.navbar-brand');
    if (navbarBrand) {
      navbarBrand.classList.add('navbar-title');
    }
  });
</script> 

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Media Mix Model calibration is useless without causal knowledge</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">experimentation</div>
    <div class="quarto-category">media mix modeling</div>
    <div class="quarto-category">mmm</div>
    <div class="quarto-category">bayesian</div>
    <div class="quarto-category">pymc</div>
    <div class="quarto-category">pydata</div>
    <div class="quarto-category">germany</div>
    <div class="quarto-category">darmstadt</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Imagine you just shipped a shiny new Bayesian Media-Mix Model (MMM) that <em>perfectly</em> back-fits years of marketing data. A/B-lift experiments then tell you channel-A is worth <strong>€2.7 M</strong>, but your model insists it is worth <strong>€7 M</strong>. “Easy fix,” you think: <em>calibrate</em> the MMM with the lift tests—add an extra likelihood term, rerun, publish.</p>
<p>Yet the calibrated model still over/under-values the channel based on the experimental evidence. Looks like it can’t reconcile the experimental evidence with the data, and adding new calibration for other channels actually makes it worse.</p>
<p>That is the calibration trap: without causal structure the posterior can’t happily reconcile observations and <strong>clean</strong> experiments at the same time.</p>
<p>In this article we will build a PyMC MMM, add lift-test calibration, and then show—step-by-step—why calibration alone cannot save a misspecified causal story.</p>
<hr>
</section>
<section id="why-marketers-love-calibration" class="level1">
<h1>Why marketers love calibration</h1>
<ul>
<li><strong>Ground-truth anchor.</strong> Lift tests are randomised, so their incremental effects are (almost) unbiased.<br>
</li>
<li><strong>Sample-size boost.</strong> MMMs see every day and every channel; experiments see only a slice. Combining them promises lower variance.<br>
</li>
<li><strong>Storytelling power.</strong> “Our model <em>matches</em> the experiments” is an executive-friendly sound-bite.</li>
</ul>
<p>Calibration therefore feels like catching two Bayesian birds with one conjugate stone.</p>
<hr>
</section>
<section id="what-is-calibrationmathematically" class="level1">
<h1>What <em>is</em> calibration—mathematically?</h1>
<p>For each experiment <span class="math inline">\(i\)</span> the model predicts a lift</p>
<p><span class="math display">\[
\widehat{\Delta y_i}(\theta)\;=\;
s\bigl(x_i+\Delta x_i;\,\theta_{c(i)}\bigr)
\;-\;
s\bigl(x_i;\,\theta_{c(i)}\bigr),
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(x_i\)</span> – baseline spend before the experiment,<br>
</li>
<li><span class="math inline">\(\Delta x_i\)</span> – change in spend during the experiment,<br>
</li>
<li><span class="math inline">\(s(\cdot;\theta_{c(i)})\)</span> – saturation curve for the channel that experiment <span class="math inline">\(i\)</span> targets,<br>
</li>
<li><span class="math inline">\(\theta\)</span> – all saturation-curve parameters,<br>
</li>
<li><span class="math inline">\(\widehat{\Delta y_i}(\theta)\)</span> – model-predicted incremental outcome.</li>
</ul>
<p>We then attach the observed lift <span class="math inline">\(\Delta y_i\)</span> and its error <span class="math inline">\(\sigma_i\)</span> through an additional likelihood</p>
<p><span class="math display">\[
p\!\bigl(\Delta y_i \mid \theta\bigr)\;=\;
\operatorname{Gamma}\!\bigl(
\mu=\lvert\widehat{\Delta y_i}(\theta)\rvert,\;
\sigma=\sigma_i
\bigr),
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\Delta y_i\)</span> – experimentally measured incremental outcome,<br>
</li>
<li><span class="math inline">\(\sigma_i\)</span> – reported standard error of <span class="math inline">\(\Delta y_i\)</span>,<br>
</li>
<li><span class="math inline">\(\mu\)</span> – mean parameter set to the <em>absolute</em> predicted lift so the Gamma remains non-negative.</li>
</ul>
<p>Stacking all <span class="math inline">\(n_{\text{lift}}\)</span> experiments gives the calibrated posterior</p>
<p><span class="math display">\[
p\!\bigl(\theta \mid \mathbf y,\mathcal L\bigr)
\;\propto\;
p\!\bigl(\mathbf y \mid \theta\bigr)\;
\prod_{i=1}^{n_{\text{lift}}}
p\!\bigl(\Delta y_i \mid \theta\bigr)\;
p(\theta),
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\mathbf y\)</span> – full time-series of observed outcomes (sales, sign-ups …),<br>
</li>
<li><span class="math inline">\(\mathcal L\)</span> – the collection of lift-test observations <span class="math inline">\((\Delta y_i,\sigma_i)\)</span>,<br>
</li>
<li><span class="math inline">\(p(\theta)\)</span> – priors for all parameters.</li>
</ul>
<p>PyMC turns this into a three-liner:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>add_lift_measurements_to_likelihood_from_saturation(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>mmm,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    df_lift<span class="op">=</span>df_lifts,     <span class="co"># experiment data-frame</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    dist<span class="op">=</span>pm.Gamma,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In simple terms, calibration appends one extra likelihood per experiment: for lift <code>i</code> we run the channel’s saturation curve at the pre-spend and post-spend levels, subtract the two, and call that result the model-expected incremental response for experiment <code>i</code> (a deterministic function of the saturation parameter vector <span class="math inline">\(\theta\)</span>). We then treat the observed lift <span class="math inline">\(\Delta y_i\)</span> as a Gamma-distributed draw whose mean is the absolute value of that model-expected increment and whose dispersion is the experiment’s reported standard error <span class="math inline">\(\sigma_i\)</span>.</p>
<p>These independent <span class="math inline">\(\Gamma(\mu = |\text{model-expected increment}|, \sigma = \sigma_i)\)</span> factors multiply into the original time-series likelihood, yielding a posterior where <span class="math inline">\(\theta\)</span> is pulled toward values that keep every model-expected increment within the experimental noise band. In effect, each lift test imposes a Bayesian anchor that penalises any parameter setting whose predicted causal effect disagrees with ground-truth, while still allowing the full sales history to inform the remaining uncertainty.</p>
<p>Let’s see how this works in practice, by creating a synthetic dataset and fitting a simple MMM.</p>
</section>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<p>We’ll use Pytensor to run our data-generation-process (DGP). Let’s set the seed for reproducibility, and define the number of observations, and finally add some default configurations for the notebook.</p>
<div id="319ef799" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> pt</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.graph <span class="im">import</span> rewrite_graph</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> preliz <span class="im">as</span> pz</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> GeometricAdstock, MichaelisMentenSaturation, MMM</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.prior <span class="im">import</span> Prior</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>n_observations <span class="op">=</span> <span class="dv">1050</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the style</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-darkgrid"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.dpi"</span>] <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"xtick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"ytick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">"retina"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, we can define the date range.</p>
<div id="8a30361b" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>min_date <span class="op">=</span> pd.to_datetime(<span class="st">"2022-01-01"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>max_date <span class="op">=</span> min_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>n_observations)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>date_range <span class="op">=</span> pd.date_range(start<span class="op">=</span>min_date, end<span class="op">=</span>max_date, freq<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span>{<span class="st">"date_week"</span>: date_range}).assign(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.year,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.month,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    dayofyear<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.dayofyear,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can start by creating the spend vectors for each channel. These are the will define later the amount of impressions or exposition we get from each channel, which by the end will transform into sales.</p>
<div id="3252dd1a" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>spend_x1 <span class="op">=</span> pt.vector(<span class="st">"spend_x1"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spend_x2 <span class="op">=</span> pt.vector(<span class="st">"spend_x2"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>spend_x3 <span class="op">=</span> pt.vector(<span class="st">"spend_x3"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>spend_x4 <span class="op">=</span> pt.vector(<span class="st">"spend_x4"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample inputs for demonstration using preliz distributions:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>pz_spend_x1 <span class="op">=</span> np.convolve(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.8</span>, sigma<span class="op">=</span><span class="fl">.3</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>pz_spend_x1[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x1.mean()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>pz_spend_x1[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x1.mean()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>pz_spend_x2 <span class="op">=</span> np.convolve(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.6</span>, sigma<span class="op">=</span><span class="fl">.4</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>pz_spend_x2[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x2.mean()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>pz_spend_x2[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x2.mean()</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>pz_spend_x3 <span class="op">=</span> np.convolve(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.2</span>, sigma<span class="op">=</span><span class="fl">.2</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>pz_spend_x3[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x3.mean()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>pz_spend_x3[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x3.mean()</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>pz_spend_x4 <span class="op">=</span> np.convolve(</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.1</span>, sigma<span class="op">=</span><span class="fl">.03</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>pz_spend_x4[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x4.mean()</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>pz_spend_x4[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x4.mean()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x1, label<span class="op">=</span><span class="st">'Channel 1'</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x2, label<span class="op">=</span><span class="st">'Channel 2'</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x3, label<span class="op">=</span><span class="st">'Channel 3'</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x4, label<span class="op">=</span><span class="st">'Channel 4'</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spend'</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Using the same logic we can create other components such as trend, noise, seasonality, and certain events.</p>
<div id="5c97c1ea" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Trend</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>trend <span class="op">=</span> pt.vector(<span class="st">"trend"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the trend</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>np_trend <span class="op">=</span> (np.linspace(start<span class="op">=</span><span class="fl">0.0</span>, stop<span class="op">=</span><span class="fl">.50</span>, num<span class="op">=</span>n_observations) <span class="op">+</span> <span class="fl">.10</span>) <span class="op">**</span> (<span class="fl">.1</span> <span class="op">/</span> <span class="fl">.4</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">## NOISE </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>global_noise <span class="op">=</span> pt.vector(<span class="st">"global_noise"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the noise</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>pz_global_noise <span class="op">=</span> pz.Normal(mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">.005</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># EVENTS EFFECT</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>pt_event_signal <span class="op">=</span> pt.vector(<span class="st">"event_signal"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>pt_event_contributions <span class="op">=</span> pt.vector(<span class="st">"event_contributions"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>event_dates <span class="op">=</span> [<span class="st">"24-12"</span>, <span class="st">"09-07"</span>]  <span class="co"># List of events as month-day strings</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>std_devs <span class="op">=</span> [<span class="dv">25</span>, <span class="dv">15</span>]  <span class="co"># List of standard deviations for each event</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>events_coefficients <span class="op">=</span> [<span class="fl">.094</span>, <span class="fl">.018</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>signals_independent <span class="op">=</span> []</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the event effect array</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>event_signal <span class="op">=</span> np.zeros(<span class="bu">len</span>(date_range))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>event_contributions <span class="op">=</span> np.zeros(<span class="bu">len</span>(date_range))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate event signals</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event, std_dev, event_coef <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    event_dates, std_devs, events_coefficients, strict<span class="op">=</span><span class="va">False</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find all occurrences of the event in the date range</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    event_occurrences <span class="op">=</span> date_range[date_range.strftime(<span class="st">"</span><span class="sc">%d</span><span class="st">-%m"</span>) <span class="op">==</span> event]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> occurrence <span class="kw">in</span> event_occurrences:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the time difference in days</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        time_diff <span class="op">=</span> (date_range <span class="op">-</span> occurrence).days</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate the Gaussian basis for the event</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        _event_signal <span class="op">=</span> np.exp(<span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> (time_diff <span class="op">/</span> std_dev) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the event signal to the event effect</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        signals_independent.append(_event_signal)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        event_signal <span class="op">+=</span> _event_signal</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        event_contributions <span class="op">+=</span> _event_signal <span class="op">*</span> event_coef</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>np_event_signal <span class="op">=</span> event_signal</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>np_event_contributions <span class="op">=</span> event_contributions</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>plt.plot(pz_global_noise, label<span class="op">=</span><span class="st">'Global Noise'</span>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>plt.plot(np_trend, label<span class="op">=</span><span class="st">'Trend'</span>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>plt.plot(np_event_signal, label<span class="op">=</span><span class="st">'Event Contributions'</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Components of the Time Series Model'</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In order to make it more interesting, lets add a price variable. Usually, price creates more impact as it’s slower. The product price contribution function we’ll use is a diminishing returns function:</p>
<p><span class="math display">\[f(X, \alpha, \lambda) = \frac{\alpha}{1 + (X / \lambda)}\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> represents the maximum contribution and <span class="math inline">\(\lambda\)</span> is a scaling parameter that controls how quickly the contribution diminishes as price increases.</p>
<div id="b4f25996" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> product_price_contribution(X, alpha, lam):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> (X <span class="op">/</span> lam))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a product price vector.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>product_price <span class="op">=</span> pt.vector(<span class="st">"product_price"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>product_price_alpha <span class="op">=</span> pt.scalar(<span class="st">"product_price_alpha"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>product_price_lam <span class="op">=</span> pt.scalar(<span class="st">"product_price_lam"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the product price</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>pz_product_price <span class="op">=</span> np.convolve(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.05</span>, sigma<span class="op">=</span><span class="fl">.02</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>pz_product_price[:<span class="dv">14</span>] <span class="op">=</span> pz_product_price.mean()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>pz_product_price[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_product_price.mean()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>product_price_alpha_value <span class="op">=</span> <span class="fl">.08</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>product_price_lam_value <span class="op">=</span> <span class="fl">.03</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct contribution to the target.</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>pt_product_price_contribution <span class="op">=</span> product_price_contribution(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    product_price, </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    product_price_alpha, </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    product_price_lam</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the product price contribution</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the raw price data</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>ax1.plot(pz_product_price, color<span class="op">=</span><span class="st">"green"</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Product Price'</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Price'</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the price contribution</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>price_contribution <span class="op">=</span> pt_product_price_contribution.<span class="bu">eval</span>({</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>ax2.plot(price_contribution, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Price Contribution'</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Contribution'</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With all the principal components in place, all parent nodes we can start to write down our causal DAG to define the relationships we want to explain.</p>
<div id="e404ef44" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot causal graph of the vars x1, x2, x3, x4 using graphviz</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cdag_impressions <span class="op">=</span> graphviz.Digraph(comment<span class="op">=</span><span class="st">'Causal DAG for Impressions'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x1'</span>, <span class="st">'Spend X1'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x2'</span>, <span class="st">'Spend X2'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x3'</span>, <span class="st">'Spend X3'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x4'</span>, <span class="st">'Spend X4'</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'events'</span>, <span class="st">'Events'</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x1'</span>, <span class="st">'impressions_x1'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x2'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x3'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x4'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x1'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'events'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'events'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>cdag_impressions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once our causal graph is defined, we can start to write down in pytensor the structure and relationships.</p>
<div id="8fbefa1e" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a impressions vector, result of x1, x2, x3, x4. by some beta with daily values.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define all parameters as PyTensor variables</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>beta_x1 <span class="op">=</span> pt.vector(<span class="st">"beta_x1"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>impressions_x1 <span class="op">=</span> spend_x1 <span class="op">*</span> beta_x1</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>beta_x2 <span class="op">=</span> pt.vector(<span class="st">"beta_x2"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>alpha_event_x2 <span class="op">=</span> pt.scalar(<span class="st">"alpha_event_x2"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>impressions_x2 <span class="op">=</span> spend_x2 <span class="op">*</span> beta_x2 <span class="op">+</span> pt_event_signal <span class="op">*</span> alpha_event_x2</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>beta_x3 <span class="op">=</span> pt.vector(<span class="st">"beta_x3"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>alpha_event_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_event_x3"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>alpha_x1_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x1_x3"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>alpha_x2_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x2_x3"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>impressions_x3 <span class="op">=</span> spend_x3 <span class="op">*</span> beta_x3 <span class="op">+</span> pt_event_signal <span class="op">*</span> alpha_event_x3 <span class="op">+</span> (</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    impressions_x2 <span class="op">*</span> alpha_x2_x3</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> impressions_x1 <span class="op">*</span> alpha_x1_x3</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>beta_x4 <span class="op">=</span> pt.vector(<span class="st">"beta_x4"</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>alpha_x2_x4 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x2_x4"</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>impressions_x4 <span class="op">=</span> spend_x4 <span class="op">*</span> beta_x4 <span class="op">+</span> impressions_x2 <span class="op">*</span> alpha_x2_x4</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample values for the parameters (to be used in eval)</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>pz_beta_x1 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">0.05</span>, beta<span class="op">=</span><span class="fl">.1</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>pz_beta_x2 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.015</span>, beta<span class="op">=</span><span class="fl">.05</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>pz_alpha_event_x2 <span class="op">=</span> <span class="fl">0.015</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>pz_beta_x3 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.1</span>, beta<span class="op">=</span><span class="fl">.1</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>pz_alpha_event_x3 <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>pz_alpha_x1_x3 <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>pz_alpha_x2_x3 <span class="op">=</span> <span class="fl">0.12</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>pz_beta_x4 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.125</span>, beta<span class="op">=</span><span class="fl">.05</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>pz_alpha_x2_x4 <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all impressions</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Define dependencies for each variable</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>x1_deps <span class="op">=</span> {</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>x2_deps <span class="op">=</span> {</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: pz_spend_x2,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],  <span class="co"># Slice to match 1050 length</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="co"># For x3, we need all dependencies from x1 and x2 plus its own</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>x3_deps <span class="op">=</span> {</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x1_deps,</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x2_deps,</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co"># For x4, we need dependencies from x2 plus its own</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>x4_deps <span class="op">=</span> {</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x2_deps,</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot each impression series</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, sharex<span class="op">=</span><span class="st">'row'</span>, sharey<span class="op">=</span><span class="st">'row'</span>)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 1</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(impressions_x1.<span class="bu">eval</span>(x1_deps), color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Channel 1'</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Impressions'</span>)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 2</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].plot(impressions_x2.<span class="bu">eval</span>(x2_deps), color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Channel 2'</span>)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 3</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].plot(impressions_x3.<span class="bu">eval</span>(x3_deps), color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Channel 3'</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Impressions'</span>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 4</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].plot(impressions_x4.<span class="bu">eval</span>(x4_deps), color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Channel 4'</span>)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualizing the computational graph
</div>
</div>
<div class="callout-body-container callout-body">
<p>In order to check we write down the process properly, we can ask PyTensor to print our structural causal model. This is not necessary for the analysis, but can be helpful for debugging and understanding the model structure.</p>
<div id="878dfe44" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.printing <span class="im">as</span> printing</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the graph of our model using pytensor</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>printing.pydotprint(rewrite_graph(impressions_x4), outfile<span class="op">=</span><span class="st">"images/impressions.png"</span>, var_with_name_simple<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the generated graph</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>Image(filename<span class="op">=</span><span class="st">"images/impressions.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If, you don’t like to see the graphical version, you can ask for the string representation.</p>
<div id="6f0667ec" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dprint the target_var</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>rewrite_graph(impressions_x4).dprint(depth<span class="op">=</span><span class="dv">5</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
<p>Now, let’s define our forward pass - how media exposure actually impacts our target variable. In marketing, we typically see two key effects: saturation (diminishing returns) and lagging (delayed impact). We’ll model these using the Michaelis-Menten function for saturation and Geometric Adstock for the lagging effects.</p>
<div id="ec5cfd39" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating forward pass for impressions</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_pass(x, adstock_alpha, saturation_lam, saturation_alpha):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return type pytensor.tensor.variable.TensorVariable</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MichaelisMentenSaturation.function(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        MichaelisMentenSaturation, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>GeometricAdstock(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            l_max<span class="op">=</span><span class="dv">24</span>, normalize<span class="op">=</span><span class="va">False</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        ).function(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>x, alpha<span class="op">=</span>adstock_alpha,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        ), lam<span class="op">=</span>saturation_lam, alpha<span class="op">=</span>saturation_alpha,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying forward pass to impressions</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scalars variables for the parameters x2, x3, x4</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x2 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x2"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x2 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x2"</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x3 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x3"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x3 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x3"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x4 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x4"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x4 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x4"</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>pt_global_adstock_effect <span class="op">=</span> pt.scalar(<span class="st">"global_adstock_alpha"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply forward pass to impressions</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>impressions_x2_forward <span class="op">=</span> forward_pass(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    impressions_x2, </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x2, </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x2</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>impressions_x3_forward <span class="op">=</span> forward_pass(</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    impressions_x3, </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x3, </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x3</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>impressions_x4_forward <span class="op">=</span> forward_pass(</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    impressions_x4, </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x4, </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x4</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With all of the following in place, we can define the causal DAG for the target variable and the structural equation as the sum of all previous variables.</p>
<div id="93d3c549" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot graphviz causal dag for the target_var</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Graphviz object</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>dot <span class="op">=</span> graphviz.Digraph(comment<span class="op">=</span><span class="st">'Causal DAG for Target Variable'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add nodes for each variable</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x1'</span>, <span class="st">'Spend X1'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x2'</span>, <span class="st">'Spend X2'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x3'</span>, <span class="st">'Spend X3'</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x4'</span>, <span class="st">'Spend X4'</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'trend'</span>, <span class="st">'Trend'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'global_noise'</span>, <span class="st">'Global Noise'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'event_contributions'</span>, <span class="st">'Events'</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'product_price_contribution'</span>, <span class="st">'Product Price Contribution'</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x1'</span>, <span class="st">'impressions_x1'</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x2'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x3'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x4'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x1'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'trend'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'global_noise'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'product_price_contribution'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x3'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x4'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the graph</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>dot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><span class="math display">\[
\begin{align}
\text{Target} &amp;\sim \sum_{i \in \{2,3,4\}} f_i(\text{impressions}_i) + \\
&amp;\text{event\_contributions} + \\
&amp;\text{product\_price\_contribution} + \\
&amp;\text{trend} + \\
&amp;\text{noise}
\end{align}
\]</span></p>
<p>Where <span class="math inline">\(f_i\)</span> represents the forward pass function (adstock and saturation) applied to each channel’s impressions.</p>
<div id="dd589fb2" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>target_var <span class="op">=</span> rewrite_graph(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    impressions_x4_forward <span class="op">+</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    impressions_x3_forward <span class="op">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    impressions_x2_forward <span class="op">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    pt_event_contributions <span class="op">+</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    pt_product_price_contribution <span class="op">+</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    trend <span class="op">+</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    global_noise</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Eval target_var and plot</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>np_target_var <span class="op">=</span> target_var.<span class="bu">eval</span>({</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: pz_spend_x2,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x2"</span>: <span class="fl">.5</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x2"</span>: <span class="fl">.2</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x4"</span>: <span class="fl">.2</span>,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x4"</span>: <span class="fl">.1</span>,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_adstock_alpha"</span>: <span class="fl">.2</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_contributions"</span>: np_event_contributions[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value,</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: np_trend,</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_noise"</span>: pz_global_noise,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>plt.plot(np_target_var, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Target Variable Over Time'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time Period'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Target Value'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, we can imagine our dataframe in this case will be something like the following:</p>
<div id="bb8d9e6e" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataset with impressions x1, x2, x3, x4 and target_var</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>scaler_factor_for_all <span class="op">=</span> <span class="dv">150</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(start<span class="op">=</span><span class="st">'2020-01-01'</span>, periods<span class="op">=</span>n_observations, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: dates,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target_var"</span>: np.<span class="bu">round</span>(np_target_var <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x1"</span>: np.<span class="bu">round</span>(impressions_x1.<span class="bu">eval</span>(x1_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x2"</span>: np.<span class="bu">round</span>(impressions_x2.<span class="bu">eval</span>(x2_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x3"</span>: np.<span class="bu">round</span>(impressions_x3.<span class="bu">eval</span>(x3_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x4"</span>: np.<span class="bu">round</span>(impressions_x4.<span class="bu">eval</span>(x4_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">0</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_12"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">1</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">2</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_12"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">3</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2022_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">4</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"trend"</span>] <span class="op">=</span> data.index</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we don’t think in a causal way, we will probably just say, “lets add all to the blender”.</p>
<div id="0cd9a487" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Building priors for adstock and saturation</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>adstock_priors <span class="op">=</span> {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>: Prior(<span class="st">"Beta"</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>, dims<span class="op">=</span><span class="st">"channel"</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>adstock <span class="op">=</span> GeometricAdstock(l_max<span class="op">=</span><span class="dv">28</span>, priors<span class="op">=</span>adstock_priors)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>saturation_priors <span class="op">=</span> {</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lam"</span>: Prior(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gamma"</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"channel"</span>,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>: Prior(</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gamma"</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span><span class="fl">.5</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span><span class="fl">.5</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"channel"</span>,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>saturation <span class="op">=</span> MichaelisMentenSaturation(priors<span class="op">=</span>saturation_priors)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into train and test sets</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>train_idx <span class="op">=</span> <span class="dv">879</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> data.iloc[:train_idx].drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>])</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> data.iloc[train_idx:].drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>])</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> data.iloc[:train_idx][<span class="st">"target_var"</span>]</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> data.iloc[train_idx:][<span class="st">"target_var"</span>]</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>control_columns <span class="op">=</span> [</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_09"</span>, <span class="st">"event_2020_12"</span>, </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_09"</span>, <span class="st">"event_2021_12"</span>, </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2022_09"</span>,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>channel_columns <span class="op">=</span> [</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    col <span class="cf">for</span> col <span class="kw">in</span> X_train.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> control_columns <span class="kw">and</span> col <span class="op">!=</span> <span class="st">"date"</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Model config</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>model_config <span class="op">=</span> {</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"likelihood"</span>: Prior(</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TruncatedNormal"</span>,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        lower<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span>Prior(<span class="st">"HalfNormal"</span>, sigma<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="co"># sampling options for PyMC</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>sample_kwargs <span class="op">=</span> {</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tune"</span>: <span class="dv">1000</span>,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"draws"</span>: <span class="dv">500</span>,</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"chains"</span>: <span class="dv">4</span>,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: <span class="dv">42</span>,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target_accept"</span>: <span class="fl">0.94</span>,</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuts_sampler"</span>: <span class="st">"nutpie"</span>,</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>non_causal_mmm <span class="op">=</span> MMM(</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>channel_columns,</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.build_model(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Building the model
</div>
</div>
<div class="callout-body-container callout-body">
<p>All PyMC models are structural causal models, which means they represent the causal generative process of the data. We can visualize this process through a Directed Acyclic Graph (DAG) that shows how variables influence each other in the model.</p>
<div id="2bcf42ff" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.model.to_graphviz()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
<p>Once the model is build, we can train it.</p>
<div id="d0f8fb96" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.fit(X_train, y_train,)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.sample_posterior_predictive(X_train, extend_idata<span class="op">=</span><span class="va">True</span>, combined<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are happy with our model, we don’t get any divergencies, and the sampling looks good.</p>
<div id="3a70b1bc" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of diverging samples</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total divergencies: </span><span class="sc">{</span>non_causal_mmm<span class="sc">.</span>idata[<span class="st">'sample_stats'</span>][<span class="st">'diverging'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>az.summary(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>non_causal_mmm.fit_result,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"intercept"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"y_sigma"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"saturation_alpha"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"saturation_lam"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"adstock_alpha"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If our model has a correct understanding of causality, we can use it to perform a do-calculus to estimate the effect of our channel, using out of sample (sampling from the posterior). Mathematically, we want to compute the causal effect as the difference between two interventions: <span class="math display">\[P(Y|do(X=x)) - P(Y|do(X=0))\]</span></p>
<p>This should allows us to isolate the causal impact of our marketing channels on the outcome variable.</p>
<div id="50970096" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero <span class="op">=</span> X_test.copy()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero[<span class="st">"impressions_x2"</span>].iloc[:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero <span class="op">=</span> non_causal_mmm.sample_posterior_predictive(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    X_test_x2_zero, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>y_do_x2 <span class="op">=</span> non_causal_mmm.sample_posterior_predictive(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    X_test, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have both posteriors, we can compute the difference between the period with the index 880-890 and plot the causal effect and the cumulative causal effect.</p>
<div id="06feccf7" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>x2_causal_effect <span class="op">=</span> (y_do_x2_zero <span class="op">-</span> y_do_x2).y</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dates from the coordinates for x-axis</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> x2_causal_effect.coords[<span class="st">'date'</span>].values[:<span class="dv">100</span>]  <span class="co"># Take only first 100 days</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the causal effect</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>mean_effect <span class="op">=</span> x2_causal_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># For cumulative effect, compute quantiles directly from cumulative sums</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>cum_effect <span class="op">=</span> x2_causal_effect.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>cum_mean <span class="op">=</span> cum_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In reality, in order to validate the following estimated effect, we’ll need to run an actual experiment. Because we did the data generation process we can run this actual experiment to compare.</p>
<div id="bbd7ff48" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an intervened spend_x2 with zeros between index 880 and 980</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>intervened_spend_x2 <span class="op">=</span> pz_spend_x2.copy()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>intervened_spend_x2[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate target variable with the intervention</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>np_target_var_x2_zero <span class="op">=</span> target_var.<span class="bu">eval</span>({</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: intervened_spend_x2,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x2"</span>: <span class="fl">.5</span>,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x2"</span>: <span class="fl">.2</span>,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x4"</span>: <span class="fl">.2</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x4"</span>: <span class="fl">.1</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_adstock_alpha"</span>: <span class="fl">.2</span>,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_contributions"</span>: np_event_contributions[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: np_trend,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_noise"</span>: pz_global_noise,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co"># x2 total effect y | do(x2=&gt;1) - y | do(x2=0)</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>x2_intervention_real_effect <span class="op">=</span> np_target_var_x2_zero <span class="op">-</span> np_target_var</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>x2_intervention_real_cumulative_effect <span class="op">=</span> np.cumsum(x2_intervention_real_effect)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot both the intervention effect and cumulative effect</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the daily effect</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>daily_effect <span class="op">=</span> x2_intervention_real_effect[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">*</span> scaler_factor_for_all</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>cumulative_effect <span class="op">=</span> x2_intervention_real_cumulative_effect[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">*</span> scaler_factor_for_all</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>How does compare to the recovered effect? Let’s observe! 👀</p>
<div id="2f82f4dc" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure to compare real effects with estimated effects</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The initial model have been under estimating the effect of <span class="math inline">\(X2\)</span>. We can see the model was thinking we’ll loosing almost none users when in reality wi’ll loose around 600 in total. Maybe we did something wrong? Are we maybe the wrong causal question?</p>
<p>That doesn’t matter, we have calibration! 🤪</p>
<p>Lets compute the observable delta in Y and observable delta in X and use it for calibration.</p>
<div id="235cb990" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>intervened_channel <span class="op">=</span> <span class="st">"impressions_x2"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>total_observed_effect <span class="op">=</span> cumulative_effect[<span class="op">-</span><span class="dv">1</span>] <span class="co"># delta Y</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>total_previous_imp_before_intervention <span class="op">=</span> X_train[intervened_channel].iloc[<span class="op">-</span><span class="dv">100</span>:].<span class="bu">sum</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>total_change_imp_during_intervention <span class="op">=</span> <span class="op">-</span>X_train[intervened_channel].iloc[<span class="op">-</span><span class="dv">100</span>:].<span class="bu">sum</span>()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.3</span> <span class="co"># confidence in the experiment.</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>df_lift_test <span class="op">=</span> pd.DataFrame(</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    [{</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"channel"</span>: intervened_channel,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"x"</span>: total_previous_imp_before_intervention,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_x"</span>: total_change_imp_during_intervention,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_y"</span>: total_observed_effect,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma"</span>: sigma,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>intervened_data <span class="op">=</span> data.copy()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>intervened_data.loc[<span class="dv">880</span>:<span class="dv">980</span>, <span class="st">"impressions_x2"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2 <span class="op">=</span> MMM(</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>channel_columns,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.build_model(</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    intervened_data[<span class="st">"target_var"</span>]</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.add_lift_test_measurements(df_lift_test)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.model.to_graphviz()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As we can see a new observational point have been added to our data. This new point must be satisfied as the rest of our data, pooling parameter into a new direction.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In a Bayesian model, each observation—whether it is a daily data point <span class="math inline">\(y_t\)</span> or a lift measurement <span class="math inline">\(\Delta y\)</span>—contributes a term to the likelihood. The posterior arises from the product of all these likelihood terms and the prior(s). In other words, theres no actual difference between priors and data, they both carry the same weight and multiply in the numerator of Bayes theorem. There’s no discrete “decision” about which part of the data (or which prior) to weight more; it all goes into the same log‐posterior function. The sampling or optimization algorithm (MCMC, variational inference, etc.) explores the parameter space in proportion to the posterior probability (which is prior × likelihood). Whichever parameters jointly give higher posterior density get visited more often by the sampler.</p>
</div>
</div>
<div id="ab818231" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.fit(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    intervened_data[<span class="st">"target_var"</span>],</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.sample_posterior_predictive(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that our model is ready, we can check the new estimated effect.</p>
<div id="c8b85e68" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero_second_model <span class="op">=</span> non_causal_mmm2.idata.posterior_predictive.copy()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>y_do_x2_second_model <span class="op">=</span> non_causal_mmm2.sample_posterior_predictive(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>x2_causal_effect_second_model <span class="op">=</span> (y_do_x2_zero_second_model.y <span class="op">-</span> y_do_x2_second_model.y).isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">880</span>, <span class="dv">980</span>))</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the causal effect</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>mean_effect_second_model <span class="op">=</span> x2_causal_effect_second_model.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>,<span class="st">"draw"</span>])</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, mean_effect_second_model)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># For cumulative effect, compute quantiles directly from cumulative sums</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>cum_effect_second_model <span class="op">=</span> x2_causal_effect_second_model.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>cum_mean_second_model <span class="op">=</span> cum_effect_second_model.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>,<span class="st">"draw"</span>])</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, cum_mean_second_model)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As you can see the effect looks fully different. The size is 1000X higher than before. Let’s compare!</p>
<div id="298f314b" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure to compare real effects with estimated effects</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, mean_effect_second_model, label<span class="op">=</span><span class="st">'Estimated Effect (2)'</span>, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, cum_mean_second_model, </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect (2)'</span>, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As expected the new observation makes the model add more credit to X2 but this came with the price of an overestimation of the true impact. Meanwhile, it was true that X2 impact was bigger than the original one, the second model absorbe all the variability possibly explain by other variables such as X1, X3 and bring a 1000X more extra impact, with a very tight posterior.</p>
<div id="fdcb7177" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the recovered mean daily contribution as distribution.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>channels_contribution_original_scale_model1 <span class="op">=</span> non_causal_mmm.compute_channel_contribution_original_scale()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>channels_contribution_original_scale_model2 <span class="op">=</span> non_causal_mmm2.compute_channel_contribution_original_scale()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>_dist1 <span class="op">=</span> channels_contribution_original_scale_model1.isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">800</span>)).mean(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    dim<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>).sel(channel<span class="op">=</span><span class="st">"impressions_x2"</span>).values.flatten()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>_dist2 <span class="op">=</span> channels_contribution_original_scale_model2.isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">800</span>)).mean(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    dim<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>).sel(channel<span class="op">=</span><span class="st">"impressions_x2"</span>).values.flatten()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co"># First subplot for Model 1</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(_dist1, shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">"Model 1"</span>, bw_adjust<span class="op">=</span><span class="fl">4.5</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Channel X2 Contribution - Model 1"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Contribution Value"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Second subplot for Model 2</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(_dist2, shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">"Model 2"</span>, bw_adjust<span class="op">=</span><span class="fl">4.5</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Channel X2 Contribution - Model 2"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Contribution Value"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Danger of Tight Posteriors
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s important to note that a tight posterior distribution (like we see in Model 2) should never be understood as the model being more correct or certain about the true causal effect. This is a common misconception in Bayesian analysis.</p>
<p>A tight posterior simply means the model is very confident in its estimates given the data and prior assumptions it has, but says nothing about whether those assumptions are correct. In this case, the addition of the lift test measurement has created a model that is very confident in an incorrect answer.</p>
<p>This illustrates an important principle in causal inference and Bayesian modeling: <strong>precision is not the same as accuracy</strong>. A model can be precisely wrong - having a narrow posterior around an incorrect value. This often happens when:</p>
<ol type="1">
<li>The model structure doesn’t match the true causal process</li>
<li>Important confounders are omitted</li>
<li>The priors or likelihood are misspecified</li>
</ol>
</div>
</div>
<p>Why all the following happened? lets take a look to the graph.</p>
<div id="9ab7f4df" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This DAG shows:</p>
<ol type="1">
<li><p><strong>Direct Spend-to-Impression Relationships</strong>: Each spend variable (X1-X4) directly influences its corresponding impression variable.</p></li>
<li><p><strong>Cross-Channel Effects</strong>:</p>
<ul>
<li>Impressions from X1 influence impressions from X3</li>
<li>Impressions from X2 influence both X3 and X4 impressions</li>
<li>Events influence impressions for X2 and X3</li>
</ul></li>
</ol>
<p>If we were to build a naive regression model including all variables (X1, X2, X3, X4), we would encounter significant estimation problems, particularly for X2. According to Pearl’s causal theory.</p>
<section id="collider-bias" class="level3">
<h3 class="anchored" data-anchor-id="collider-bias">1. Collider Bias</h3>
<p>In our graph, X2 influences X3 and X4, which both influence the target variable. This creates a collider structure where conditioning on x1 variable because induces a spurious correlation between X2, X3. This violates the independence assumptions of standard regression.</p>
</section>
<section id="mediator-effects" class="level3">
<h3 class="anchored" data-anchor-id="mediator-effects">2. Mediator Effects</h3>
<p>X2 has both direct effects on the target variable and indirect effects through X3 and X4. A naive regression would conflate these paths, leading to inconsistent estimates of X2’s true total causal effect.</p>
</section>
<section id="confounding-from-events" class="level3">
<h3 class="anchored" data-anchor-id="confounding-from-events">3. Confounding from Events</h3>
<p>Events influence both X2 impressions and the target variable directly. Without properly accounting for this common cause, the estimate for X2 will capture some of the effect that actually comes from events.</p>
<p>All the above means, in order to estimate the effect of X2 we need to address the primal causal questions.</p>
</section>
<section id="minimal-adjustment-set-for-x2" class="level3">
<h3 class="anchored" data-anchor-id="minimal-adjustment-set-for-x2">4. Minimal Adjustment Set for X2</h3>
<p>To estimate the total causal effect of X2 on the target variable, we need to identify the minimal adjustment set that blocks all non-causal paths while preserving the causal paths. According to Pearl’s backdoor criterion, we must control for any confounders (common causes) while avoiding adjusting for colliders or mediators. In our DAG, the minimal adjustment set for estimating X2’s total effect would include Events (as it’s a confounder affecting both X2 and the target) and Spend X1 (as it influences the target through X3, creating a backdoor path). We should not adjust for impressions_x3 or impressions_x4, as these are mediators through which X2 partially exerts its effect on the target variable. Nevertheless, events are a cofounder of X2, meaning, we need to control for them if we want to get the estimates right on spot.</p>
<p>The proper identification of this minimal adjustment set is crucial for unbiased estimation. If we control for too few variables, confounding bias remains. If we control for mediators, we block part of the causal effect we’re trying to measure. This highlights why structural causal models are superior to naive regression approaches - they allow us to explicitly model the causal pathways and make appropriate adjustments based on causal reasoning rather than statistical correlation. By conditioning only on the minimal adjustment set, we can obtain a consistent estimate of X2’s total causal effect, including both its direct impact and indirect effects through other channels.</p>
<p>So, let’s see what happen if we apply causal theory 😃</p>
<div id="cb643f34" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lets rebuild our media mix model</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>causal_mmm <span class="op">=</span> MMM(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>[<span class="st">"impressions_x2"</span>],</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>causal_mmm.fit(X_train, y_train,)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>causal_mmm.sample_posterior_predictive(X_train, extend_idata<span class="op">=</span><span class="va">True</span>, combined<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, lets repeat again the estimation of the effect when X2 is zero.</p>
<div id="bc882a79" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero <span class="op">=</span> X_test.copy()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero[<span class="st">"impressions_x2"</span>].iloc[:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero_causal <span class="op">=</span> causal_mmm.sample_posterior_predictive(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    X_test_x2_zero, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>y_do_x2_causal <span class="op">=</span> causal_mmm.sample_posterior_predictive(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    X_test, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>x2_causal_effect_causal <span class="op">=</span> (y_do_x2_zero_causal <span class="op">-</span> y_do_x2_causal).y</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dates from the coordinates for x-axis</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> x2_causal_effect_causal.coords[<span class="st">'date'</span>].values[:<span class="dv">100</span>]  <span class="co"># Take only first 100 days</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>mean_effect <span class="op">=</span> x2_causal_effect_causal.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>cum_effect <span class="op">=</span> x2_causal_effect_causal.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>cum_mean <span class="op">=</span> cum_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Great, as expected the true causal effect for X2 was recovered, and its possible to prove with an experiment. This just prove that maths are not magic, and that if we want to create models that explain the dynamics of the world, we need to use causal reasoning to it 🔥🙌🏻</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The evidence is clear: calibration cannot rescue a misspecified causal model. We’ve seen that:</p>
<ul>
<li><strong>Causal misspecification persists despite calibration.</strong> Our Model 2 became confidently wrong after calibration—tight posteriors around incorrect values.</li>
<li><strong>Colliders and mediators matter.</strong> Standard MMMs ignore that marketing channels influence each other, creating spurious correlations that no amount of experimental data can fix.</li>
<li><strong>Adjustment sets are crucial.</strong> Simply including every variable yields biased estimates; we must control only for confounders while preserving causal pathways.</li>
</ul>
<p>When we finally built a causally-aware MMM—controlling for events as confounders but avoiding adjustment for mediators—our estimates matched the ground truth. The same experimental evidence that couldn’t rescue our misspecified model perfectly aligned with our correctly specified one.</p>
<p>The message: invest in causal discovery before calibration. Draw your DAGs. Identify your minimal adjustment sets. No amount of experimental evidence will save a model asking the wrong causal question.</p>
<p>As Pearl might say: statistics tells us <em>what</em> the data says; causality tells us <em>what</em> to do with it.</p>
<p>Calibration without causation is just computation without comprehension!</p>
<div id="c6621059" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">-</span>n <span class="op">-</span>u <span class="op">-</span>v <span class="op">-</span>iv <span class="op">-</span>w <span class="op">-</span>p pymc_marketing,pytensor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/cetagostini\.github\.io\/cetagostini\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Media Mix Model calibration is useless without causal knowledge"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-04-01"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [python, experimentation, media mix modeling, mmm, bayesian, pymc, pydata, germany, darmstadt]</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "../images/nomore_experiments_without_causality.png"</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> cetagostini_web</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>Imagine you just shipped a shiny new Bayesian Media-Mix Model (MMM) that *perfectly* back-fits years of marketing data. A/B-lift experiments then tell you channel-A is worth **€2.7 M**, but your model insists it is worth **€7 M**. "Easy fix," you think: *calibrate* the MMM with the lift tests—add an extra likelihood term, rerun, publish.</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>Yet the calibrated model still over/under-values the channel based on the experimental evidence. Looks like it can't reconcile the experimental evidence with the data, and adding new calibration for other channels actually makes it worse.</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>That is the calibration trap: without causal structure the posterior can't happily reconcile observations and **clean** experiments at the same time.</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>In this article we will build a PyMC MMM, add lift-test calibration, and then show—step-by-step—why calibration alone cannot save a misspecified causal story.</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu"># Why marketers love calibration</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Ground-truth anchor.** Lift tests are randomised, so their incremental effects are (almost) unbiased.  </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Sample-size boost.** MMMs see every day and every channel; experiments see only a slice. Combining them promises lower variance.  </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Storytelling power.** "Our model *matches* the experiments" is an executive-friendly sound-bite.</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>Calibration therefore feels like catching two Bayesian birds with one conjugate stone.</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="fu"># What *is* calibration—mathematically?</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>For each experiment $i$ the model predicts a lift</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>\widehat{\Delta y_i}(\theta)\;=\;</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>s\bigl(x_i+\Delta x_i;\,\theta_{c(i)}\bigr)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>\;-\;</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>s\bigl(x_i;\,\theta_{c(i)}\bigr),</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>$$  </span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>where  </span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$x_i$ – baseline spend before the experiment,  </span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\Delta x_i$ – change in spend during the experiment,  </span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$s(\cdot;\theta_{c(i)})$ – saturation curve for the channel that experiment $i$ targets,  </span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\theta$ – all saturation-curve parameters,  </span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\widehat{\Delta y_i}(\theta)$ – model-predicted incremental outcome.</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>We then attach the observed lift $\Delta y_i$ and its error $\sigma_i$ through an additional likelihood</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>p<span class="sc">\!</span>\bigl(\Delta y_i \mid \theta\bigr)\;=\;</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>\operatorname{Gamma}<span class="sc">\!</span>\bigl(</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>\mu=\lvert\widehat{\Delta y_i}(\theta)\rvert,\;</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>\sigma=\sigma_i</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>\bigr),</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>$$  </span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>where  </span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\Delta y_i$ – experimentally measured incremental outcome,  </span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\sigma_i$ – reported standard error of $\Delta y_i$,  </span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\mu$ – mean parameter set to the *absolute* predicted lift so the Gamma remains non-negative.</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>Stacking all $n_{\text{lift}}$ experiments gives the calibrated posterior</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>p<span class="sc">\!</span>\bigl(\theta \mid \mathbf y,\mathcal L\bigr)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>\;\propto\;</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>p<span class="sc">\!</span>\bigl(\mathbf y \mid \theta\bigr)\;</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>\prod_{i=1}^{n_{\text{lift}}}</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>p<span class="sc">\!</span>\bigl(\Delta y_i \mid \theta\bigr)\;</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>p(\theta),</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>$$  </span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>where  </span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\mathbf y$ – full time-series of observed outcomes (sales, sign-ups …),  </span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\mathcal L$ – the collection of lift-test observations $(\Delta y_i,\sigma_i)$,  </span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$p(\theta)$ – priors for all parameters.</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>PyMC turns this into a three-liner:  </span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>add_lift_measurements_to_likelihood_from_saturation(</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>mmm,</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>    df_lift<span class="op">=</span>df_lifts,     <span class="co"># experiment data-frame</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>    dist<span class="op">=</span>pm.Gamma,</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>In simple terms, calibration appends one extra likelihood per experiment: for lift <span class="in">`i`</span> we run the channel's saturation curve at the pre-spend and post-spend levels, subtract the two, and call that result the model-expected incremental response for experiment <span class="in">`i`</span> (a deterministic function of the saturation parameter vector $\theta$). We then treat the observed lift $\Delta y_i$ as a Gamma-distributed draw whose mean is the absolute value of that model-expected increment and whose dispersion is the experiment's reported standard error $\sigma_i$. </span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>These independent $\Gamma(\mu = |\text{model-expected increment}|, \sigma = \sigma_i)$ factors multiply into the original time-series likelihood, yielding a posterior where $\theta$ is pulled toward values that keep every model-expected increment within the experimental noise band. In effect, each lift test imposes a Bayesian anchor that penalises any parameter setting whose predicted causal effect disagrees with ground-truth, while still allowing the full sales history to inform the remaining uncertainty.</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>Let's see how this works in practice, by creating a synthetic dataset and fitting a simple MMM.</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a><span class="fu"># Getting started</span></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>We'll use Pytensor to run our data-generation-process (DGP). Let's set the seed for reproducibility, and define the number of observations, and finally add some default configurations for the notebook.</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> pt</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytensor.graph <span class="im">import</span> rewrite_graph</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> preliz <span class="im">as</span> pz</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphviz</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.mmm <span class="im">import</span> GeometricAdstock, MichaelisMentenSaturation, MMM</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc_marketing.prior <span class="im">import</span> Prior</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>n_observations <span class="op">=</span> <span class="dv">1050</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the style</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-darkgrid"</span>)</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.dpi"</span>] <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"xtick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"ytick.labelsize"</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">"retina"</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>Now, we can define the date range.</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>min_date <span class="op">=</span> pd.to_datetime(<span class="st">"2022-01-01"</span>)</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>max_date <span class="op">=</span> min_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>n_observations)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>date_range <span class="op">=</span> pd.date_range(start<span class="op">=</span>min_date, end<span class="op">=</span>max_date, freq<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span>{<span class="st">"date_week"</span>: date_range}).assign(</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.year,</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>    month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.month,</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>    dayofyear<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date_week"</span>].dt.dayofyear,</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>We can start by creating the spend vectors for each channel. These are the will define later the amount of impressions or exposition we get from each channel, which by the end will transform into sales.</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>spend_x1 <span class="op">=</span> pt.vector(<span class="st">"spend_x1"</span>)</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>spend_x2 <span class="op">=</span> pt.vector(<span class="st">"spend_x2"</span>)</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>spend_x3 <span class="op">=</span> pt.vector(<span class="st">"spend_x3"</span>)</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>spend_x4 <span class="op">=</span> pt.vector(<span class="st">"spend_x4"</span>)</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample inputs for demonstration using preliz distributions:</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>pz_spend_x1 <span class="op">=</span> np.convolve(</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.8</span>, sigma<span class="op">=</span><span class="fl">.3</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>pz_spend_x1[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x1.mean()</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>pz_spend_x1[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x1.mean()</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>pz_spend_x2 <span class="op">=</span> np.convolve(</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.6</span>, sigma<span class="op">=</span><span class="fl">.4</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>pz_spend_x2[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x2.mean()</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>pz_spend_x2[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x2.mean()</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>pz_spend_x3 <span class="op">=</span> np.convolve(</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.2</span>, sigma<span class="op">=</span><span class="fl">.2</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>pz_spend_x3[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x3.mean()</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>pz_spend_x3[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x3.mean()</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>pz_spend_x4 <span class="op">=</span> np.convolve(</span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.1</span>, sigma<span class="op">=</span><span class="fl">.03</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>pz_spend_x4[:<span class="dv">14</span>] <span class="op">=</span> pz_spend_x4.mean()</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>pz_spend_x4[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_spend_x4.mean()</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x1, label<span class="op">=</span><span class="st">'Channel 1'</span>)</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x2, label<span class="op">=</span><span class="st">'Channel 2'</span>)</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x3, label<span class="op">=</span><span class="st">'Channel 3'</span>)</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>ax.plot(date_range[<span class="dv">1</span>:], pz_spend_x4, label<span class="op">=</span><span class="st">'Channel 4'</span>)</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Spend'</span>)</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>Using the same logic we can create other components such as trend, noise, seasonality, and certain events.</span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a><span class="co">## Trend</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>trend <span class="op">=</span> pt.vector(<span class="st">"trend"</span>)</span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the trend</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>np_trend <span class="op">=</span> (np.linspace(start<span class="op">=</span><span class="fl">0.0</span>, stop<span class="op">=</span><span class="fl">.50</span>, num<span class="op">=</span>n_observations) <span class="op">+</span> <span class="fl">.10</span>) <span class="op">**</span> (<span class="fl">.1</span> <span class="op">/</span> <span class="fl">.4</span>)</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a><span class="co">## NOISE </span></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>global_noise <span class="op">=</span> pt.vector(<span class="st">"global_noise"</span>)</span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the noise</span></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>pz_global_noise <span class="op">=</span> pz.Normal(mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">.005</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a><span class="co"># EVENTS EFFECT</span></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>pt_event_signal <span class="op">=</span> pt.vector(<span class="st">"event_signal"</span>)</span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>pt_event_contributions <span class="op">=</span> pt.vector(<span class="st">"event_contributions"</span>)</span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>event_dates <span class="op">=</span> [<span class="st">"24-12"</span>, <span class="st">"09-07"</span>]  <span class="co"># List of events as month-day strings</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>std_devs <span class="op">=</span> [<span class="dv">25</span>, <span class="dv">15</span>]  <span class="co"># List of standard deviations for each event</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>events_coefficients <span class="op">=</span> [<span class="fl">.094</span>, <span class="fl">.018</span>]</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>signals_independent <span class="op">=</span> []</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the event effect array</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>event_signal <span class="op">=</span> np.zeros(<span class="bu">len</span>(date_range))</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>event_contributions <span class="op">=</span> np.zeros(<span class="bu">len</span>(date_range))</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate event signals</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event, std_dev, event_coef <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>    event_dates, std_devs, events_coefficients, strict<span class="op">=</span><span class="va">False</span></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find all occurrences of the event in the date range</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>    event_occurrences <span class="op">=</span> date_range[date_range.strftime(<span class="st">"</span><span class="sc">%d</span><span class="st">-%m"</span>) <span class="op">==</span> event]</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> occurrence <span class="kw">in</span> event_occurrences:</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the time difference in days</span></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>        time_diff <span class="op">=</span> (date_range <span class="op">-</span> occurrence).days</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate the Gaussian basis for the event</span></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>        _event_signal <span class="op">=</span> np.exp(<span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> (time_diff <span class="op">/</span> std_dev) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the event signal to the event effect</span></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>        signals_independent.append(_event_signal)</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>        event_signal <span class="op">+=</span> _event_signal</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>        event_contributions <span class="op">+=</span> _event_signal <span class="op">*</span> event_coef</span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>np_event_signal <span class="op">=</span> event_signal</span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>np_event_contributions <span class="op">=</span> event_contributions</span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a>plt.plot(pz_global_noise, label<span class="op">=</span><span class="st">'Global Noise'</span>)</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a>plt.plot(np_trend, label<span class="op">=</span><span class="st">'Trend'</span>)</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a>plt.plot(np_event_signal, label<span class="op">=</span><span class="st">'Event Contributions'</span>)</span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Components of the Time Series Model'</span>)</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a>In order to make it more interesting, lets add a price variable. Usually, price creates more impact as it's slower. The product price contribution function we'll use is a diminishing returns function:</span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>$$f(X, \alpha, \lambda) = \frac{\alpha}{1 + (X / \lambda)}$$</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>where $\alpha$ represents the maximum contribution and $\lambda$ is a scaling parameter that controls how quickly the contribution diminishes as price increases.</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> product_price_contribution(X, alpha, lam):</span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> (X <span class="op">/</span> lam))</span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a product price vector.</span></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>product_price <span class="op">=</span> pt.vector(<span class="st">"product_price"</span>)</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>product_price_alpha <span class="op">=</span> pt.scalar(<span class="st">"product_price_alpha"</span>)</span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>product_price_lam <span class="op">=</span> pt.scalar(<span class="st">"product_price_lam"</span>)</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample input for the product price</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a>pz_product_price <span class="op">=</span> np.convolve(</span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>    pz.Gamma(mu<span class="op">=</span><span class="fl">.05</span>, sigma<span class="op">=</span><span class="fl">.02</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED), </span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a>    np.ones(<span class="dv">14</span>) <span class="op">/</span> <span class="dv">14</span>, mode<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a>pz_product_price[:<span class="dv">14</span>] <span class="op">=</span> pz_product_price.mean()</span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>pz_product_price[<span class="op">-</span><span class="dv">14</span>:] <span class="op">=</span> pz_product_price.mean()</span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>product_price_alpha_value <span class="op">=</span> <span class="fl">.08</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a>product_price_lam_value <span class="op">=</span> <span class="fl">.03</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct contribution to the target.</span></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>pt_product_price_contribution <span class="op">=</span> product_price_contribution(</span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a>    product_price, </span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>    product_price_alpha, </span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a>    product_price_lam</span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the product price contribution</span></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the raw price data</span></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>ax1.plot(pz_product_price, color<span class="op">=</span><span class="st">"green"</span>)</span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Product Price'</span>)</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Price'</span>)</span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the price contribution</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>price_contribution <span class="op">=</span> pt_product_price_contribution.<span class="bu">eval</span>({</span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>ax2.plot(price_contribution, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Price Contribution'</span>)</span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Time (days)'</span>)</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Contribution'</span>)</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>With all the principal components in place, all parent nodes we can start to write down our causal DAG to define the relationships we want to explain.</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot causal graph of the vars x1, x2, x3, x4 using graphviz</span></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a>cdag_impressions <span class="op">=</span> graphviz.Digraph(comment<span class="op">=</span><span class="st">'Causal DAG for Impressions'</span>)</span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x1'</span>, <span class="st">'Spend X1'</span>)</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x2'</span>, <span class="st">'Spend X2'</span>)</span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x3'</span>, <span class="st">'Spend X3'</span>)</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'spend_x4'</span>, <span class="st">'Spend X4'</span>)</span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a>cdag_impressions.node(<span class="st">'events'</span>, <span class="st">'Events'</span>)</span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x1'</span>, <span class="st">'impressions_x1'</span>)</span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x2'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x3'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'spend_x4'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x1'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'events'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a>cdag_impressions.edge(<span class="st">'events'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>cdag_impressions</span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>Once our causal graph is defined, we can start to write down in pytensor the structure and relationships.</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a impressions vector, result of x1, x2, x3, x4. by some beta with daily values.</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Define all parameters as PyTensor variables</span></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a>beta_x1 <span class="op">=</span> pt.vector(<span class="st">"beta_x1"</span>)</span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a>impressions_x1 <span class="op">=</span> spend_x1 <span class="op">*</span> beta_x1</span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>beta_x2 <span class="op">=</span> pt.vector(<span class="st">"beta_x2"</span>)</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>alpha_event_x2 <span class="op">=</span> pt.scalar(<span class="st">"alpha_event_x2"</span>)</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a>impressions_x2 <span class="op">=</span> spend_x2 <span class="op">*</span> beta_x2 <span class="op">+</span> pt_event_signal <span class="op">*</span> alpha_event_x2</span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>beta_x3 <span class="op">=</span> pt.vector(<span class="st">"beta_x3"</span>)</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>alpha_event_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_event_x3"</span>)</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>alpha_x1_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x1_x3"</span>)</span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>alpha_x2_x3 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x2_x3"</span>)</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>impressions_x3 <span class="op">=</span> spend_x3 <span class="op">*</span> beta_x3 <span class="op">+</span> pt_event_signal <span class="op">*</span> alpha_event_x3 <span class="op">+</span> (</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>    impressions_x2 <span class="op">*</span> alpha_x2_x3</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> impressions_x1 <span class="op">*</span> alpha_x1_x3</span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>beta_x4 <span class="op">=</span> pt.vector(<span class="st">"beta_x4"</span>)</span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>alpha_x2_x4 <span class="op">=</span> pt.scalar(<span class="st">"alpha_x2_x4"</span>)</span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>impressions_x4 <span class="op">=</span> spend_x4 <span class="op">*</span> beta_x4 <span class="op">+</span> impressions_x2 <span class="op">*</span> alpha_x2_x4</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample values for the parameters (to be used in eval)</span></span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a>pz_beta_x1 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">0.05</span>, beta<span class="op">=</span><span class="fl">.1</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>pz_beta_x2 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.015</span>, beta<span class="op">=</span><span class="fl">.05</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>pz_alpha_event_x2 <span class="op">=</span> <span class="fl">0.015</span></span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a>pz_beta_x3 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.1</span>, beta<span class="op">=</span><span class="fl">.1</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>pz_alpha_event_x3 <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>pz_alpha_x1_x3 <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>pz_alpha_x2_x3 <span class="op">=</span> <span class="fl">0.12</span></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>pz_beta_x4 <span class="op">=</span> pz.Beta(alpha<span class="op">=</span><span class="fl">.125</span>, beta<span class="op">=</span><span class="fl">.05</span>).rvs(size<span class="op">=</span>n_observations, random_state<span class="op">=</span>SEED)</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>pz_alpha_x2_x4 <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all impressions</span></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="co"># Define dependencies for each variable</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a>x1_deps <span class="op">=</span> {</span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>x2_deps <span class="op">=</span> {</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: pz_spend_x2,</span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],  <span class="co"># Slice to match 1050 length</span></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a><span class="co"># For x3, we need all dependencies from x1 and x2 plus its own</span></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a>x3_deps <span class="op">=</span> {</span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x1_deps,</span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x2_deps,</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a><span class="co"># For x4, we need dependencies from x2 plus its own</span></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a>x4_deps <span class="op">=</span> {</span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>x2_deps,</span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot each impression series</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, sharex<span class="op">=</span><span class="st">'row'</span>, sharey<span class="op">=</span><span class="st">'row'</span>)</span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 1</span></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(impressions_x1.<span class="bu">eval</span>(x1_deps), color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Channel 1'</span>)</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Impressions'</span>)</span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 2</span></span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].plot(impressions_x2.<span class="bu">eval</span>(x2_deps), color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Channel 2'</span>)</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 3</span></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].plot(impressions_x3.<span class="bu">eval</span>(x3_deps), color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Channel 3'</span>)</span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Impressions'</span>)</span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel 4</span></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].plot(impressions_x4.<span class="bu">eval</span>(x4_deps), color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Channel 4'</span>)</span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizing the computational graph</span></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a>In order to check we write down the process properly, we can ask PyTensor to print our structural causal model. This is not necessary for the analysis, but can be helpful for debugging and understanding the model structure.</span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.printing <span class="im">as</span> printing</span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the graph of our model using pytensor</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a>printing.pydotprint(rewrite_graph(impressions_x4), outfile<span class="op">=</span><span class="st">"images/impressions.png"</span>, var_with_name_simple<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the generated graph</span></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a>Image(filename<span class="op">=</span><span class="st">"images/impressions.png"</span>)</span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>If, you don't like to see the graphical version, you can ask for the string representation.</span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a><span class="co"># dprint the target_var</span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>rewrite_graph(impressions_x4).dprint(depth<span class="op">=</span><span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a>Now, let's define our forward pass - how media exposure actually impacts our target variable. In marketing, we typically see two key effects: saturation (diminishing returns) and lagging (delayed impact). We'll model these using the Michaelis-Menten function for saturation and Geometric Adstock for the lagging effects.</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating forward pass for impressions</span></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward_pass(x, adstock_alpha, saturation_lam, saturation_alpha):</span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return type pytensor.tensor.variable.TensorVariable</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MichaelisMentenSaturation.function(</span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>        MichaelisMentenSaturation, </span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>GeometricAdstock(</span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>            l_max<span class="op">=</span><span class="dv">24</span>, normalize<span class="op">=</span><span class="va">False</span></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a>        ).function(</span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>x, alpha<span class="op">=</span>adstock_alpha,</span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a>        ), lam<span class="op">=</span>saturation_lam, alpha<span class="op">=</span>saturation_alpha,</span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying forward pass to impressions</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scalars variables for the parameters x2, x3, x4</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x2 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x2"</span>)</span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x2 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x2"</span>)</span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x3 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x3"</span>)</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x3 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x3"</span>)</span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a>pt_saturation_lam_x4 <span class="op">=</span> pt.scalar(<span class="st">"saturation_lam_x4"</span>)</span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a>pt_saturation_alpha_x4 <span class="op">=</span> pt.scalar(<span class="st">"saturation_alpha_x4"</span>)</span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a>pt_global_adstock_effect <span class="op">=</span> pt.scalar(<span class="st">"global_adstock_alpha"</span>)</span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply forward pass to impressions</span></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>impressions_x2_forward <span class="op">=</span> forward_pass(</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a>    impressions_x2, </span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x2, </span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x2</span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a>impressions_x3_forward <span class="op">=</span> forward_pass(</span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a>    impressions_x3, </span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x3, </span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x3</span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>impressions_x4_forward <span class="op">=</span> forward_pass(</span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a>    impressions_x4, </span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a>    pt_global_adstock_effect, </span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a>    pt_saturation_lam_x4, </span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a>    pt_saturation_alpha_x4</span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>With all of the following in place, we can define the causal DAG for the target variable and the structural equation as the sum of all previous variables.</span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot graphviz causal dag for the target_var</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Graphviz object</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>dot <span class="op">=</span> graphviz.Digraph(comment<span class="op">=</span><span class="st">'Causal DAG for Target Variable'</span>)</span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a><span class="co"># Add nodes for each variable</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x1'</span>, <span class="st">'Spend X1'</span>)</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x2'</span>, <span class="st">'Spend X2'</span>)</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x3'</span>, <span class="st">'Spend X3'</span>)</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'spend_x4'</span>, <span class="st">'Spend X4'</span>)</span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'trend'</span>, <span class="st">'Trend'</span>)</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'global_noise'</span>, <span class="st">'Global Noise'</span>)</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'event_contributions'</span>, <span class="st">'Events'</span>)</span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>dot.node(<span class="st">'product_price_contribution'</span>, <span class="st">'Product Price Contribution'</span>)</span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x1'</span>, <span class="st">'impressions_x1'</span>)</span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x2'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x3'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'spend_x4'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x1'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'impressions_x4'</span>)</span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'impressions_x2'</span>)</span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'impressions_x3'</span>)</span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'trend'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'global_noise'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'event_contributions'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'product_price_contribution'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x2'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x3'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>dot.edge(<span class="st">'impressions_x4'</span>, <span class="st">'target_var'</span>)</span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the graph</span></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>dot</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>\text{Target} &amp;\sim \sum_{i \in <span class="sc">\{</span>2,3,4<span class="sc">\}</span>} f_i(\text{impressions}_i) + <span class="sc">\\</span></span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>&amp;\text{event<span class="sc">\_</span>contributions} + <span class="sc">\\</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>&amp;\text{product<span class="sc">\_</span>price<span class="sc">\_</span>contribution} + <span class="sc">\\</span></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>&amp;\text{trend} + <span class="sc">\\</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>&amp;\text{noise}</span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>Where $f_i$ represents the forward pass function (adstock and saturation) applied to each channel's impressions.</span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>target_var <span class="op">=</span> rewrite_graph(</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>    impressions_x4_forward <span class="op">+</span> </span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>    impressions_x3_forward <span class="op">+</span></span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a>    impressions_x2_forward <span class="op">+</span></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>    pt_event_contributions <span class="op">+</span></span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>    pt_product_price_contribution <span class="op">+</span> </span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>    trend <span class="op">+</span> </span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>    global_noise</span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a><span class="co"># Eval target_var and plot</span></span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>np_target_var <span class="op">=</span> target_var.<span class="bu">eval</span>({</span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: pz_spend_x2,</span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x2"</span>: <span class="fl">.5</span>,</span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x2"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x4"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x4"</span>: <span class="fl">.1</span>,</span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_adstock_alpha"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_contributions"</span>: np_event_contributions[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value,</span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: np_trend,</span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_noise"</span>: pz_global_noise,</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a>plt.plot(np_target_var, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Target Variable Over Time'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time Period'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Target Value'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a>Now, we can imagine our dataframe in this case will be something like the following:</span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataset with impressions x1, x2, x3, x4 and target_var</span></span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a>scaler_factor_for_all <span class="op">=</span> <span class="dv">150</span></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(start<span class="op">=</span><span class="st">'2020-01-01'</span>, periods<span class="op">=</span>n_observations, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: dates,</span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target_var"</span>: np.<span class="bu">round</span>(np_target_var <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x1"</span>: np.<span class="bu">round</span>(impressions_x1.<span class="bu">eval</span>(x1_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x2"</span>: np.<span class="bu">round</span>(impressions_x2.<span class="bu">eval</span>(x2_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x3"</span>: np.<span class="bu">round</span>(impressions_x3.<span class="bu">eval</span>(x3_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a>    <span class="st">"impressions_x4"</span>: np.<span class="bu">round</span>(impressions_x4.<span class="bu">eval</span>(x4_deps) <span class="op">*</span> scaler_factor_for_all, <span class="dv">4</span>),</span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">0</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_12"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">1</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">2</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_12"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">3</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2022_09"</span>: np.<span class="bu">round</span>(signals_independent[<span class="dv">4</span>][:<span class="op">-</span><span class="dv">1</span>], <span class="dv">4</span>),</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"trend"</span>] <span class="op">=</span> data.index</span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>data.head()</span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>If we don't think in a causal way, we will probably just say, "lets add all to the blender".</span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a><span class="co"># Building priors for adstock and saturation</span></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>adstock_priors <span class="op">=</span> {</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>: Prior(<span class="st">"Beta"</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>, dims<span class="op">=</span><span class="st">"channel"</span>),</span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a>adstock <span class="op">=</span> GeometricAdstock(l_max<span class="op">=</span><span class="dv">28</span>, priors<span class="op">=</span>adstock_priors)</span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a>saturation_priors <span class="op">=</span> {</span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lam"</span>: Prior(</span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gamma"</span>,</span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"channel"</span>,</span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>: Prior(</span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gamma"</span>,</span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span><span class="fl">.5</span>,</span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span><span class="fl">.5</span>,</span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"channel"</span>,</span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a>saturation <span class="op">=</span> MichaelisMentenSaturation(priors<span class="op">=</span>saturation_priors)</span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into train and test sets</span></span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a>train_idx <span class="op">=</span> <span class="dv">879</span></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> data.iloc[:train_idx].drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>])</span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> data.iloc[train_idx:].drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>])</span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> data.iloc[:train_idx][<span class="st">"target_var"</span>]</span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> data.iloc[train_idx:][<span class="st">"target_var"</span>]</span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a>control_columns <span class="op">=</span> [</span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2020_09"</span>, <span class="st">"event_2020_12"</span>, </span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2021_09"</span>, <span class="st">"event_2021_12"</span>, </span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_2022_09"</span>,</span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a>channel_columns <span class="op">=</span> [</span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a>    col <span class="cf">for</span> col <span class="kw">in</span> X_train.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> control_columns <span class="kw">and</span> col <span class="op">!=</span> <span class="st">"date"</span></span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Model config</span></span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a>model_config <span class="op">=</span> {</span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a>    <span class="st">"likelihood"</span>: Prior(</span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TruncatedNormal"</span>,</span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a>        lower<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a>        sigma<span class="op">=</span>Prior(<span class="st">"HalfNormal"</span>, sigma<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a><span class="co"># sampling options for PyMC</span></span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>sample_kwargs <span class="op">=</span> {</span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tune"</span>: <span class="dv">1000</span>,</span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>    <span class="st">"draws"</span>: <span class="dv">500</span>,</span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>    <span class="st">"chains"</span>: <span class="dv">4</span>,</span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_seed"</span>: <span class="dv">42</span>,</span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target_accept"</span>: <span class="fl">0.94</span>,</span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuts_sampler"</span>: <span class="st">"nutpie"</span>,</span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a>non_causal_mmm <span class="op">=</span> MMM(</span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>channel_columns,</span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.build_model(X_train, y_train)</span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a>:::callout-note</span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building the model</span></span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a>All PyMC models are structural causal models, which means they represent the causal generative process of the data. We can visualize this process through a Directed Acyclic Graph (DAG) that shows how variables influence each other in the model.</span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.model.to_graphviz()</span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a>Once the model is build, we can train it.</span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.fit(X_train, y_train,)</span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a>non_causal_mmm.sample_posterior_predictive(X_train, extend_idata<span class="op">=</span><span class="va">True</span>, combined<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a>We are happy with our model, we don't get any divergencies, and the sampling looks good.</span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of diverging samples</span></span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Total divergencies: </span><span class="sc">{</span>non_causal_mmm<span class="sc">.</span>idata[<span class="st">'sample_stats'</span>][<span class="st">'diverging'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a>az.summary(</span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>non_causal_mmm.fit_result,</span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[</span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>        <span class="st">"intercept"</span>,</span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>        <span class="st">"y_sigma"</span>,</span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a>        <span class="st">"saturation_alpha"</span>,</span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a>        <span class="st">"saturation_lam"</span>,</span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>        <span class="st">"adstock_alpha"</span>,</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a>If our model has a correct understanding of causality, we can use it to perform a do-calculus to estimate the effect of our channel, using out of sample (sampling from the posterior). Mathematically, we want to compute the causal effect as the difference between two interventions: $$P(Y|do(X=x)) - P(Y|do(X=0))$$</span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a>This should allows us to isolate the causal impact of our marketing channels on the outcome variable.</span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero <span class="op">=</span> X_test.copy()</span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero[<span class="st">"impressions_x2"</span>].iloc[:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero <span class="op">=</span> non_causal_mmm.sample_posterior_predictive(</span>
<span id="cb32-802"><a href="#cb32-802" aria-hidden="true" tabindex="-1"></a>    X_test_x2_zero, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-803"><a href="#cb32-803" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a>y_do_x2 <span class="op">=</span> non_causal_mmm.sample_posterior_predictive(</span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a>    X_test, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a>Now that we have both posteriors, we can compute the difference between the period with the index 880-890 and plot the causal effect and the cumulative causal effect.</span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a>x2_causal_effect <span class="op">=</span> (y_do_x2_zero <span class="op">-</span> y_do_x2).y</span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dates from the coordinates for x-axis</span></span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> x2_causal_effect.coords[<span class="st">'date'</span>].values[:<span class="dv">100</span>]  <span class="co"># Take only first 100 days</span></span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the causal effect</span></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a>mean_effect <span class="op">=</span> x2_causal_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb32-824"><a href="#cb32-824" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect)</span>
<span id="cb32-825"><a href="#cb32-825" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a><span class="co"># For cumulative effect, compute quantiles directly from cumulative sums</span></span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a>cum_effect <span class="op">=</span> x2_causal_effect.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a>cum_mean <span class="op">=</span> cum_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean)</span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a>In reality, in order to validate the following estimated effect, we'll need to run an actual experiment. Because we did the data generation process we can run this actual experiment to compare.</span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an intervened spend_x2 with zeros between index 880 and 980</span></span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a>intervened_spend_x2 <span class="op">=</span> pz_spend_x2.copy()</span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a>intervened_spend_x2[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate target variable with the intervention</span></span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a>np_target_var_x2_zero <span class="op">=</span> target_var.<span class="bu">eval</span>({</span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x4"</span>: pz_spend_x4,</span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x3"</span>: pz_spend_x3,</span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x2"</span>: intervened_spend_x2,</span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spend_x1"</span>: pz_spend_x1,</span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_signal"</span>: event_signal[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x2"</span>: pz_alpha_event_x2,</span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_event_x3"</span>: pz_alpha_event_x3,</span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x1_x3"</span>: pz_alpha_x1_x3,</span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x3"</span>: pz_alpha_x2_x3,</span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_x2_x4"</span>: pz_alpha_x2_x4,</span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x2"</span>: pz_beta_x2,</span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x3"</span>: pz_beta_x3,</span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x4"</span>: pz_beta_x4,</span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_x1"</span>: pz_beta_x1,</span>
<span id="cb32-870"><a href="#cb32-870" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x2"</span>: <span class="fl">.5</span>,</span>
<span id="cb32-871"><a href="#cb32-871" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x2"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x3"</span>: <span class="fl">.7</span>,</span>
<span id="cb32-874"><a href="#cb32-874" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_lam_x4"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-875"><a href="#cb32-875" aria-hidden="true" tabindex="-1"></a>    <span class="st">"saturation_alpha_x4"</span>: <span class="fl">.1</span>,</span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_adstock_alpha"</span>: <span class="fl">.2</span>,</span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price"</span>: pz_product_price,</span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a>    <span class="st">"event_contributions"</span>: np_event_contributions[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_alpha"</span>: product_price_alpha_value,</span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_price_lam"</span>: product_price_lam_value,</span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: np_trend,</span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a>    <span class="st">"global_noise"</span>: pz_global_noise,</span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a><span class="co"># x2 total effect y | do(x2=&gt;1) - y | do(x2=0)</span></span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a>x2_intervention_real_effect <span class="op">=</span> np_target_var_x2_zero <span class="op">-</span> np_target_var</span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a>x2_intervention_real_cumulative_effect <span class="op">=</span> np.cumsum(x2_intervention_real_effect)</span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot both the intervention effect and cumulative effect</span></span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the daily effect</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a>daily_effect <span class="op">=</span> x2_intervention_real_effect[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">*</span> scaler_factor_for_all</span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect)</span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a>cumulative_effect <span class="op">=</span> x2_intervention_real_cumulative_effect[<span class="dv">880</span>:<span class="dv">980</span>] <span class="op">*</span> scaler_factor_for_all</span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect)</span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-906"><a href="#cb32-906" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-907"><a href="#cb32-907" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-913"><a href="#cb32-913" aria-hidden="true" tabindex="-1"></a>How does compare to the recovered effect? Let's observe! 👀</span>
<span id="cb32-914"><a href="#cb32-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-917"><a href="#cb32-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure to compare real effects with estimated effects</span></span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-937"><a href="#cb32-937" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-938"><a href="#cb32-938" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a>The initial model have been under estimating the effect of $X2$. We can see the model was thinking we'll loosing almost none users when in reality wi'll loose around 600 in total. Maybe we did something wrong? Are we maybe the wrong causal question?</span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a>That doesn't matter, we have calibration! 🤪</span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a>Lets compute the observable delta in Y and observable delta in X and use it for calibration.</span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-954"><a href="#cb32-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-955"><a href="#cb32-955" aria-hidden="true" tabindex="-1"></a>intervened_channel <span class="op">=</span> <span class="st">"impressions_x2"</span></span>
<span id="cb32-956"><a href="#cb32-956" aria-hidden="true" tabindex="-1"></a>total_observed_effect <span class="op">=</span> cumulative_effect[<span class="op">-</span><span class="dv">1</span>] <span class="co"># delta Y</span></span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a>total_previous_imp_before_intervention <span class="op">=</span> X_train[intervened_channel].iloc[<span class="op">-</span><span class="dv">100</span>:].<span class="bu">sum</span>()</span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a>total_change_imp_during_intervention <span class="op">=</span> <span class="op">-</span>X_train[intervened_channel].iloc[<span class="op">-</span><span class="dv">100</span>:].<span class="bu">sum</span>()</span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.3</span> <span class="co"># confidence in the experiment.</span></span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a>df_lift_test <span class="op">=</span> pd.DataFrame(</span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a>    [{</span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a>        <span class="st">"channel"</span>: intervened_channel,</span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a>        <span class="st">"x"</span>: total_previous_imp_before_intervention,</span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_x"</span>: total_change_imp_during_intervention,</span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_y"</span>: total_observed_effect,</span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma"</span>: sigma,</span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a>intervened_data <span class="op">=</span> data.copy()</span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a>intervened_data.loc[<span class="dv">880</span>:<span class="dv">980</span>, <span class="st">"impressions_x2"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-973"><a href="#cb32-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-974"><a href="#cb32-974" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2 <span class="op">=</span> MMM(</span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>channel_columns,</span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb32-980"><a href="#cb32-980" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb32-981"><a href="#cb32-981" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.build_model(</span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a>    intervened_data[<span class="st">"target_var"</span>]</span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.add_lift_test_measurements(df_lift_test)</span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.model.to_graphviz()</span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a>As we can see a new observational point have been added to our data. This new point must be satisfied as the rest of our data, pooling parameter into a new direction.</span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a>In a Bayesian model, each observation—whether it is a daily data point $y_t$ or a lift measurement $\Delta y$—contributes a term to the likelihood. The posterior arises from the product of all these likelihood terms and the prior(s). In other words, theres no actual difference between priors and data, they both carry the same weight and multiply in the numerator of Bayes theorem. There's no discrete "decision" about which part of the data (or which prior) to weight more; it all goes into the same log‐posterior function. The sampling or optimization algorithm (MCMC, variational inference, etc.) explores the parameter space in proportion to the posterior probability (which is prior × likelihood). Whichever parameters jointly give higher posterior density get visited more often by the sampler.</span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.fit(</span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a>    intervened_data[<span class="st">"target_var"</span>],</span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1004"><a href="#cb32-1004" aria-hidden="true" tabindex="-1"></a>non_causal_mmm2.sample_posterior_predictive(</span>
<span id="cb32-1005"><a href="#cb32-1005" aria-hidden="true" tabindex="-1"></a>    intervened_data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1010"><a href="#cb32-1010" aria-hidden="true" tabindex="-1"></a>Now that our model is ready, we can check the new estimated effect.</span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero_second_model <span class="op">=</span> non_causal_mmm2.idata.posterior_predictive.copy()</span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a>y_do_x2_second_model <span class="op">=</span> non_causal_mmm2.sample_posterior_predictive(</span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a>    data.drop(columns<span class="op">=</span>[<span class="st">"target_var"</span>]), </span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a>    extend_idata<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a>    include_last_observations<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-1021"><a href="#cb32-1021" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1022"><a href="#cb32-1022" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a>x2_causal_effect_second_model <span class="op">=</span> (y_do_x2_zero_second_model.y <span class="op">-</span> y_do_x2_second_model.y).isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">880</span>, <span class="dv">980</span>))</span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the causal effect</span></span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a>mean_effect_second_model <span class="op">=</span> x2_causal_effect_second_model.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>,<span class="st">"draw"</span>])</span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, mean_effect_second_model)</span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1033"><a href="#cb32-1033" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-1034"><a href="#cb32-1034" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative causal effect</span></span>
<span id="cb32-1037"><a href="#cb32-1037" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb32-1038"><a href="#cb32-1038" aria-hidden="true" tabindex="-1"></a><span class="co"># For cumulative effect, compute quantiles directly from cumulative sums</span></span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a>cum_effect_second_model <span class="op">=</span> x2_causal_effect_second_model.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a>cum_mean_second_model <span class="op">=</span> cum_effect_second_model.mean(dim<span class="op">=</span>[<span class="st">"chain"</span>,<span class="st">"draw"</span>])</span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, cum_mean_second_model)</span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Cumulative Causal Effect of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a>As you can see the effect looks fully different. The size is 1000X higher than before. Let's compare!</span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure to compare real effects with estimated effects</span></span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-1059"><a href="#cb32-1059" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1060"><a href="#cb32-1060" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, mean_effect_second_model, label<span class="op">=</span><span class="st">'Estimated Effect (2)'</span>, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a>plt.plot(x2_causal_effect_second_model.coords[<span class="st">"date"</span>].values, cum_mean_second_model, </span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect (2)'</span>, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1082"><a href="#cb32-1082" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-1083"><a href="#cb32-1083" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a>As expected the new observation makes the model add more credit to X2 but this came with the price of an overestimation of the true impact. Meanwhile, it was true that X2 impact was bigger than the original one, the second model absorbe all the variability possibly explain by other variables such as X1, X3 and bring a 1000X more extra impact, with a very tight posterior.</span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1091"><a href="#cb32-1091" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the recovered mean daily contribution as distribution.</span></span>
<span id="cb32-1092"><a href="#cb32-1092" aria-hidden="true" tabindex="-1"></a>channels_contribution_original_scale_model1 <span class="op">=</span> non_causal_mmm.compute_channel_contribution_original_scale()</span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a>channels_contribution_original_scale_model2 <span class="op">=</span> non_causal_mmm2.compute_channel_contribution_original_scale()</span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a>_dist1 <span class="op">=</span> channels_contribution_original_scale_model1.isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">800</span>)).mean(</span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a>    dim<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a>).sel(channel<span class="op">=</span><span class="st">"impressions_x2"</span>).values.flatten()</span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a>_dist2 <span class="op">=</span> channels_contribution_original_scale_model2.isel(date<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>, <span class="dv">800</span>)).mean(</span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a>    dim<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a>).sel(channel<span class="op">=</span><span class="st">"impressions_x2"</span>).values.flatten()</span>
<span id="cb32-1103"><a href="#cb32-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1104"><a href="#cb32-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a><span class="co"># First subplot for Model 1</span></span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(_dist1, shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">"Model 1"</span>, bw_adjust<span class="op">=</span><span class="fl">4.5</span>)</span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Channel X2 Contribution - Model 1"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Contribution Value"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a><span class="co"># Second subplot for Model 2</span></span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(_dist2, shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">"Model 2"</span>, bw_adjust<span class="op">=</span><span class="fl">4.5</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Channel X2 Contribution - Model 2"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Contribution Value"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Danger of Tight Posteriors</span></span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a>It's important to note that a tight posterior distribution (like we see in Model 2) should never be understood as the model being more correct or certain about the true causal effect. This is a common misconception in Bayesian analysis.</span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a>A tight posterior simply means the model is very confident in its estimates given the data and prior assumptions it has, but says nothing about whether those assumptions are correct. In this case, the addition of the lift test measurement has created a model that is very confident in an incorrect answer.</span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1134"><a href="#cb32-1134" aria-hidden="true" tabindex="-1"></a>This illustrates an important principle in causal inference and Bayesian modeling: **precision is not the same as accuracy**. A model can be precisely wrong - having a narrow posterior around an incorrect value. This often happens when:</span>
<span id="cb32-1135"><a href="#cb32-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The model structure doesn't match the true causal process</span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Important confounders are omitted</span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>The priors or likelihood are misspecified</span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a>Why all the following happened? lets take a look to the graph.</span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1146"><a href="#cb32-1146" aria-hidden="true" tabindex="-1"></a>dot</span>
<span id="cb32-1147"><a href="#cb32-1147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a>This DAG shows:</span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Direct Spend-to-Impression Relationships**: Each spend variable (X1-X4) directly influences its corresponding impression variable.</span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Cross-Channel Effects**: </span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Impressions from X1 influence impressions from X3</span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Impressions from X2 influence both X3 and X4 impressions</span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Events influence impressions for X2 and X3</span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a>If we were to build a naive regression model including all variables (X1, X2, X3, X4), we would encounter significant estimation problems, particularly for X2. According to Pearl's causal theory.</span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Collider Bias</span></span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a>In our graph, X2 influences X3 and X4, which both influence the target variable. This creates a collider structure where conditioning on x1 variable because induces a spurious correlation between X2, X3. This violates the independence assumptions of standard regression.</span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Mediator Effects</span></span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a>X2 has both direct effects on the target variable and indirect effects through X3 and X4. A naive regression would conflate these paths, leading to inconsistent estimates of X2's true total causal effect.</span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Confounding from Events</span></span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a>Events influence both X2 impressions and the target variable directly. Without properly accounting for this common cause, the estimate for X2 will capture some of the effect that actually comes from events.</span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a>All the above means, in order to estimate the effect of X2 we need to address the primal causal questions.</span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. Minimal Adjustment Set for X2</span></span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a>To estimate the total causal effect of X2 on the target variable, we need to identify the minimal adjustment set that blocks all non-causal paths while preserving the causal paths. According to Pearl's backdoor criterion, we must control for any confounders (common causes) while avoiding adjusting for colliders or mediators. In our DAG, the minimal adjustment set for estimating X2's total effect would include Events (as it's a confounder affecting both X2 and the target) and Spend X1 (as it influences the target through X3, creating a backdoor path). We should not adjust for impressions_x3 or impressions_x4, as these are mediators through which X2 partially exerts its effect on the target variable. Nevertheless, events are a cofounder of X2, meaning, we need to control for them if we want to get the estimates right on spot.</span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a>The proper identification of this minimal adjustment set is crucial for unbiased estimation. If we control for too few variables, confounding bias remains. If we control for mediators, we block part of the causal effect we're trying to measure. This highlights why structural causal models are superior to naive regression approaches - they allow us to explicitly model the causal pathways and make appropriate adjustments based on causal reasoning rather than statistical correlation. By conditioning only on the minimal adjustment set, we can obtain a consistent estimate of X2's total causal effect, including both its direct impact and indirect effects through other channels.</span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a>So, let's see what happen if we apply causal theory 😃</span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a><span class="co"># Lets rebuild our media mix model</span></span>
<span id="cb32-1186"><a href="#cb32-1186" aria-hidden="true" tabindex="-1"></a>causal_mmm <span class="op">=</span> MMM(</span>
<span id="cb32-1187"><a href="#cb32-1187" aria-hidden="true" tabindex="-1"></a>    date_column<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a>    channel_columns<span class="op">=</span>[<span class="st">"impressions_x2"</span>],</span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a>    control_columns<span class="op">=</span>control_columns,</span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a>    adstock<span class="op">=</span>adstock,</span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a>    saturation<span class="op">=</span>saturation,</span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a>    model_config<span class="op">=</span>model_config,</span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a>    sampler_config<span class="op">=</span>sample_kwargs</span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a>causal_mmm.fit(X_train, y_train,)</span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a>causal_mmm.sample_posterior_predictive(X_train, extend_idata<span class="op">=</span><span class="va">True</span>, combined<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a>Now, lets repeat again the estimation of the effect when X2 is zero.</span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero <span class="op">=</span> X_test.copy()</span>
<span id="cb32-1205"><a href="#cb32-1205" aria-hidden="true" tabindex="-1"></a>X_test_x2_zero[<span class="st">"impressions_x2"</span>].iloc[:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-1206"><a href="#cb32-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a>y_do_x2_zero_causal <span class="op">=</span> causal_mmm.sample_posterior_predictive(</span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a>    X_test_x2_zero, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a>y_do_x2_causal <span class="op">=</span> causal_mmm.sample_posterior_predictive(</span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a>    X_test, extend_idata<span class="op">=</span><span class="va">False</span>, include_last_observations<span class="op">=</span><span class="va">True</span>, random_seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the causal effect as the difference between interventions</span></span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a>x2_causal_effect_causal <span class="op">=</span> (y_do_x2_zero_causal <span class="op">-</span> y_do_x2_causal).y</span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a><span class="co"># Get dates from the coordinates for x-axis</span></span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> x2_causal_effect_causal.coords[<span class="st">'date'</span>].values[:<span class="dv">100</span>]  <span class="co"># Take only first 100 days</span></span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and quantiles</span></span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a>mean_effect <span class="op">=</span> x2_causal_effect_causal.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb32-1221"><a href="#cb32-1221" aria-hidden="true" tabindex="-1"></a>cum_effect <span class="op">=</span> x2_causal_effect_causal.cumsum(dim<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb32-1222"><a href="#cb32-1222" aria-hidden="true" tabindex="-1"></a>cum_mean <span class="op">=</span> cum_effect.mean(dim<span class="op">=</span><span class="st">"sample"</span>)[:<span class="dv">100</span>]</span>
<span id="cb32-1223"><a href="#cb32-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1224"><a href="#cb32-1224" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Compare daily effects</span></span>
<span id="cb32-1225"><a href="#cb32-1225" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb32-1226"><a href="#cb32-1226" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, daily_effect, label<span class="op">=</span><span class="st">'Real Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-1227"><a href="#cb32-1227" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, mean_effect, label<span class="op">=</span><span class="st">'Estimated Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1228"><a href="#cb32-1228" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1229"><a href="#cb32-1229" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1230"><a href="#cb32-1230" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Daily Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1231"><a href="#cb32-1231" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1232"><a href="#cb32-1232" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1233"><a href="#cb32-1233" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1234"><a href="#cb32-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1235"><a href="#cb32-1235" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Compare cumulative effects</span></span>
<span id="cb32-1236"><a href="#cb32-1236" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb32-1237"><a href="#cb32-1237" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cumulative_effect, label<span class="op">=</span><span class="st">'Real Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb32-1238"><a href="#cb32-1238" aria-hidden="true" tabindex="-1"></a>plt.plot(dates, cum_mean, </span>
<span id="cb32-1239"><a href="#cb32-1239" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Estimated Cumulative Effect'</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-1240"><a href="#cb32-1240" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Real vs Estimated Cumulative Causal Effects of Channel X2"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-1241"><a href="#cb32-1241" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1242"><a href="#cb32-1242" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Cumulative Effect"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1243"><a href="#cb32-1243" aria-hidden="true" tabindex="-1"></a>plt.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, which<span class="op">=</span><span class="st">'major'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb32-1244"><a href="#cb32-1244" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb32-1245"><a href="#cb32-1245" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-1246"><a href="#cb32-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1247"><a href="#cb32-1247" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-1248"><a href="#cb32-1248" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-1249"><a href="#cb32-1249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1250"><a href="#cb32-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1251"><a href="#cb32-1251" aria-hidden="true" tabindex="-1"></a>Great, as expected the true causal effect for X2 was recovered, and its possible to prove with an experiment. This just prove that maths are not magic, and that if we want to create models that explain the dynamics of the world, we need to use causal reasoning to it 🔥🙌🏻</span>
<span id="cb32-1252"><a href="#cb32-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1253"><a href="#cb32-1253" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion</span></span>
<span id="cb32-1254"><a href="#cb32-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1255"><a href="#cb32-1255" aria-hidden="true" tabindex="-1"></a>The evidence is clear: calibration cannot rescue a misspecified causal model. We've seen that:</span>
<span id="cb32-1256"><a href="#cb32-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1257"><a href="#cb32-1257" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Causal misspecification persists despite calibration.** Our Model 2 became confidently wrong after calibration—tight posteriors around incorrect values.</span>
<span id="cb32-1258"><a href="#cb32-1258" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Colliders and mediators matter.** Standard MMMs ignore that marketing channels influence each other, creating spurious correlations that no amount of experimental data can fix.</span>
<span id="cb32-1259"><a href="#cb32-1259" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**Adjustment sets are crucial.** Simply including every variable yields biased estimates; we must control only for confounders while preserving causal pathways.</span>
<span id="cb32-1260"><a href="#cb32-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1261"><a href="#cb32-1261" aria-hidden="true" tabindex="-1"></a>When we finally built a causally-aware MMM—controlling for events as confounders but avoiding adjustment for mediators—our estimates matched the ground truth. The same experimental evidence that couldn't rescue our misspecified model perfectly aligned with our correctly specified one.</span>
<span id="cb32-1262"><a href="#cb32-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1263"><a href="#cb32-1263" aria-hidden="true" tabindex="-1"></a>The message: invest in causal discovery before calibration. Draw your DAGs. Identify your minimal adjustment sets. No amount of experimental evidence will save a model asking the wrong causal question.</span>
<span id="cb32-1264"><a href="#cb32-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1265"><a href="#cb32-1265" aria-hidden="true" tabindex="-1"></a>As Pearl might say: statistics tells us *what* the data says; causality tells us *what* to do with it.</span>
<span id="cb32-1266"><a href="#cb32-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1267"><a href="#cb32-1267" aria-hidden="true" tabindex="-1"></a>Calibration without causation is just computation without comprehension!</span>
<span id="cb32-1268"><a href="#cb32-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1271"><a href="#cb32-1271" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-1272"><a href="#cb32-1272" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb32-1273"><a href="#cb32-1273" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">-</span>n <span class="op">-</span>u <span class="op">-</span>v <span class="op">-</span>iv <span class="op">-</span>w <span class="op">-</span>p pymc_marketing,pytensor</span>
<span id="cb32-1274"><a href="#cb32-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Connect with me:
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2023 Carlos Trujillo
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/cetagostini/cetagostini.github.io/edit/main/articles/nomore_experiments_without_causality/nomore_experiments_without_causality.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cetagostini/cetagostini.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cetagostini">
      <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cetagostini">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/cetagostini">
      <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://instagram.com/cetagostini">
      <i class="bi bi-instagram" role="img" aria-label="Instagram">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:carlos.trujillo.agostini@gmail.com">
      <i class="bi bi-envelope" role="img" aria-label="Email">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script src="../../js/cookie-consent.js"></script>




</body></html>